---
title: "Cardiac death mortality on breast cancer patients"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Libraries ---------------------------------------------------------------

{library(dplyr)
library(lubridate)
library(ggplot2)
library(tibble)
library(tidyr)
library(readxl)
library(stringr)
library(openxlsx)

library(survival)
library(survminer)
library(ggsurvfit)
library(gtsummary)
library(tidycmprsk)

library(gt)
library(knitr)
library(kableExtra)
library(RColorBrewer)}
library(patchwork)

```



```{r wrangling, echo=FALSE, message=FALSE, warning=FALSE}

# Data --------------------------------------------------------------------

# Paths
paths <- c("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cancer/Data/cancer_registry_20240924.csv",
           "~/Downloads/Registro Central de Cancer/cancer_registry_20240924.csv",
           paste0("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Registro Central de CÃ¡ncer/cancer_registry_20240924.csv"))

# Loading dataframe

data <- suppressWarnings(tryCatch({
  read.csv(paths[1], fileEncoding = "UTF-8")
}, error = function(e) {
  read.csv(paths[2], fileEncoding = "UTF-8")
}, error = function(e) {
  read.csv(paths[3], fileEncoding = "UTF-8")
}))

# ER Assay, PR Assay & HER2 
# Reference links for encoding in data dictionary document
data <- data %>%
  mutate(ER = ifelse(ERassay  %in% c('1','010'), 'Positive', 
                     ifelse(ERassay %in% c('0','020'),'Negative',
                            ifelse(ERassay %in% c('999',NA,'9'), 'Unknown','Other'
                            ))),
         PR = ifelse(PRassay  %in% c('1','010'), 'Positive', 
                     ifelse(PRassay %in% c('0','020'),'Negative',
                            ifelse(PRassay %in% c('999',NA,'9'), 'Unknown','Other'
                            ))),
         HER2.cat = ifelse(HER2  %in% c('1','010'), 'Positive', 
                     ifelse(HER2 %in% c('0','020'),'Negative',
                            ifelse(HER2 %in% c('999',NA,'9'), 'Unknown','Other'
                            )))
         
  )
data$ER <- factor(data$ER, 
                       levels = c('Positive','Negative',
                                  'Other','Unknown'))
data$PR <- factor(data$PR, 
                       levels = c('Positive','Negative',
                                  'Other','Unknown'))
data$HER2.cat <- factor(data$HER2.cat, 
                       levels = c('Positive','Negative',
                                  'Other','Unknown'))

#Set factor order for Stage at Diagnosis
data$StageAtDx <- relevel(factor(data$StageAtDx), ref = "Localized")

# Health Region Variable
data$HealthRegion <- str_to_title(data$HealthRegion)
data$HealthRegion <- factor(data$HealthRegion,
                            levels = c('Noreste Metro','Central Bayamon','Oeste Aguadilla/Mayaguez',
                                       'Sureste Caguas','Sur Ponce',"Norte Arecibo",
                                       'Este Fajardo','County Unknown'
                                       ))

 data <- data %>%
   mutate(Procedure = case_when(
      Surgery == "Yes" & Chemotherapy == "No" & Radiotherapy == "No" ~ "Surgery Only",
      Chemotherapy == "No" & Radiotherapy == "Yes" ~ "Radiotherapy Only",
      Chemotherapy == "Yes" & Radiotherapy == "No" ~ "Chemotherapy Only",
      Chemotherapy == "Yes" & Radiotherapy == "Yes" ~ "Chemotherapy and Radiotherapy",
      TRUE ~ "Other"
    ))

data$Procedure <-  factor(data$Procedure,
                               levels = c("Surgery Only", "Chemotherapy Only",
                                          "Radiotherapy Only", "Chemotherapy and Radiotherapy",
                                          "Other"))

# Comorbidities
data <- data %>%
  mutate(Comorb.cat = factor(ifelse(Comorb == '0' , 'No', 
                             ifelse(as.numeric(Comorb) >= 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')) ,
         `Myocardial Infarction` = factor(ifelse(C1 == 0 & C0 == 0 , 'No', 
                             ifelse(C1 == 1 | C0 == 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')), 
         `Congestive heart failure` = factor(ifelse(C2 == 0 , 'No', 
                             ifelse(C2 == 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
         `Peripheral vascular disease` = factor(ifelse(C3 == 0 , 'No', 
                             ifelse(C3 == 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
         `Cerebrovascular disease` = factor(ifelse(C4 == 0 , 'No', 
                             ifelse(C4 == 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
         `Chronic pulmonary disease` = factor(ifelse(C6 == 0 , 'No', 
                             ifelse(C6 == 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
         `Diabetes without chronic complication` = factor(ifelse(C10 == 0 , 'No', 
                             ifelse(C10 == 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
         `Diabetes with chronic complication` = factor(ifelse(C11 == 0 , 'No', 
                             ifelse(C11 >= 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
  )

# To determine and classify how many comorbidities 
data$Csum <- apply(data[, c('Myocardial Infarction','Congestive heart failure', 
               'Peripheral vascular disease',
               'Cerebrovascular disease',
               'Chronic pulmonary disease',
               'Diabetes without chronic complication',
               'Diabetes with chronic complication')],1, function(x)sum(grepl("Yes",x)))

data$CsumCat <- factor(with(data, ifelse(Csum == 0, 'No comorbidity',
                       ifelse(Csum >= 1 & Csum <=2, '1-2 comorbidities',
                       ifelse(Csum >= 3, '3 or more comorbidites', '')))),
                       levels = c('3 or more comorbidites','1-2 comorbidities','No comorbidity')
)



# CVD vs Non CVD death
data$Vital <- ifelse(data$VitalStatus == 0 & data$CVDDeathCause == 'CVD death','CVD death', 
                     ifelse(data$VitalStatus == 0 & data$BCDeathCause == 'BC death', 'BC death', 
                            ifelse(data$VitalStatus == 0, 'Other Death', 'Alive'
                            )))

# time: Delta year of diagnosis and year follow up (year of death if vital status == 0) 
# Vital Status: 1 = Alive, 0 = dead

# Recode status to 1 event (CVD death) and 0 censored
data$status <- ifelse(data$VitalStatus == 0 & data$CVDDeathCause == 'CVD death',1, 0)
data$status <- as.factor(data$status)

# Recode status to 1 event (CVD death) and 0 censored
data$statusBC <- ifelse(data$VitalStatus == 0 & data$BCDeathCause == 'BC death',1, 0)
data$statusBC <- as.factor(data$statusBC)

# Recode status to 1 event (All cause death) and 0 censored (for all cause mortality)
data$status1 <- ifelse(data$VitalStatus == 0 ,1, 0)

# Recode status to 1 (CVD death), 2 (Other death), 0 (Alive)
data <- data %>%
  mutate(
    status2 =  ifelse(data$VitalStatus == 0 & data$CVDDeathCause == 'CVD death',1, 
           ifelse(data$VitalStatus == 0, 2, 0
                  )),
    status2 = as.factor(status2),
    status2.cat = ifelse(status2 == 1, 'CVD Death',
                         ifelse(status2 == 2, 'Other Death', 'Alive'))
    )

# Recode status to 1 (CVD death), 2 (BC death), 3 (Other Death), 0 (Alive)
data <- data %>%
  mutate(
    statusV = ifelse(data$Vital == 'CVD death' ,1,
                     ifelse(data$Vital == 'BC death' ,2, 
           ifelse(data$Vital == 'Other Death', 3, 0
                  ))),
    statusV = as.factor(statusV),
    )

# time to follow up 
data <- data %>%
  mutate(mm_dx = as.numeric(ifelse(is.na(mm_dx), 6, mm_dx)),
         mm_dlc = as.numeric(ifelse(is.na(mm_dlc), 6, mm_dlc)),
         DiagnosisDate = make_date(year = ydiag, month = mm_dx, day = 2),
         FollowUpStart = DiagnosisDate %m+% years(1),
         FollowUpEnd = if_else(yy_dlc > 2021, as.Date("2021-12-31"), make_date(year = yy_dlc, month = mm_dlc, day = 2)),
         FollowUpYears = if_else(FollowUpEnd < FollowUpStart, 0, 
                        as.numeric(difftime(FollowUpEnd, FollowUpStart, units = "days")) / 365.25),
         time = FollowUpYears,
         AgeFU = AgeDx + time,
         maritallabel = factor(str_to_title(maritallabel), levels = c("Married", "Unmarried", "Unknown")),
         AgeDx = ifelse(AgeDx == 999, NA, AgeDx),
         AgeDxCat = as.factor(case_when(AgeDx >= 18 & AgeDx <= 39 ~ "18-39",
                                            AgeDx >= 40 & AgeDx <= 49 ~ "40-49",
                                        AgeDx >= 50 & AgeDx <= 59 ~ "50-59",
                                        AgeDx >= 60 & AgeDx <= 69 ~ "60-69",
                                            AgeDx >= 70 & AgeDx <= 79 ~ "70-79",
                                            AgeDx >= 80 ~ "80+",
                                            TRUE ~ NA)))
data$yearDiagCat <- cut(data$ydiag, 
                   breaks = c(2003, 2009, 2014, 2019), 
                   labels = c("2004-2009", "2010-2014", "2015-2019"),
                   right = TRUE)

data <- data %>%
  filter(time > 0) # Person met follow-up criteria


```

### **I. Research Objective:** 

Assess mortality on breast cancer survivors caused by cardiovascular disease (CVD) in women older than 17 years of age residing in Puerto Rico that are diagnosed with breast cancer (by microscopic confirmation) during the period of 2004-2019. 

#### <ins> A. Datasets (available at the moment):</ins> 

Cancer Registry Data: The initial selection is all women residents in PR diagnosed with breast cancer (by microscopic confirmation) during the period 2005-2019. 

NCHS Mortality Data for years 2004-2019.

Census Population Estimates for years 2000-2023 for women residents in PR by age groups.

#### <ins> B. Analysis Proposal: </ins>

Below is the overall proposed analysis strategy to meet the study objectives: 

1. Descriptive characteristics of the study population 

2. Estimate Standardized Mortality Ratios (SMRâs) with confidence intervals (Poisson-based CIâs) on the study population. Proposed SMR definition: observed number of CVD deaths among breast cancer patients divided by the expected number of CVD deaths in the matched general female population in PR.  

3. Estimate Survival Curves, estimate Cumulative Incidence of Death (Cumulative Mortality) considering the effects of competing risks (Cardiac-related death vs Other/Breast Cancer-related death) using Competing Risks Regression (HRs).

### **II. Descriptive Analysis**

#### <ins> A. Summary Counts </ins>

*Table 1: Baseline Characteristics of Study Population* 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Descriptive Analysis ----------------------------------------------------

fisher_sim_p <- function(data, variable, by, ...) {
  result <- list()
  result$p <- stats::fisher.test(x = data %>% pull({{variable}}), y = data %>% pull({{by}}), simulate.p.value = T)$p.value
  result$test <- "Fisher's test with simulated p-value"
  result
}

gt_table1 <- data %>%
  select(c(Vital, AgeDx, AgeDxCat, AgeFU, time, HealthRegion, maritallabel, Procedure, StageAtDx, ER, PR, HER2.cat, CsumCat, `Myocardial Infarction`, `Congestive heart failure`, `Peripheral vascular disease`, `Cerebrovascular disease`, `Chronic pulmonary disease`, `Diabetes without chronic complication`, `Diabetes with chronic complication`)) %>%
  filter(Vital != "Alive", !is.na(AgeDxCat)) %>% 
 tbl_summary(by = Vital,
              label = c(AgeDx ~ "Age at Diagnosis (Continuous)",
                        AgeDxCat ~ "Age at Diagnosis (Categorical)",
                        AgeFU ~ "Age at Death",
                        time ~ "Time to death (years)",
                        HealthRegion ~ "Health Region",
                        maritallabel ~ "Marital Status",
                        Procedure ~ "Treatment",
                        StageAtDx ~ "Stage at Diagnosis",
                        AgeDxCat ~ "Age at Diagnosis (Categorical)",
                        ER ~ "ER Assay",
                        PR ~ "PR Assay",
                        HER2.cat ~ "HER2", 
                        CsumCat ~ "Comorbidities"),
             type = all_continuous() ~ "continuous2",
             statistic = list(all_continuous() ~ c(
      "{mean}(Â±{sd})",
      "{median} ({p25}-{p75})",
      "{min}-{max}"),
    all_categorical() ~ "{n} ({p}%)")) %>%
  add_overall(col_label = "**All death causes**  \nN = {style_number(N)}") %>%
add_p(
    test = list(
      all_continuous() ~ "oneway.test", # Welch's ANOVA due to no assumption of homogeneity of variances
      c(CsumCat, `Diabetes with chronic complication`, Procedure, HER2.cat,  HealthRegion, `Myocardial Infarction`) ~ "fisher_sim_p", # Simulated p-values
      all_categorical() ~ "chisq.test"  # Default chi-square for most variables
      
    )) %>%
  modify_footnote(everything() ~ NA) %>%
  modify_caption("**Table 1: Baseline Characteristics of Study Population**") %>%
  as_gt(); gt_table1

```

```{r v2_with_less_variables}

library(gtsummary)
library(gt)
library(dplyr)
library(stringr)

gt_table1 <- data %>%
  select(c(Vital, AgeDxCat, StageAtDx, Procedure, HealthRegion, maritallabel)) %>%
  filter(Vital != "Alive", !is.na(AgeDxCat)) %>% 
  tbl_summary(
    by = Vital,
    label = c(AgeDxCat ~ "Age at Diagnosis",
              HealthRegion ~ "Health Region",
              maritallabel ~ "Marital Status",
              Procedure ~ "Treatment",
              StageAtDx ~ "Stage at Diagnosis"),
    type = all_continuous() ~ "continuous2",
    statistic = list(
      all_continuous() ~ c(
        "{mean}(Â±{sd})",
        "{median} ({p25}-{p75})",
        "{min}-{max}"
      ),
      all_categorical() ~ "{n} ({p}%)"
    )
  ) %>%
  add_overall(col_label = "**Total**  \nN = {style_number(N)}") %>%
  modify_table_body(
    ~ .x %>%
      dplyr::mutate(stat_0 = ifelse(variable %in% c("AgeDxCat", "StageAtDx", "Procedure", "HealthRegion", "maritallabel"), 
                                    stringr::str_remove(stat_0, " \\(.*\\)"), stat_0))
  ) %>%
  add_p(
    test = list(
      all_continuous() ~ "oneway.test", # Welch's ANOVA due to no assumption of homogeneity of variances
      c(Procedure, HealthRegion) ~ "fisher_sim_p", # Simulated p-values
      all_categorical() ~ "chisq.test"  # Default chi-square for most variables
    )
  ) %>%
  modify_footnote(everything() ~ NA) %>%
  modify_caption("**Table 1: Baseline Characteristics of Study Population**") %>%
  as_gt() %>%
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "lightgrey",
      weight = px(2)
    ),
    locations = cells_body(columns = stat_0)
  ) %>%
  tab_style(
    style = cell_borders(
      sides = "right",
      color = "lightgrey",
      weight = px(2)
    ),
    locations = cells_column_labels(columns = stat_0)
  ); gt_table1

```

```{r v3_cvd_bc_vs_gen}

# BC pop
gt_table2 <- data %>%
  filter(Vital == "CVD death", !is.na(AgeDxCat)) %>% 
  mutate(
  AgeDeath = ifelse(VitalStatus == 0,
                           AgeDx + (yy_dlc - ydiag), NA),
          AgeDeathCat = as.factor(case_when(AgeDeath >= 18 & AgeDeath <= 39 ~ "18-39",
                                            AgeDeath >= 40 & AgeDeath <= 49 ~ "40-49",
                                            AgeDeath >= 50 & AgeDeath <= 59 ~ "50-59",
                                            AgeDeath >= 60 & AgeDeath <= 69 ~ "60-69",
                                            AgeDeath >= 70 & AgeDeath <= 79 ~ "70-79",
                                            AgeDeath >= 80 ~ "80+",
                                            TRUE ~ NA)),
  AgeDeathCat = factor(AgeDeathCat, levels = c("18-39", "40-49", "50-59", "60-69", "70-79", "80+")),
                  maritallabel = factor(maritallabel, levels = c("Married", "Unmarried", "Unknown"))) %>%
  select(c(AgeDeathCat, maritallabel)) %>%
  tbl_summary(
    label = c(AgeDeathCat ~ "Age at Death",
              maritallabel ~ "Marital Status"),
    type = all_continuous() ~ "continuous2",
    statistic = list(
      all_continuous() ~ c("{mean}(Â±{sd})", "{median} ({p25}-{p75})", "{min}-{max}"),
      all_categorical() ~ "{n} ({p}%)")) %>%
  modify_header(label = "**Characteristic**") %>%
  modify_footnote(everything() ~ NA)

# Gen pop dataset
gen_table2 <- suppressWarnings(tryCatch({
  read.csv("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Defunciones/gen_table2.csv")
}, error = function(e) {
  read.csv("~/Downloads/NCHS/gen_table2.csv")
}))

gt_table_genpop <- gen_table2 %>%
  select(-X) %>%
  mutate(AgeDeathCat2 = factor(AgeDeathCat2, levels = c("18-39", "40-49", "50-59", "60-69", "70-79", "80+")),
         marital_status = factor(marital_status, levels = c("Married", "Unmarried", "Unknown"))) %>%
  rename(AgeDeathCat = AgeDeathCat2, maritallabel = marital_status) %>%
  tbl_summary(
    label = c(AgeDeathCat ~ "Age at Death",
              maritallabel ~ "Marital Status"),
    type = all_continuous() ~ "continuous2",
    statistic = list(
      all_continuous() ~ c("{mean}(Â±{sd})", "{median} ({p25}-{p75})", "{min}-{max}"),
      all_categorical() ~ "{n} ({p}%)")) %>%
  modify_header(label = "** Population**") %>%
  modify_footnote(everything() ~ NA)

# Merge the tables side by side
gt_table2 <- tbl_merge(
  tbls = list(gt_table2, gt_table_genpop),
  tab_spanner = c("**Breast Cancer Cohort**", "**General Population**")) %>% 
  as_gt(); gt_table2


```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# *Table 2: Summary statistics by mortality type*

  # 
# data %>%
#   filter(Vital != "Alive", AgeDx != 999) %>% 
#   select(c(Vital, AgeDx, AgeFU, time)) %>%
#  tbl_summary(by = Vital,
#               label = c(AgeDx ~ "Age at Diagnosis",
#                        AgeFU ~ "Age at Death",
#                        time ~ "Time to death (years)"),
#              type = all_continuous() ~ "continuous2",
#              statistic = list(all_continuous() ~ c(
#       "{mean}(Â±{sd})",
#       "{median} ({p25}-{p75})",
#       "{min}-{max}"),
#     all_categorical() ~ "{n} ({p}%)"))  %>%
#   modify_column_hide(columns = "stat_3") %>%
#     add_overall(col_label = "**All death causes**  \nN = {style_number(N)}") %>%
#    modify_footnote(everything() ~ NA) %>%
#   modify_caption("**Table 2: Summary statistics by mortality type**")


```



#### <ins> B. Exploratory Data Analysis </ins>  

*Figure 1: Age distribution of study population*

```{r echo=FALSE, message=FALSE, warning=FALSE}

data %>%
  filter(AgeDx != 999)%>%
  ggplot(aes(x = AgeDx))+
  geom_histogram()+
  labs(x = 'Age at diagnosis', y = 'Frequency',
       title = 'Age distribution')+
  theme_bw()
```

*Figure 2: Age distribution of study population*

```{r echo=FALSE, message=FALSE, warning=FALSE}
data %>%
  ggplot(aes(x = AgeDxCat))+
  geom_bar()+
  facet_wrap(~Vital, scales = 'free_y')+
  labs(x = 'Age at diagnosis', y = 'Frequency')+
  theme_bw()
```
  
  
*Figure 3: Bar plots for procedures (surgery,chemotherapy,radiotherapy)  *

```{r echo=FALSE, message=FALSE, warning=FALSE}

par(mfrow=c(1,3))
barplot(sort(xtabs(~Surgery, data = data), decreasing = TRUE),  main = 'Surgery')
barplot(sort(xtabs(~Chemotherapy, data = data), decreasing = TRUE), main = 'Chemotherapy')
barplot(sort(xtabs(~Radiotherapy, data = data), decreasing = TRUE), main = 'Radiotherapy')

``` 

*Figure 4: Bar plots for procedures (surgery,chemotherapy,radiotherapy)  *

```{r echo=FALSE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE, paged.print=FALSE}
# plotting a barplot with percentages 

data %>%  
  group_by(Vital, Procedure) %>%
  summarize(Frequency = n())%>% 
  mutate(Percent = prop.table(Frequency)) %>% 
  ungroup() %>% 
  ggplot(aes(x = reorder(Procedure,-Percent), y = Percent, label = scales::percent(Percent))) +  
  geom_bar(stat = 'identity',color = 'black') +  
  geom_text(vjust = -0.5,    # nudge above top of bar
            size = 3) +  
  facet_wrap(~Vital)+
  theme_bw()+
  labs(x = '')+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_y_continuous(labels = scales::percent)

```

*Figure 5: Bar plots for procedures (surgery,chemotherapy,radiotherapy)  *

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=FALSE}
data %>%  
  group_by(Vital, Procedure) %>%
  summarize(Frequency = n())%>% 
  mutate(Percent = round(prop.table(Frequency),3)) %>% 
  ungroup() %>% 
  ggplot(aes(x = reorder(Procedure,-Percent), y = Percent, fill = Vital)) + 
  #ggplot(aes(x = Procedure, y = Percent, fill = Vital)) +  
  geom_bar(stat = 'identity',color = 'black', position = 'dodge') +  
  labs(x = '')+
  #facet_wrap(~Procedure, scales = "free_x")+
  scale_fill_grey(start=0, end=1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank())+
  scale_y_continuous(labels = scales::percent)

```

  
*Figure 6: Bar plot for Comorbidity Index  *

```{r echo=FALSE, message=FALSE, warning=FALSE}
barplot(xtabs(~data$Comorb))
```

  
*Figure 7: Bar plots for ER, PR & HER2  *

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}

par(mfrow=c(1,3))
barplot(xtabs(~ER, data = data), main = 'ER Assay')
barplot(xtabs(~PR, data = data), main = 'PR Assay')
barplot(xtabs(~HER2.cat, data = data), main = 'HER2')

```

*Figure 8: Bar plots for ER by Vital Status *


```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=FALSE}

## ER
data %>%  
  group_by(Vital, ER) %>%
  summarize(Frequency = n())%>% 
  mutate(Percent = round(prop.table(Frequency),3)) %>% 
  ungroup() %>% 
  ggplot(aes(x = reorder(ER,-Percent), y = Percent, fill = Vital)) + 
  #ggplot(aes(x = ER, y = Percent, fill = Vital)) +  
  geom_bar(stat = 'identity',color = 'black', position = 'dodge') +  
  labs(x = '', title = "ER")+
  scale_fill_grey(start=0, end=1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank())+
  scale_y_continuous(labels = scales::percent)
```

*Figure 9: Bar plots for PR by Vital Status *

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=FALSE}

## PR
data %>%  
  group_by(Vital, PR) %>%
  summarize(Frequency = n())%>% 
  mutate(Percent = round(prop.table(Frequency),3)) %>% 
  ungroup() %>% 
  ggplot(aes(x = reorder(PR,-Percent), y = Percent, fill = Vital)) + 
  #ggplot(aes(x = ER, y = Percent, fill = Vital)) +  
  geom_bar(stat = 'identity',color = 'black', position = 'dodge') +  
  labs(x = '', title = "PR")+
  scale_fill_grey(start=0, end=1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank())+
  scale_y_continuous(labels = scales::percent)

```

*Figure 10: Bar plots for HER2 by Vital Status *

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=FALSE}

## HER2
data %>%  
  group_by(Vital, HER2.cat) %>%
  summarize(Frequency = n())%>% 
  mutate(Percent = round(prop.table(Frequency),3)) %>% 
  ungroup() %>% 
  ggplot(aes(x = reorder(HER2.cat,-Percent), y = Percent, fill = Vital)) + 
  #ggplot(aes(x = ER, y = Percent, fill = Vital)) +  
  geom_bar(stat = 'identity',color = 'black', position = 'dodge') +  
  labs(x = '', title = 'HER2')+
  scale_fill_grey(start=0, end=1)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank())+
  scale_y_continuous(labels = scales::percent)
```

### **III. Survival Curves**

*Figure 11: Overall Mortality Survival Curve* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Fit the Kaplan-Meier survival model

km_fit_gen <- survfit(coxph(Surv(time, status1) ~ 1 + AgeDxCat, data = data))

km_plot <- ggsurvplot(
  km_fit_gen, 
  data = data,
  risk.table = TRUE,       # Add number at risk table
 # pval = TRUE,             # Show p-value of log-rank test (although not relevant here)
  conf.int = TRUE,         # Show confidence intervals
  xlab = "Years",          # X-axis label
  ylab = "Probability of Survival", # Y-axis label
  ggtheme = theme_minimal() # Theme
)

km_plot$plot <- km_plot$plot +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  ) +
  labs(title = "Overall Survival Curve")

# Print the plot
print(km_plot)

```

*Table 3: Overall Mortality Survival Confidence Intervals Table*

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

summary_km <- summary(km_fit_gen, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' )) %>%
  select(time, value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)') %>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`)


kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. All-cause mortality estimated by Kaplan-Meier methods",
           general_title = "", 
           footnote_as_chunk = TRUE)

```

*Figure 12: Overall and Specific Mortality Survival Curves*

```{r overall_specific, echo = FALSE}
# Overall survival curve
km_fit_gen <- survfit(coxph(Surv(time, status1) ~ 1 + AgeDxCat, data = data))

# Specific survival curve
km_fit_spec <- survfit(coxph(Surv(time, status1) ~ 1 + strata(Vital) + AgeDxCat, 
                             data = data %>% filter(!(Vital %in% c("Alive", "Other Death")))))

# Extract data from survfit objects
km_data_gen <- tidy(km_fit_gen)
km_data_spec <- tidy(km_fit_spec)

# Overlay the two survival curves, but include strata for the specific model
ggplot() +
  # General survival curve
  geom_step(data = km_data_gen, aes(x = time, y = estimate, color = "Overall"), size = 1) + 
  geom_ribbon(data = km_data_gen, aes(x = time, ymin = conf.low, ymax = conf.high), alpha = 0.2, fill = "grey") +  # Confidence interval for general survival
  
   # BC survival curve
   geom_step(data = km_data_spec %>% filter(strata == "BC death"), aes(x = time, y = estimate, color = "BC death"), size = 1) +
   geom_ribbon(data = km_data_spec %>% filter(strata == "BC death"), aes(x = time, ymin = conf.low, ymax = conf.high), alpha = 0.2, fill = "pink") +  # Confidence interval for BC Death
   
   # CVD survival curve 
   geom_step(data = km_data_spec %>% filter(strata == "CVD death"), aes(x = time, y = estimate, color = "CVD death"), size = 1) +
   geom_ribbon(data = km_data_spec %>% filter(strata == "CVD death"), aes(x = time, ymin = conf.low, ymax = conf.high), alpha = 0.2, fill = "red") +  # Confidence interval for CVD Death
    
  labs(title = "",
       x = "Years", 
       y = "Probability of Survival",
       color = "Death Cause") +
  scale_color_manual(values = c("Overall" = "grey", "BC death" = "pink", "CVD death" = "red")) +  # Set colors for lines
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.position = "top"
  )
```

*Figure 13: CVD Specific Mortality Survival Curve* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Fit the Kaplan-Meier survival model

allCVD <- data %>%
  filter(Vital == "CVD death")

km_fit <- survfit(coxph(Surv(time, status1) ~ 1 + AgeDxCat, data = allCVD))

km_plot <- ggsurvplot(
  km_fit, 
  data = allCVD,
  risk.table = TRUE,       # Add number at risk table
 # pval = TRUE,            
  conf.int = TRUE,       
  xlab = "Years",          
  ylab = "Probability of Survival", 
 conf.int.fill = "red",
 ggtheme = theme_minimal() 
)

km_plot$plot <- km_plot$plot +
  theme(plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  ) +
  labs(title = "CVD Specific Survival Curve")

# Print the plot
print(km_plot)


```

*Table 4: CVD Specific Mortality Survival Confidence Intervals Table*

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

summary_km <- summary(km_fit, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' )) %>%
  select(time, value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)')%>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`)

kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. All-cause mortality estimated by Kaplan-Meier methods",
           general_title = "", 
           footnote_as_chunk = TRUE)

```


*Table 4b: CVD Specific Mortality Survival Confidence Intervals Table by Age*

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

plots <- allCVD %>%
  filter(!is.na(AgeDxCat), AgeDxCat != "18-39") %>%
  split(.$AgeDxCat) %>%
  purrr::keep(~ sum(!is.na(.x$time) & !is.na(.x$status1) & .x$status1 == 1) > 0) %>%
  lapply(function(subdata) {
    fit <- survfit(Surv(time, status1) ~ 1, data = subdata)
    ggsurv <- ggsurvplot(
      fit,
      data = subdata,
      conf.int = TRUE,
      risk.table = FALSE,
      conf.int.fill = "red",
      legend = "none",
      ggtheme = theme_minimal(),
      xlab = "Years",
      ylab = "Probability of Survival",
      xlim = c(0, 15),
      ylim = c(0, 1)
    )

    ggsurv$plot +
      ggtitle(unique(subdata$AgeDxCat)) +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 12)
      )
  })

f_cvd_by_age <- wrap_plots(plots, ncol = 3)

ggsave("/Users/genesisrodriguez/Downloads/Statistical Analysis/Outputs/Figures/cvd_mortality_curve_age.tif", plot = f_cvd_by_age, width = 12, height = 6.5, dpi = 300,  bg = "white")

```

*Figure 14: CVD Specific Mortality Survival Curve by Treatment* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Fit the Kaplan-Meier survival model

# km_fit2 <- survfit(Surv(time, status1)~Procedure, data = data %>% 
#                           filter(!Procedure %in% c("Unknown", "No treatment")))

km_fit2 <- survfit(coxph(Surv(time, status1) ~ strata(Procedure) + AgeDxCat, 
                         data = allCVD %>% filter(!Procedure %in% c("Unknown", "No treatment"))))

filtered_levels <- levels(droplevels(allCVD$Procedure[!allCVD$Procedure %in% c("Unknown", "No treatment")]))

km_plot2 <- ggsurvplot(
    km_fit2, 
    data = allCVD %>% filter(!Procedure %in% c("Unknown", "No treatment")),  # Filtered data
    risk.table = FALSE,       # Add number at risk table
    #conf.int = TRUE,        # Show confidence intervals
    xlab = "Years",           # X-axis label
    ylab = "Probability of Survival",  # Y-axis label
    legend.title = "Procedure",        # Legend title
    legend.labs = filtered_levels,     # Use filtered levels for legend labels
    palette = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#C695DD", "#E25869"), # Custom color palette
    ggtheme = theme_minimal(),
    lwd = 0.5)

km_plot2$plot <- km_plot2$plot +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  ) +
  labs(title = "Survival Curve by Treatment") +
  guides(color = guide_legend(ncol = 3)) 

# Print the plot
print(km_plot2)

```

*Table 5: CVD Specific Mortality Survival Confidence Intervals Table by Treatment* 

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary_km <- summary(km_fit2, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  strata = summary_km$strata,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' ),
        strata = gsub('Procedure=','',strata)) %>%
  select(time, strata,value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)')%>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`,
         Treatment = strata)


kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. CVD specific mortality estimated by Kaplan-Meier methods. Treatment Chemotherapy + Radiotherapy did not meet table survival time thresholds.",
           general_title = "", 
           footnote_as_chunk = TRUE)

rm(allC);rm(allCT);rm(km_fit);rm(km_fit2);rm(km_plot);rm(km_plot2)
```

*Figure 15: CVD Specific Mortality Survival Curve by Surgery Treatment* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Fit the Kaplan-Meier survival model
surgery_data <- allCVD %>%
  filter(grepl("Surgery", Procedure))
surgery_data$Procedure <- factor(surgery_data$Procedure)

km_fit2 <- survfit(coxph(Surv(time, status1) ~ strata(Procedure) + AgeDxCat, 
                         data = surgery_data))
# km_fit2 <- survfit(Surv(time, status1)~Procedure, data = surgery_data)

km_plot2 <- ggsurvplot(
  km_fit2, 
  data = surgery_data,
  risk.table = FALSE,       # Add number at risk table
  #pval = TRUE, 
  pval.size = 3,
 # conf.int = TRUE,         # Show confidence intervals
  xlab = "Years",          # X-axis label
  ylab = "Probability of Survival", # Y-axis label
   legend.title = "Procedure",  # Legend title
    legend.labs = levels(surgery_data$Procedure),
  palette = c("#E69F00", "#56B4E9", "#009E73",  "#0072B2"), # Custom color palette
  ggtheme = theme_minimal(),
  lwd = 0.5
  ) 

km_plot2$plot <- km_plot2$plot +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  ) +
  labs(title = "Survival Curve by Surgery Treatment") +
  guides(color = guide_legend(ncol = 3)) 

# Print the plot
print(km_plot2)

```

*Table 6: CVD Specific Mortality Survival Confidence Intervals Table by Surgery Treatment* 

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary_km <- summary(km_fit2, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  #strata = summary_km$strata,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' )) %>%
  #      strata = gsub('Procedure=','',strata)) %>%
  select(time,value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)')%>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`)
         #`15-year (95% CI)` = `15`
         #Treatment = strata)

kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. All-cause mortality estimated by Kaplan-Meier methods",
           general_title = "", 
           footnote_as_chunk = TRUE)

rm(allC);rm(allCT);rm(km_fit);rm(km_fit2);rm(km_plot);rm(km_plot2)
```


*Figure 16: CVD Specific Mortality Survival Curve by Marital Status* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Fit the Kaplan-Meier survival model
km_fit2 <- survfit(coxph(Surv(time, status1) ~ strata(maritallabel) + AgeDxCat, 
                         data = allCVD %>% 
                          filter(!maritallabel %in% c("Unknown"))))
# km_fit2 <- survfit(Surv(time, status1)~maritallabel, data = data %>% 
#                           filter(!maritallabel %in% c("Unknown")))

filtered_levels <- levels(droplevels(allCVD$maritallabel[!allCVD$maritallabel %in% c("Unknown")]))

km_plot2 <- ggsurvplot(
    km_fit2, 
    data = allCVD %>% filter(!maritallabel %in% c("Unknown")),  # Filtered data
    risk.table = FALSE,       # Add number at risk table
    # pval = TRUE,              # Show p-value of log-rank test
    # conf.int = TRUE,        # Show confidence intervals
    xlab = "Years",           # X-axis label
    ylab = "Probability of Survival",  # Y-axis label
    legend.title = "Marital Status",        # Legend title
    legend.labs = filtered_levels,     # Use filtered levels for legend labels
    palette = c("#009E73", "#F0E442"), # Custom color palette
    ggtheme = theme_minimal())

km_plot2$plot <- km_plot2$plot +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  ) +
  labs(title = "Survival Curve by Marital Status") +
  guides(color = guide_legend(ncol = 2)) 

# Print the plot
print(km_plot2)

```

*Table 7: CVD Specific Mortality Survival Confidence Intervals Table by Marital Status* 

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary_km <- summary(km_fit2, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  strata = summary_km$strata,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' ),
        strata = gsub('Procedure=','',strata)) %>%
  select(time, strata,value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)')%>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`,
         `Marital Status` = strata)
  
kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. All-cause mortality estimated by Kaplan-Meier methods",
           general_title = "", 
           footnote_as_chunk = TRUE)

rm(allC);rm(allCT);rm(km_fit);rm(km_fit2);rm(km_plot);rm(km_plot2)
```

*Figure 17: CVD Specific Mortality Survival Curve by Year of Diagnosis* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Fit the Kaplan-Meier survival model

#km_fit2 <- survfit(Surv(time, status1)~yearDiagCat, data = data)
km_fit2 <- survfit(coxph(Surv(time, status1) ~ strata(yearDiagCat) + AgeDxCat, 
                         data = allCVD))

km_plot2 <- ggsurvplot(
    km_fit2, 
    data = allCVD,  # Filtered data
    risk.table = FALSE,       # Add number at risk table
    #pval = TRUE,              # Show p-value of log-rank test
    # conf.int = TRUE,        # Show confidence intervals
    xlab = "Years",           # X-axis label
    ylab = "Probability of Survival",  # Y-axis label
    legend.title = "Year of Diagnosis",        # Legend title
    legend_labels = levels(data$yearDiagCat),
#    palette = c("#009E73", "#F0E442"), # Custom color palette
    ggtheme = theme_minimal())

km_plot2$plot <- km_plot2$plot +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  ) +
  labs(title = "Survival Curve by Year of Diagnosis") +
  guides(color = guide_legend(ncol = 2)) 

# Print the plot
print(km_plot2)

```

*Table 8: CVD Specific Mortality Survival Confidence Intervals Table by Year of Diagnosis* 

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary_km <- summary(km_fit2, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  strata = summary_km$strata,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' ),
        strata = gsub('Procedure=','',strata)) %>%
  select(time, strata,value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)')%>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`,
         `Year of Diagnosis` = strata)
  
kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. All-cause mortality estimated by Kaplan-Meier methods",
           general_title = "", 
           footnote_as_chunk = TRUE)

rm(allC);rm(allCT);rm(km_fit);rm(km_fit2);rm(km_plot);rm(km_plot2)
```

*Figure 18: CVD Specific Mortality Survival Curve by Comorbidity* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
data.Comorb <- allCVD %>%
  filter(ydiag >= 2010)
km_fit2 <- survfit(coxph(Surv(time, status1) ~ strata(Comorb.cat) + AgeDxCat, 
                         data = data.Comorb %>% filter(!Comorb.cat %in% c("Unknown"))))

filtered_levels <- levels(droplevels(data.Comorb$Comorb.cat[!data.Comorb$Comorb.cat %in% c("Unknown")]))

km_plot2 <- ggsurvplot(
    km_fit2, 
    data = data.Comorb %>% filter(!Procedure %in% c("Unknown")),  # Filtered data
    risk.table = FALSE,       # Add number at risk table
    #conf.int = TRUE,        # Show confidence intervals
    xlab = "Years",           # X-axis label
    ylab = "Probability of Survival",  # Y-axis label
    legend.title = "Comorbidity",        # Legend title
    legend.labs = filtered_levels,     # Use filtered levels for legend labels
    palette = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#C695DD", "#E25869"), # Custom color palette
    ggtheme = theme_minimal(),
    lwd = 0.5)

km_plot2$plot <- km_plot2$plot +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 8)
  ) +
  labs(title = "Survival Curve by Comorbidity") +
  guides(color = guide_legend(ncol = 2)) 

# Print the plot
print(km_plot2)

```

*Table 9: CVD Specific Mortality Survival Confidence Intervals Table by Comorbidity* 

```{r echo=FALSE, message=FALSE, warning=FALSE}

summary_km <- summary(km_fit2, times = c(3, 5, 10, 15)) 
allCT <- data.frame(
  time = summary_km$time,
  strata = summary_km$strata,
  surv_prob = summary_km$surv,
  lower_ci = summary_km$lower,
  upper_ci = summary_km$upper
)

allCT <- allCT %>%
  mutate(value = paste0(100 * round(surv_prob,4), '(',100*round(lower_ci,4), '-',100*round(upper_ci,4), ')' ),
        strata = gsub('Procedure=','',strata)) %>%
  select(time, strata,value) %>%
  pivot_wider(values_from = value, names_from = time, values_fill = '0 (0-0)')%>%
  rename(`3-year (95% CI)` = `3`,
         `5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         Comorbidity = strata)
  
kable(allCT,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. Crude number and rate estimates of mortality from the study data. All-cause mortality estimated by Kaplan-Meier methods",
           general_title = "", 
           footnote_as_chunk = TRUE)

rm(allC);rm(allCT);rm(km_fit);rm(km_fit2);rm(km_plot);rm(km_plot2)
```

### **IV. Competing Risks**

If the goal is to assess cardiac death mortality, both death related to breast cancer 
and other causes are competing events.   

*Figure 19: Cumulative incidence functions (1 = Cardiac death ; 2 = Other cause death)* 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Calculating CIF ----------------------------------------------

# Estimate the cumulative incidence in the context of competing risks using the 
# cuminc function from the {tidycmprsk} package. By default this requires the
# status to be a factor variable with censored patients coded as 0.

#cuminc(Surv(time, status2) ~ 1, data = data)

# We can use the ggcuminc() function from the {ggsurvfit} package to plot the 
# cumulative incidence. By default it plots the first event type only. 
# So the following plot shows the cumulative incidence of death from cvd:

# include both event outcomes
options("ggsurvfit.switch-color-linetype" = TRUE)
tidycmprsk::cuminc(Surv(time, status2) ~ 1, data) %>%
  ggcuminc(outcome = c("1", "2"))+
  scale_ggsurvfit() +
  ylim(c(0,1))+
  xlim(c(0,20))+
  labs(x = "Survival Time (Years)") +
  add_confidence_interval(show.legend = FALSE) +
  scale_fill_manual(
  values = c("1" = "red", "2" = "black"))+  # Show legend for lines
  scale_color_manual(values = c("red", "black"),
  labels = c("1" = "Cardiac Death", "2"  = "Other Causes of Death"))

  
```

```{r testing_new_code}
# Another way 2024-10-09
library(cmprsk)
 
# Using cuminc from cmprsk package
cuminc_fit <- cuminc(ftime = data$time, fstatus = data$status2, group = data$AgeDxCat)

ggcompetingrisks(cuminc_fit, conf.int = TRUE, multiple_panels = TRUE) +
 scale_fill_manual(
    name = "Cause of Death",                 
    values = c("1" = "red", "2" = "black"),   
    labels = c("1" = "Cardiac Death", "2" = "Other Causes of Death") ) +
  scale_color_manual(
    name = "Cause of Death",                  
    values = c("1" = "red", "2" = "black"),   
    labels = c("1" = "Cardiac Death", "2" = "Other Causes of Death")) 

# Another way 2024-10-09
library(cmprsk)
 
# Using cuminc from cmprsk package
cuminc_fit <- cuminc(ftime = data$time, fstatus = data$status2, group = data$AgeDxCat)

f_cr_cif <- ggcompetingrisks(cuminc_fit, conf.int = TRUE, multiple_panels = TRUE) +
 scale_fill_manual(
    name = "Cause of Death",                 
    values = c("1" = "red", "2" = "black"),   
    labels = c("1" = "Cardiac Death", "2" = "Other Causes of Death") ) +
  scale_color_manual(
    name = "Cause of Death",                  
    values = c("1" = "red", "2" = "black"),   
    labels = c("1" = "Cardiac Death", "2" = "Other Causes of Death")); f_cr_cif

ggsave("/Users/genesisrodriguez/Downloads/Statistical Analysis/Outputs/Figures/cr_cif_age.tif", plot = f_cr_cif, width = 12, height = 6.5, dpi = 300,  bg = "white")

```
  
  
*Table 7: Cumulative Incidence of Death (CVD Death vs Other)*

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

way2 <- tidy(tidycmprsk::cuminc(Surv(time, status2) ~ 1, data)) %>%
  filter(
    (time >= 4.6 & time < 5.5) |
      (time >= 9.6 & time < 10.5) |
      (time >= 14.6 & time < 15.5)
  ) %>%
  group_by(time = round(time), outcome) %>%  
  slice(1) %>%
  filter(time %in% c(5,10,15)) %>%
  mutate(value= paste0(100 * round(estimate,4), '(',100*round(conf.low,4), '-',100*round(conf.high,4), ')' ),
         outcome = ifelse(outcome == '1','CVD Death',
                          ifelse(outcome == '2', 'Other Causes of Death','')))%>%
  select(time, outcome, value)%>%
  pivot_wider(values_from = value, names_from = time)%>%
  rename(`5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`,
         ` ` = outcome)
  
kable(way2,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. CVD and BC mortality are estimated by Fine and Grayâs competing risk method.",
           general_title = "Note: ", 
           footnote_as_chunk = TRUE)

```
  
  
*Figure 20: Cumulative incidence functions (1 = Cardiac death ; 2 = Breast Cancer death, 3 = Other Cause death)* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Calculating CIF ----------------------------------------------


# include both event outcomes

tidycmprsk::cuminc(Surv(time, statusV)~1, data) %>% 
  ggcuminc(outcome = c("1", "2","3"))+
  ylim(c(0, .5)) +
  xlim(c(0,20))+
  labs(x = "Survival Time (Years)") +
  add_confidence_interval(show.legend = FALSE) +
  scale_fill_manual(
  values = c("1" = "red", "2" = "pink", "3" = "black"))+  # Show legend for lines
  scale_color_manual(values = c("red", "pink", "black"),
  labels = c("Cardiac death", "Breast cancer death", "Other causes of death"))


```

  
  
*Table 8: Cumulative Incidence of Death (including BC mortality)*
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

way3 <- tidy(tidycmprsk::cuminc(Surv(time, statusV)~1, data)) %>%
   filter(
    (time >= 4.6 & time < 5.5) |
      (time >= 9.6 & time < 10.5) |
      (time >= 14.6 & time < 15.5)
  ) %>%
  group_by(time = round(time), outcome) %>%  
  slice(1) %>%
  filter(time %in% c(5,10,15)) %>%
  mutate(value= paste0(100 * round(estimate,4), '(',100*round(conf.low,4), '-',100*round(conf.high,4), ')' ),
         outcome = ifelse(outcome == '1','CVD Death',
                          ifelse(outcome == '2', 'BC Death', 'Other Causes of Death')))%>%
  select(time, outcome, value)%>%
  pivot_wider(values_from = value, names_from = time)%>%
  rename(`5-year (95% CI)` = `5`,
         `10-year (95% CI)` = `10`,
         `15-year (95% CI)` = `15`,
         ` ` = outcome)
  
kable(way3,  format = "html", escape = FALSE, align = "c")%>%
  kable_styling( full_width = FALSE) %>%
  footnote(general = "Values are n (%), unless otherwise indicated. CVD, BC mortality and Other Cause mortality are estimated by Fine and Grayâs competing risk method.",
           general_title = "Note: ", 
           footnote_as_chunk = TRUE)

```

#### **IV. Cumulative Incidence Curves for CVD Mortality **

*Figure 21: CIF for CVD Mortality by Treatment* 


```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}
options("ggsurvfit.switch-color-linetype" = FALSE)

# CIF for CVD by Treatment 
tidycmprsk::cuminc(Surv(time, status2) ~ Procedure, data) %>% 
  ggcuminc(outcome = c("1"), size = 1, aes(color = Procedure)) + 
 # geom_step(aes(color = Procedure)) + 
 # ylim(c(0, .1)) + 
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for CVD by Treatment'
  ) + 
  xlim(c(0, 20)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(n = 9, name = "Set1"))  # Use Set1 color palette


```

*Figure 18: CIF for CVD Mortality by Diagnosis* 
```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}

# CIF for CVD by Age Category 

tidycmprsk::cuminc(Surv(time, status2) ~ AgeDxCat, data) %>% 
  ggcuminc(outcome = c( "1"), aes(color = AgeDxCat), size = 1)+
 #add_confidence_interval() +
 #add_risktable() +
  ylim(c(0, .1)) + 
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for CVD by Age at Diagnosis'
  ) + 
  xlim(c(0,20)) +  scale_linetype_manual(values=c( 1:9))


```

*Figure 22: CIF for CVD Mortality by Comorbidity* 

```{r echo=FALSE,fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}

# CIF for CVD by Comorbidity 

tidycmprsk::cuminc(Surv(time, statusV) ~ Comorb.cat , data) %>% 
  ggcuminc(outcome = c("1"),
            aes(color = Comorb.cat), size = 1)+
 #add_confidence_interval() +
 #add_risktable() +
  ylim(c(0, .5)) + 
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for Cardiovascular Disease by Comorbidity'
  ) + 
  xlim(c(0,20)) + scale_linetype_manual(values=c(rep("solid",3)))


```

*Figure 23: CIF for BC Mortality by Comorbidity* 

```{r echo=FALSE,fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}

# CIF for BC by Comorbidity 

tidycmprsk::cuminc(Surv(time, statusV) ~ Comorb.cat , data) %>% 
  ggcuminc(outcome = c("2"),
           aes(color = Comorb.cat), size = 1)+
    ylim(c(0, .5)) + 
 #add_confidence_interval() +
 #add_risktable() +
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for Breast Cancer by Comorbidity'
  ) + 
  xlim(c(0,20)) + scale_linetype_manual(values=c(rep("dashed",3)))

```

*Figure 24: Cumulative incidence curves for CVD and BC Mortality by Comorbidity* 

```{r echo=FALSE,fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}
options("ggsurvfit.switch-color-linetype" = TRUE)

# CIF for CVD by Comorbidity 

tidycmprsk::cuminc(Surv(time, statusV) ~ Comorb.cat , data) %>% 
  ggcuminc(outcome = c("1", "2"),
           aes(color = Comorb.cat), size = 1)+
 #add_confidence_interval() +
 #add_risktable() +
  ylim(c(0, .5)) + 
  labs(
    x = "Survival Time (Years)",
      title = 'CIF for Cardiovascular Disease and Breast Cancer by Comorbidity'
  ) + 
  xlim(c(0,20)) +
  scale_color_manual(
    values = c("1" = "red", "2" = "pink")
,  # Set colors for each outcome
    labels = c("1" = "CVD", "2" = "BC")) +
  scale_linetype_manual(
    values = c("Yes" = "solid", "Unknown" = "dotted", "No" = "longdash")  # Optional: Customize line types
  )

```

*Figure 25: Cumulative incidence curves for CVD Mortality by Stage at Diagnosis* 

```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}
options("ggsurvfit.switch-color-linetype" = FALSE)

# CIF for CVD by cancer Stage at Diagnosis 

tidycmprsk::cuminc(Surv(time, statusV) ~ StageAtDx , data) %>% 
  ggcuminc(outcome = c( "1"),
           aes(color = StageAtDx), size = 1)+
 #add_confidence_interval() +
 #add_risktable() +
    ylim(c(0, .8)) + 
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for CVD by Stage at Diagnosis'
  ) + 
  xlim(c(0,20)) +  scale_linetype_manual(values=c(rep("solid",4)))

```

*Figure 26: Cumulative incidence curves for BC Mortality by Stage at Diagnosis* 

```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}

# CIF for BC by cancer Stage at Diagnosis 

tidycmprsk::cuminc(Surv(time, statusV) ~ StageAtDx , data) %>% 
  ggcuminc(outcome = c( "2"),
          aes(color = StageAtDx), size = 1)+
 #add_confidence_interval() +
 #add_risktable() +
  ylim(c(0, .8)) + 
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for Breast Cancer by Stage at Diagnosis'
  ) + 
  xlim(c(0,20)) +  scale_linetype_manual(values=c(rep("dashed",4)))

```

*Figure 27: Cumulative incidence curves for CVD and BC Mortality by Stage at Diagnosis* 

```{r echo=FALSE, fig.height=8, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}
options("ggsurvfit.switch-color-linetype" = FALSE)

# CIF for CVD and BC by cancer Stage at Diagnosis 
tidycmprsk::cuminc(Surv(time, statusV) ~ StageAtDx, data) %>% 
  ggcuminc(outcome = c("1", "2"), #linetype_aes = TRUE,
            size = 1) +  # Use linetype for outcomes
  ylim(c(0, .8)) +
  labs(
    x = "Survival Time (Years)",
    title = 'CIF for Cardiovascular Disease and Breast Cancer by Stage at Diagnosis'
  ) + 
  xlim(c(0, 20)) 

```

#### <ins>A. Competing Risks Regression </ins> 

##### 1. Subdistribution of Hazards 


*Table 9: Hazard ratios (95% CI) from Subdistribution Hazard Model for Cardiac Death* 
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Competing Risks Regression ----------------------------------------------

time <- data$time
status2 <- data$status2
StageAtDx <- data$StageAtDx
Comorb_cat <- data$Comorb.cat
Procedure <- data$Procedure

model <- crr(ftime = time, fstatus = status2, cov1 = cbind(StageAtDx, Comorb_cat, Procedure))

model %>%
   tbl_regression(exp = TRUE)


```



#### Forest Plot of Hazard Ratios

*Figure 28: Subdistribution HR (95% CI) by Stage at Diagnosis* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Extract the results
model_summary <- summary(model)
tidy_model <- tidy(model)

# Create a data frame of the results
hr_results <- data.frame(
  group = tidy_model$term ,
  HR = exp(tidy_model$estimate ),
  lower_CI = exp(tidy_model$estimate - 1.96 * tidy_model$std.error),
  upper_CI = exp(tidy_model$estimate + 1.96 * tidy_model$std.error)
)

## Forest Plot for Stage at Diagnosis
# Filter the results for the group variable
hr_stage <- hr_results %>% filter(grepl("StageAtDx", group))

# Rename the group variable for better readability
hr_stage$group <- gsub("StageAtDx", "", hr_stage$group)


# Create a forest plot
ggplot(hr_stage, aes(x = HR, y = group)) +
  geom_point() +
  geom_errorbarh(aes(xmin = lower_CI, xmax = upper_CI), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(title = "Subdistribution HR (95% CI) by Stage at Diagnosis", x = "Hazard Ratio", y = "") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold")
  )

```

*Figure 29: Subdistribution HR (95% CI) by Treatment* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

## Forest Plot for Procedure

# Filter the results for the group variable
hr_trt <- hr_results %>% filter(grepl("Procedure", group))

# Rename the group variable for better readability
hr_trt$group <- gsub("Procedure", "", hr_trt$group)


# Create a forest plot
ggplot(hr_trt, aes(x = HR, y = group)) +
  geom_point() +
  geom_errorbarh(aes(xmin = lower_CI, xmax = upper_CI), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(title = "Subdistribution HR (95% CI) by Treatment", x = "Hazard Ratio", y = "") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold")
  )

```

*Figure 30: Subdistribution HR (95% CI) by Comorbidity* 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

## Forest Plot for Comorbidity

# Filter the results for the group variable
hr_cmb <- hr_results %>% filter(grepl("Comorb.cat", group))

# Rename the group variable for better readability
hr_cmb$group <- gsub("Comorb.cat", "", hr_cmb$group)


# Create a forest plot
ggplot(hr_cmb, aes(x = HR, y = group)) +
  geom_point() +
  geom_errorbarh(aes(xmin = lower_CI, xmax = upper_CI), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(title = "Subdistribution HR (95% CI) by Comorbidity", x = "Hazard Ratio", y = "") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title.x = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold")
  )


```
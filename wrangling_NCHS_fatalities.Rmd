---
title: "NCHS"
author: "Genesis Rodriguez"
date: "2024-06-20"
output: html_document
---

```{r, include=FALSE}
rm(list = ls())

# Loading packages
library(readxl)
library(dplyr)

# Loading dataframe
paths <- c("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Defunciones/NCHS/Procesadas/Listas/2020.xlsx",
           "~/Downloads/NCHS/2020.xlsx")

# Attempt to read the file
mort <- tryCatch({
  read_excel(paths[1])
}, error = function(e) {
  read_excel(paths[2])
})

mort <- mort %>%
  select(`Record Type`,
         `Detail Age Unit`,
         `Detail Age`, # Age at death
         `Sex`,
         `ICD Code (10th Revision)`, # Underlying cause of death
         `1st Condition`,
         `2nd Condition`,
         `3rd Condition`,
         `Marital Status`,
         `Current Data Year` # Year of death
         ) %>%
  mutate(across(c(`ICD Code (10th Revision)`, `1st Condition`, `2nd Condition`, `3rd Condition`), ~ sub("^(.{3})(.)", "\\1.\\2", .))) %>%
  # Insert a period after the third character for any 4-character string in `1st Condition`
  select(-c(`Record Type`,
         `Detail Age Unit`,))

# Data wrangling

## Variable that could be useful: diagnosis in any level
### Also variable that checks if ICD 10 and 1st Condition are the same
mort <- mort %>%
  mutate(bcAny = ifelse(grepl("^C(50[0-9])", `1st Condition`)|
           grepl("^C(50[0-9])", `2nd Condition`)|
           grepl("^C(50[0-9])", `3rd Condition`), TRUE, FALSE),
         sameLead = `ICD Code (10th Revision)` == mort$`1st Condition`)

# Underlying causes of death present
sort(unique(mort$`ICD Code (10th Revision)`))

# Most common causes of death
head(sort(table(mort$`ICD Code (10th Revision)`), decreasing = TRUE), 5)

# Alzheimer test ----------
# Filtering using ICD 10 variable
test <- mort %>%
  filter(grepl("^G(30[0-9])", `ICD Code (10th Revision)`))
#Codes included check
table(test$`ICD Code (10th Revision)`)
reportN <- 2627 #NVSR number of deaths
nrow(test) - reportN # Difference in N between report and my analysis
nrow(test)/reportN*100

# Filtering using 1st condition
test2 <- mort %>%
  filter(grepl("^G(30[0-9])", `1st Condition`))
nrow(test2) - reportN # Difference in N between report and my analysis
nrow(test2)/reportN*100

# CVD test -----------
# Filtering
test <- mort %>%
  filter(grepl("^I(00|0[1-9]|11|13|2[0-9]|3[0-9]|4[0-9]|50|51)", `ICD Code (10th Revision)`))
#Codes included check
table(test$`ICD Code (10th Revision)`)
reportN <- 5565 #NVSR number of deaths
nrow(test) - reportN # Difference in N between report and my analysis
nrow(test)/reportN*100

test2 <- mort %>%
   filter(grepl("^I(00|0[1-9]|11|13|2[0-9]|3[0-9]|4[0-9]|50|51)", `1st Condition`))
table(test2$`1st Condition`)
nrow(test2) - reportN # Difference in N between report and my analysis
nrow(test2)/reportN*100

# SMR Calculation Data

# CVD excluding breast cancer related deaths
cvd <- mort %>%
  filter(`Record Type` == 1, # Resident of P.R.
         `Detail Age Unit` == 1, # Age in years
         `Detail Age` >= 18, # 18 years +
         `Sex` == "F", # Female
          grepl("^I(00|0[1-9]|1[1-3]|2[0-9]|3[0-9]|4[0-9]|50|51|60|6[1-9]|7[0-8])", `1st Condition`),
         !grepl("^C(50[0-9])", `2nd Condition`)|
         !grepl("^C(50[0-9])", `3rd Condition`)) # Excluding BC fatalities

table(cvd$`1st Condition`) # Confirming which ICD 10 codes show up

# CVD excluding all cancer related deaths
cvd <- mort %>%
  filter(`Record Type` == 1, # Resident of P.R.
         `Detail Age Unit` == 1, # Age in years
         `Detail Age` >= 18, # 18 years +
         `Sex` == "F", # Female
          grepl("^I(0[0-9]|1[1,3]|2[0-9]|3[0-9]|4[0-9]|50|51|6[0-9]|7[0-8])\\b", `1st Condition`),
         !grepl("^C(50[0-9])", `2nd Condition`)|
         !grepl("^C(50[0-9])", `3rd Condition`)) # Excluding BC fatalities

# Testing
cvdtest <- mort %>%
  filter(`Record Type` == 1, # Resident of P.R.
         `Detail Age Unit` == 1, # Age in years
         `Detail Age` >= 18, # 18 years +
         `Sex` == "F", # Female
          !grepl("^I(0[0-9]|1[1,3]|2[0-9]|3[0-9]|4[0-9]|50|51|6[0-9]|7[0-8])\\b", `1st Condition`),
         grepl("^I", `1st Condition`))

table(cvd$`1st Condition`) # Confirming which ICD 10 codes show up

# Breast cancer related deaths
bc <-   mort %>%
  filter(`Record Type` == 1, # Resident of P.R.
         `Detail Age Unit` == 1, # Age in years
         `Detail Age` >= 18, # 18 years +
         `Sex` == "F", # Female
         grepl("^C(50[0-9])", `1st Condition`)|
           grepl("^C(50[0-9])", `2nd Condition`)|
           grepl("^C(50[0-9])", `3rd Condition`)) # BC fatalities, 3 first causes


table(bc$`1st Condition`) # Confirming which ICD 10 codes show up

# Neoplasms: C00-D49




```
---
title: "NCHS"
author: "Genesis Rodriguez"
date: "2024-06-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

This data is necessary so we can get the CVD death rates for non BC survivors
in the standard population

```{r libraries, include = FALSE}
# Loading packages
library(readxl)
library(gtsummary)
library(dplyr)

```

```{r data_wrangling, include = FALSE, cache = TRUE}

year <- "2006" 
  
# Loading dataframe
paths <- c(paste0("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Defunciones/NCHS/Procesadas/Listas/", year, ".xlsx"),
           paste0("~/Downloads/NCHS/", year, ".xlsx"),
           paste0("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/NCHS/", year, ".xlsx"))

# Attempt to read the file
mort <- tryCatch({
  read_excel(paths[1])
}, error = function(e) {
  read_excel(paths[2])
}, error = function(e) {
  read_excel(paths[3])
})

mort <- mort %>%
  rename_all(~ snakecase::to_any_case(., case = "snake")) %>% 
  select(record_type,
         detail_age_unit, 
         detail_age, # Age at death
         sex,
         icd_code_10_th_revision, # Underlying cause of death
         `1_st_condition`,
         `2_nd_condition`,
         `3_rd_condition`,
         marital_status,
         current_data_year # Year of death
         ) %>% 
  mutate(across(c(icd_code_10_th_revision, `1_st_condition`, `2_nd_condition`, `3_rd_condition`), ~ sub("^(.{3})(.)", "\\1.\\2", .))) %>% # Insert a period after the third character for any 4-character string in `1_st_condition`
  mutate(bcAny = ifelse(grepl("^C(50)", `icd_code_10_th_revision`)|
           grepl("^C(50)", `2_nd_condition`)|
           grepl("^C(50)", `3_rd_condition`), TRUE, FALSE)) # Diagnosis in any level
       
         
```

```{r CVD_deaths_women, echo = FALSE}

# CVD deaths excluding breast cancer related deaths
cvd_deaths_no_BC <- mort %>%
  filter(record_type == 1, # Resident of P.R.
         detail_age_unit == 1, # Age in years
         detail_age >= 18 &
           detail_age != 999, # 18 years +
         sex == "F", # Female
         grepl("^I(0|1[1,3]|2|3|4|5[0,1]|6|7[0-8])", `icd_code_10_th_revision`), # CVD fatalities
         !grepl("^C50", `2_nd_condition`)|
           !grepl("^C50", `3_rd_condition`)) %>% # Excluding BC fatalities 
  mutate(AgeDeathCat = as.factor(case_when(detail_age >= 18 & detail_age <= 59 ~ "18-59",
                                           detail_age >= 60 ~ "60+",
                                           TRUE ~ NA)),
         AgeDeathCat2 = as.factor(case_when(detail_age >= 18 & detail_age <= 59 ~ "18-59",
                                            detail_age >= 60 & detail_age <= 69 ~ "60-69",
                                            detail_age >= 70 & detail_age <= 79 ~ "70-79",
                                            detail_age >= 80 ~ "80+",
                                            TRUE ~ NA))) %>%
  select(detail_age, icd_code_10_th_revision, current_data_year, AgeDeathCat, AgeDeathCat2)

```

```{r}
cvm_by_year_agegroup1 <- read.csv("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cáncer/Data/cvm_by_year_agegroup1.csv") %>%
  mutate(Year = as.numeric(Year))
cvm_by_year_agegroup2 <- read.csv("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cáncer/Data/cvm_by_year_agegroup2.csv") %>%
  mutate(Year = as.numeric(Year))

```

```{r summary_tables}

# Version 1
grouped_cvd_deaths_gen <- cvd_deaths_no_BC %>% group_by(current_data_year, AgeDeathCat) %>% count(); grouped_cvd_deaths_gen
clean_n_cvd_deaths_gen <- left_join(grouped_cvd_deaths_gen, cvm_by_year_agegroup1[, c("Year", "AgeGroup", "cvd_deaths_BC")], 
          join_by("current_data_year" == "Year",
                  "AgeDeathCat" == "AgeGroup")) %>%
  mutate(NewN = (n - cvd_deaths_BC),
         current_data_year = as.character(current_data_year)) %>%
  select(-c(n, cvd_deaths_BC)) %>%
  rename(n = NewN)
clean_n_cvd_deaths_gen

clean_n_cvd_deaths_gen2 <- cvd_deaths_no_BC %>% group_by(current_data_year, AgeDeathCat2) %>% count(); clean_n_cvd_deaths_gen2
clean_n_cvd_deaths_gen2 <- left_join(clean_n_cvd_deaths_gen2, cvm_by_year_agegroup2[, c("Year", "AgeGroup2", "cvd_deaths_BC")], 
          join_by("current_data_year" == "Year",
                  "AgeDeathCat2" == "AgeGroup2")) %>%
  mutate(NewN = (n - cvd_deaths_BC),
         current_data_year = as.character(current_data_year)) %>%
  select(-c(n, cvd_deaths_BC)) %>%
  rename(n = NewN)
clean_n_cvd_deaths_gen2

# Version 2
cvd_deaths_no_BC %>%
 tbl_summary(include = AgeDeathCat, by = current_data_year,
             statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ))  %>%
  modify_caption("**Table 1: Cardiovascular disease related deaths in women who resided in Puerto Rico by age group**") %>%
  modify_footnote(
    everything() ~ "Deaths were classified according to the underlying cause of death on the death certificate."
  )

cvd_deaths_no_BC %>%
 tbl_summary(include = AgeDeathCat2, by = current_data_year,
             statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    )) %>%
  modify_caption("**Table 1: Cardiovascular disease related deaths in women who resided in Puerto Rico by age group**") %>%
  modify_footnote(
    everything() ~ "Deaths were classified according to the underlying cause of death on the death certificate."
  )

```

```{r census}
census <- read.csv("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Datos censales/Intercensal_female_age_grp_est_2000-2023.csv") %>%
  mutate(Age_Groups = case_when(
    Age_Group %in% c(".18 to 24 years", ".25 to 44 years", ".45 to 49 years", ".50 to 54 years", ".55 to 59 years") ~ "18-59",
    Age_Group %in% c(".60 to 64 years", ".65 to 69 years", ".70 to 74 years", 
                     ".75 to 79 years", "70-79", ".80 to 84 years", ".85 years and over") ~ "60+"
  ),
  Age_Groups2 = case_when(
    Age_Group %in% c(".18 to 24 years", ".25 to 44 years", ".45 to 49 years", ".50 to 54 years", ".55 to 59 years") ~ "18-59",
    Age_Group %in% c(".60 to 64 years", ".65 to 69 years") ~ "60-69",
    Age_Group %in% c(".70 to 74 years", ".75 to 79 years") ~ "70-79",
    Age_Group %in% c(".80 to 84 years", ".85 years and over") ~ "80+"
  )) %>%
  relocate(Age_Groups, Age_Groups2) %>%
  mutate_at(4:27, ~ gsub(",", "", .)) %>%
  mutate_at(4:27, as.numeric) 

census1 <- census %>%
  filter(!is.na(Age_Groups)) %>%
  select(-c(Age_Group, Age_Groups2)) %>%
  group_by(Age_Groups) %>%
  summarise(across(everything(), sum, na.rm = TRUE)) %>%
  pivot_longer(
    cols = -Age_Groups,   # Pivot all columns except 'age_group'
    names_to = "Year",   # The new column for the year names
    values_to = "Population"  # The new column for the values
  ) %>%
  mutate(Year = gsub("X", "", Year)) %>% 
  relocate(Year) %>%
  arrange(Year, Age_Groups)


census2 <- census %>%
  filter(!is.na(Age_Groups2)) %>%
  select(-c(Age_Group, Age_Groups)) %>%
  group_by(Age_Groups2) %>%
  summarise(across(everything(), sum, na.rm = TRUE)) %>%
  pivot_longer(
    cols = -Age_Groups2,   # Pivot all columns except 'age_group'
    names_to = "Year",   # The new column for the year names
    values_to = "Population"  # The new column for the values
  ) %>%
  mutate(Year = gsub("X", "", Year)) %>% 
  relocate(Year) %>%
  arrange(Year, Age_Groups2)

```

```{r rates}

left_join(clean_n_cvd_deaths_gen, census1, by = c("current_data_year" = "Year",
                                                "AgeDeathCat" = "Age_Groups")) %>%
  mutate(CVD_rate = n/Population*1000)

left_join(clean_n_cvd_deaths_gen2, census2, by = c("current_data_year" = "Year",
                                                "AgeDeathCat2" = "Age_Groups2")) %>%
  mutate(CVD_rate = n/Population*1000)

```

```{r cvd_deaths_no_cancer}

# # CVD deaths excluding all cancer related deaths
# cvd_deaths_no_cancer <- mort %>%
#   filter(record_type == 1, # Resident of P.R.
#          detail_age_unit == 1, # Age in years
#          detail_age >= 18, # 18 years +
#          sex == "F", # Female
#           grepl("^I(0|1[1,3]|2|3|4|5[0,1]|6|7[0-8])", `icd_code_10_th_revision`),
#          !grepl("^C|^D(1|2|3|4)", `2_nd_condition`)|
#          !grepl("^C|^D(1|2|3|4)", `3_rd_condition`)) %>% # Excluding cancer fatalities. Neoplasms: C00-D49
#   select(-c(record_type,
#          detail_age_unit,))
# 
# 
# # Breast cancer related deaths
# bc <-   mort %>%
#   filter(record_type == 1, # Resident of P.R.
#          detail_age_unit == 1, # Age in years
#          detail_age >= 18, # 18 years +
#          sex == "F", # Female
#          grepl("^C50", `icd_code_10_th_revision`)|
#            grepl("^C50", `2_nd_condition`)|
#            grepl("^C50", `3_rd_condition`)) # BC fatalities, 3 first causes
# 


```

```{r stats}

mean(cvd_deaths_no_BC$detail_age)
median(cvd_deaths_no_BC$detail_age)

hist(cvd_deaths_no_BC$detail_age, breaks = 115)
```

```{r quality_control, include = FALSE}
# # Alzheimer test ----------
# # Filtering using ICD 10 variable
# test <- mort %>%
#   filter(grepl("^G(30)", icd_code_10_th_revision))
# #Codes included check
# table(test$icd_code_10_th_revision)
# reportN <- 2627 #NVSR number of deaths
# nrow(test) - reportN # Difference in N between report and my analysis
# nrow(test)/reportN*100
# 
# # Filtering using 1st condition
# test2 <- mort %>%
#   filter(grepl("^G(30)", `icd_code_10_th_revision`))
# #Codes included check
# table(test$icd_code_10_th_revision)
# nrow(test2) - reportN # Difference in N between report and my analysis
# nrow(test2)/reportN*100
# 
# # CVD test -----------
# # Filtering
# test <- mort %>%
#  # filter(grepl("^I(00|0[1-9]|11|13|2[0-9]|3[0-9]|4[0-9]|50|51)", icd_code_10_th_revision))
#   filter(grepl("^I(0|11|13|2|3|4|50|51)", icd_code_10_th_revision))
# 
# #Codes included check
# table(test$icd_code_10_th_revision)
# reportN <- 5565 #NVSR number of deaths
# nrow(test) - reportN # Difference in N between report and my analysis
# nrow(test)/reportN*100
# 
# test2 <- mort %>%
#    filter(grepl("^I(0|11|13|2|3|4|50|51)",, `icd_code_10_th_revision`))
# table(test2$`icd_code_10_th_revision`)
# nrow(test2) - reportN # Difference in N between report and my analysis
# nrow(test2)/reportN*100
```

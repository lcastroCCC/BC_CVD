---
title: "Registro Central de Cáncer"
author: "Liliana Castro Jiménez"
date: "2024-09-10"
output: html_document
editor_options: 
  chunk_output_type: console
---

This data is necessary so we can get the CVD death rates for BC survivors
in the standard population

```{r libraries, include = FALSE}
# Loading packages
library(readxl)
library(gtsummary)
library(tidyverse)
```



```{r data_wrangling,  cache = TRUE}
# Paths
paths <- c("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cáncer/Data/datosCarola_invasive_seq0&1_NoID.xlsx",
           "~/Downloads/Registro Central de Cáncer/datosCarola_invasive_seq0&1_NoID.xlsx",
           paste0("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Registro Central de Cáncer/datosCarola_invasive_seq0&1_NoID.xlsx"))

# Attempt to read the file
cancer <- suppressWarnings(tryCatch({
  read_excel(paths[1])
}, error = function(e) {
  read_excel(paths[2])
}, error = function(e) {
  read_excel(paths[3])
}))

cancer <- cancer %>% 
  select(EncryptedID, ydiag, yy_dlc, AgeDx, VitalStatus, 
         BCDeathCause, CVDDeathCause) %>% 
  mutate(AgeDx = as.numeric(cancer$AgeDx),
         AgeDxCat = as.factor(case_when(AgeDx >= 18 & AgeDx <= 79 ~ "18-79",
                            AgeDx >= 80 ~ "80+",
                            TRUE ~ "Unknown")),
         AgeDeath = ifelse(VitalStatus == 0,
         AgeDx + (yy_dlc - ydiag), NA),
         AgeDeathCat = as.factor(case_when(AgeDeath >= 18 & AgeDeath <= 79 ~ "18-79",
                            AgeDeath >= 80 ~ "80+",
                            TRUE ~ NA)),
         AgeDeathCat2 = as.factor(case_when(AgeDeath >= 18 & AgeDeath <= 49 ~ "18-49",
                            AgeDeath >= 50 ~ "50+",
                            TRUE ~ NA)),
         AgeDeathCat3 = as.factor(case_when(AgeDeath >= 18 & AgeDeath <= 64 ~ "18-64",
                            AgeDeath >= 65 & AgeDeath <= 84 ~ "65-84",
                            AgeDeath >= 85 ~ "85+",
                            TRUE ~ NA)),
         Vital = as.factor(ifelse(VitalStatus == 0 & CVDDeathCause == 'CVD death','CVD death', 
                        ifelse(VitalStatus == 0 & BCDeathCause == 'BC death', 'BC death', 
                               ifelse(VitalStatus == 0, 'Other Death', 'Alive'
                               ))))) %>% 
  select(EncryptedID, ydiag, AgeDx, AgeDxCat, yy_dlc, AgeDeath, AgeDeathCat, AgeDeathCat2, AgeDeathCat3, Vital)

# Crear datos BC survivors ------------------------------------------------------------
## Crear la tabla inicial agrupada por año y categoría de edad
# BC_alive <- cancer %>%
#   filter(Vital == "Alive") %>% 
#   group_by(ydiag, AgeDeathCat) %>% 
#   summarize(BC_alive = n()) 

## Sumar los casos de todas las categorías de edad por año
# BC_alive_overall <- BC_alive %>%
#   group_by(ydiag) %>%
#   summarize(BC_alive = sum(BC_alive)) %>%
#   mutate(AgeDeathCat = "Overall") 

## Combinar las tablas original y la de totales
# BC_alive_final <- bind_rows(BC_alive, BC_alive_overall) %>%
#   arrange(ydiag, AgeDeathCat)
# 
# rm(BC_alive, BC_alive_overall)

# Crear datos CVD deaths in BC patients -----------------------------------------------

# Grupos de edad 18-79 y 80+
cvd_deaths_BC_final <- cancer %>%
  filter(Vital == "CVD death") %>%
  group_by(yy_dlc, AgeDeathCat) %>% # Agrupados por año de muerte y grupo de edad
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>% # Counts
  complete(yy_dlc, AgeDeathCat, fill = list(cvd_deaths_BC = 0)) %>% # Incluir 0s
  bind_rows(
    group_by(., yy_dlc) %>% # Obtener counts por año overall
      summarize(cvd_deaths_BC = sum(cvd_deaths_BC), .groups = "drop") %>%
      mutate(AgeDeathCat = "Overall")
  ) %>%
  arrange(yy_dlc, AgeDeathCat) %>%
  pivot_wider(names_from = AgeDeathCat, values_from = cvd_deaths_BC) %>%# Tabla wide por grupo de edad
rename(YearDeath = yy_dlc) %>% 
  mutate(YearDeath = as.factor(YearDeath)) %>%
  bind_rows(
    summarise(., YearDeath = "All years", across(where(is.numeric), sum, na.rm = TRUE))
  )
  
View(cvd_deaths_BC_final)


# Grupos de edad 18-49 y 50+
cvd_deaths_BC_final2 <- cancer %>%
  filter(Vital == "CVD death") %>%
  group_by(yy_dlc, AgeDeathCat2) %>% # Agrupados por año de muerte y grupo de edad
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>% # Counts
  complete(yy_dlc, AgeDeathCat2, fill = list(cvd_deaths_BC = 0)) %>% # Incluir 0s
  bind_rows(
    group_by(., yy_dlc) %>% # Obtener counts por año overall
      summarize(cvd_deaths_BC = sum(cvd_deaths_BC), .groups = "drop") %>%
      mutate(AgeDeathCat2 = "Overall")
  ) %>%
  arrange(yy_dlc, AgeDeathCat2) %>%
  pivot_wider(names_from = AgeDeathCat2, values_from = cvd_deaths_BC) %>% # Tabla wide por grupo de edad
rename(YearDeath = yy_dlc) %>% 
  mutate(YearDeath = as.factor(YearDeath)) %>%
  bind_rows(
    summarise(., YearDeath = "All years", across(where(is.numeric), sum, na.rm = TRUE))
  )

View(cvd_deaths_BC_final2)



# Grupos de edad 18-64, 65-84 y 85+
cvd_deaths_BC_final3 <- cancer %>%
  filter(Vital == "CVD death") %>%
  group_by(yy_dlc, AgeDeathCat3) %>% # Agrupados por año de muerte y grupo de edad
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>% # Counts
  complete(yy_dlc, AgeDeathCat3, fill = list(cvd_deaths_BC = 0)) %>% # Incluir 0s
  bind_rows(
    group_by(., yy_dlc) %>% # Obtener counts por año overall
      summarize(cvd_deaths_BC = sum(cvd_deaths_BC), .groups = "drop") %>%
      mutate(AgeDeathCat3 = "Overall")
  ) %>%
  arrange(yy_dlc, AgeDeathCat3) %>%
  pivot_wider(names_from = AgeDeathCat3, values_from = cvd_deaths_BC) %>% # Tabla wide por grupo de edad
rename(YearDeath = yy_dlc) %>% 
  mutate(YearDeath = as.factor(YearDeath)) %>%
  bind_rows(
    summarise(., YearDeath = "All years", across(where(is.numeric), sum, na.rm = TRUE))
  )

View(cvd_deaths_BC_final3)

# Crear un data frame con todas las categorías posibles de AgeDeathCat
# all_categories <- expand.grid(
#   yy_dlc = unique(BC_alive_final$yy_dlc),  # Todas las categorías posibles de yy_dlc
#   AgeDeathCat = unique(BC_alive_final$AgeDeathCat) # Todas las categorías posibles de AgeDeathCat
# )

# Full Data ------------------------
# BC_dat <- full_join(all_categories, cvd_deaths_BC_final, by = c("yy_dlc", "AgeDeathCat")) %>%
#   full_join(BC_alive_final, by = c("yy_dlc", "AgeDeathCat")) %>%
#   mutate(across(everything(), ~replace_na(.x, 0))) %>%
#   arrange(yy_dlc, AgeDeathCat) %>% 
#   mutate(cvd_deaths_BC_rate = (cvd_deaths_BC/BC_alive)*1000) %>% 
#   filter(AgeDeathCat != "Unknown")
# 
# rm(all_categories, cvd_deaths_BC_final)
# 
# View(BC_dat)
```



---
title: "Registro Central de Cáncer"

output: html_document
editor_options: 
  chunk_output_type: console
---

This data is necessary so we can get the CVD death rates for BC survivors
in the standard population

```{r libraries, include = FALSE}
# Loading packages
library(readxl)
library(gtsummary)
library(tidyverse)
library(lubridate)
```

```{r data_wrangling,  cache = TRUE}
# Paths
paths <- c("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cáncer/Data/cancer_registry_20240924.csv",
           "~/Downloads/Registro Central de Cáncer/cancer_registry_20240924.csv",
           paste0("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Registro Central de Cáncer/cancer_registry_20240924.csv"))

# Attempt to read the file
cancer.raw <- suppressWarnings(tryCatch({
  read.csv(paths[1])
}, error = function(e) {
  read.csv(paths[2])
}, error = function(e) {
  read.csv(paths[3])
}))

cancer <- cancer.raw %>% 
  mutate(AgeDx = as.numeric(cancer.raw$AgeDx),
         AgeDx = ifelse(AgeDx == 999, NA, AgeDx),
         AgeFollowUpStart = AgeDx + 1,   
         AgeDeath = ifelse(VitalStatus == 0,
                           AgeDx + (yy_dlc - ydiag), NA),
         DiagnosisDate = make_date(year = ydiag, month = mm_dx, day = 1),
         FollowUpStart = DiagnosisDate %m+% years(1),
         FollowUpEnd = make_date(year = yy_dlc, month = mm_dlc, day = 1),
         FollowUpYears = as.numeric(difftime(FollowUpEnd, FollowUpStart, units = "days")) / 365.25,
         AgeDeathCat = as.factor(case_when(AgeDeath < 60 ~ "18-59",
                                           AgeDeath >= 60 ~ "60+",
                                           TRUE ~ NA)),
         AgeDeathCat2 = as.factor(case_when(AgeDeath >= 18 & AgeDeath <= 59 ~ "18-59",
                                            AgeDeath >= 60 & AgeDeath <= 69 ~ "60-69",
                                            AgeDeath >= 70 & AgeDeath <= 79 ~ "70-79",
                                            AgeDeath >= 80 ~ "80+",
                                            TRUE ~ NA)),
         Vital = as.factor(ifelse(VitalStatus == 0 & CVDDeathCause == 'CVD death','CVD death',
                                  ifelse(VitalStatus == 0 & BCDeathCause == 'BC death', 'BC death',
                                         ifelse(VitalStatus == 0, 'Other Death', 'Alive'
                                         )))),
         SurvivalTime = ifelse(VitalStatus == 1, NA,
                               ifelse(VitalStatus == 0 & FollowUpYears > 0,
                                      FollowUpYears, 0))) %>%
  select(EncryptedID, 
         mm_dx, ydiag, DiagnosisDate, FollowUpStart, AgeDx, AgeFollowUpStart, 
         mm_dlc, yy_dlc, FollowUpEnd, FollowUpYears, AgeDeath, FollowUpYears,
         AgeDeathCat, AgeDeathCat2, Vital, SurvivalTime, Surgery, Radiotherapy, Chemotherapy)

# Reviewing exclusions | 65
exclusions <- cancer %>%   
  filter(Vital == "CVD death",
         FollowUpYears <= 0) %>%
  select(Vital, AgeDx, DiagnosisDate, FollowUpEnd, SurvivalTime, Surgery, Radiotherapy, Chemotherapy)

# Persons observed | 17,183
cancer_observed <- cancer %>%
  filter(FollowUpYears > 0) 
```

```{r person-years_by_years}
# Crear datos CVD deaths in BC patients -----------------------------------------------
cat("Follow up period needs to be contemplated: `Follow-up period will be defined beginning 1 year after their first primary BC diagnosis (to estimate treatment completion) until date of last contact, death, or end up study period (December 31, 2020), whichever came first.`")

# Definir categorías de edad
age_categories <- function(age) {
  if (age < 60) {
    return("18-59")
  } else {
    return("60+")
  }
}

age_categories2 <- function(age) {
  if (age < 60) {
    return("18-59")
  } else if (age >= 60 & age < 70) {
    return("60-69")
  } else if (age >= 70 & age < 80) {
    return("70-79")
  } else {
    return("80+")
  }
}

# Crear función para calcular los person-years por categoría de edad para cada año
calc_person_years_by_year <- function(id, start_year, end_year, start_age) {
  results <- data.frame()
  
  # Solo proceder si el seguimiento es mayor a 0
  if (end_year > start_year) {
    # Iterar sobre los años en seguimiento
    follow_years_in_period <- seq(start_year+1, end_year)
    
    if (length(follow_years_in_period) > 0) {
      # Calcular la edad en cada año
      ages <- start_age + (follow_years_in_period - start_year)
      
      # Asignar a la categoría de edad
      age_groups <- sapply(ages, age_categories)
      age_groups2 <- sapply(ages, age_categories2)
      
      # Registrar los person-years por año y categoría de edad
      for (i in seq_along(follow_years_in_period)) {
        results <- rbind(results, data.frame(
          ID = id,  # Incluir el ID
          Year = follow_years_in_period[i],  # Año de seguimiento
          AgeGroup = age_groups[i],  # Grupo de edad
          AgeGroup2 = age_groups2[i],  # Grupo de edad
          PersonYears = 1  # Cada fila es un año/persona
        ))
      }
    }
  }
  return(results)
}

# Aplicar la funciones a cada persona con su ID
person_years_list_by_year <- mapply(calc_person_years_by_year, 
                            cancer_observed$EncryptedID, 
                            cancer_observed$FollowUpStart, 
                            cancer_observed$yy_dlc, 
                            cancer_observed$AgeFollowUpStart, 
                            SIMPLIFY = FALSE)

# Unir los resultados en un solo data frame
person_years_bc <- do.call(rbind, person_years_list_by_year) 

person_years_bc %>%    
  summarize(PersonYears = sum(PersonYears))
#A total of 62,783 person-years 
```


```{r}
# Definir categorías de edad
age_categories <- function(age) {
  if (age < 60) {
    return("18-59")
  } else {
    return("60+")
  }
}

age_categories2 <- function(age) {
  if (age < 60) {
    return("18-59")
  } else if (age >= 60 & age < 70) {
    return("60-69")
  } else if (age >= 70 & age < 80) {
    return("70-79")
  } else {
    return("80+")
  }
}

# Función para calcular person-years considerando meses y años del seguimiento
calc_person_years_months <- function(id, start_date, end_date, start_age) {
  results <- data.frame()
  
  # Comprobar si las fechas de seguimiento son válidas y el periodo de seguimiento es positivo
  if (is.na(start_date) | is.na(end_date) | start_date >= end_date) {
    return(results)  # Si las fechas son inválidas, devolver un data frame vacío
  }
  
  # Crear secuencia de meses entre start_date y end_date
  follow_months <- seq(from = floor_date(start_date, "month"), 
                       to = floor_date(end_date, "month"), 
                       by = "month")
  
  # Calcular la edad en cada mes de seguimiento
  ages <- start_age + (interval(start_date, follow_months) / years(1))
  
  # Calcular el tiempo contribuido en cada mes (fracción del año)
  time_contributed <- c(diff(follow_months) / years(1),  # Fracción del año para cada mes
                        interval(follow_months[length(follow_months)], end_date) / years(1))  # Fracción del último mes
  
  # Definir los años calendario y asignar categorías de edad
  years_followed <- year(follow_months)
  age_groups <- sapply(ages, age_categories)
  age_groups2 <- sapply(ages, age_categories2)
  
  # Registrar los person-years mensuales por ID, año y categoría de edad
  for (i in seq_along(follow_months)) {
    results <- rbind(results, data.frame(
      ID = id,  # ID del paciente
      Year = years_followed[i],  # Año de seguimiento
      Month = month(follow_months[i]),  # Mes del seguimiento
      AgeGroup = age_groups[i],  # Primera categoría de edad
      AgeGroup2 = age_groups2[i],  # Segunda categoría de edad
      PersonYears = time_contributed[i]  # Tiempo contribuido como fracción de un año
    ))
  }
  return(results)
}

# Filtrar observaciones con seguimiento positivo y fechas de seguimiento válidas
cancer_filtered <- cancer %>%
  filter(!is.na(FollowUpStart) & !is.na(FollowUpEnd) & FollowUpEnd > FollowUpStart & FollowUpYears > 0)

# Aplicar la función a cada persona con su ID y fechas de seguimiento
person_years_list <- pmap(list(cancer_filtered$EncryptedID, 
                               cancer_filtered$FollowUpStart, 
                               cancer_filtered$FollowUpEnd, 
                               cancer_filtered$AgeFollowUpStart), 
                          calc_person_years_months)

# Unir los resultados en un solo data frame
person_years_df <- bind_rows(person_years_list)
```

```{r cvm_calculations}
# CVM by year
cvm_by_year <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  group_by(yy_dlc) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>%  # Contar muertes por año
  bind_rows(data.frame(yy_dlc = c(2022, 2023), cvd_deaths_BC = c(0, 0))) %>%  # Añadir 2022 y 2023 con 0 muertes
  arrange(yy_dlc) %>%  # Ordenar por año
  rename(Year = yy_dlc) %>%  # Renombrar columna de año
  left_join(person_years_bc %>%  # Unir con person years por año
              group_by(Year) %>% 
              summarize(PersonYears = sum(PersonYears)), 
            by = "Year") %>% 
  mutate(Year = as.character(Year)) %>%  # Convertir Year a character para combinar con "All years"
  bind_rows(summarise(., Year = "All years", across(where(is.numeric), sum, na.rm = TRUE))) %>%  # Agregar total por todos los años
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years
  
# CVM by periods
cvm_by_period <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  mutate(Period = case_when(yy_dlc > 2004 & yy_dlc < 2010 ~ "2005-2009",
                            yy_dlc > 2009 & yy_dlc < 2015 ~ "2010-2014",
                            yy_dlc > 2014 & yy_dlc < 2020 ~ "2015-2019",
                            yy_dlc > 2019 & yy_dlc < 2025 ~ "2020-2024",
                            TRUE ~ NA)) %>%
  group_by(Period) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>%    # Contar muertes por año
  left_join(person_years_bc %>%  # Unir con person years por año
              mutate(Period = case_when(Year > 2004 & Year < 2010 ~ "2005-2009",
                            Year > 2009 & Year < 2015 ~ "2010-2014",
                            Year > 2014 & Year < 2020 ~ "2015-2019",
                            Year > 2019 & Year < 2025 ~ "2020-2024",
                            TRUE ~ NA)) %>%
              group_by(Period) %>% 
              summarize(PersonYears = sum(PersonYears)), 
            by = "Period") %>% 
  mutate(Period = as.character(Period)) %>%  # 
  bind_rows(summarise(., Period = "All years", across(where(is.numeric), sum, na.rm = TRUE))) %>%  # Agregar total por todos los años
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

# CVM by age categories (18-59, 60+)
cvm_by_agegroup1 <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  rename(AgeGroup = AgeDeathCat) %>% 
  group_by(AgeGroup) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>%    # Contar muertes por año
  left_join(person_years_bc %>%  # Unir con person years por año
              group_by(AgeGroup) %>% 
              summarize(PersonYears = sum(PersonYears)), 
            by = "AgeGroup") %>% 
  mutate(AgeGroup = as.character(AgeGroup)) %>%  # 
  bind_rows(summarise(., AgeGroup = "All ages", across(where(is.numeric), sum, na.rm = TRUE))) %>%  # Agregar total por todos los años
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

# CVM by age categories (18-59, 60-69, 70-79, 80+)
cvm_by_agegroup2 <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  rename(AgeGroup2 = AgeDeathCat2) %>% 
  group_by(AgeGroup2) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>%    # Contar muertes por año
  left_join(person_years_bc %>%  # Unir con person years por año
              group_by(AgeGroup2) %>% 
              summarize(PersonYears = sum(PersonYears)), 
            by = "AgeGroup2") %>% 
  mutate(AgeGroup2 = as.character(AgeGroup2)) %>%  # 
  bind_rows(summarise(., AgeGroup2 = "All ages", across(where(is.numeric), sum, na.rm = TRUE))) %>%  # Agregar total por todos los años
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

# CVM by year and age categories (18-59, 60+)
cvm_by_year_agegroup1 <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  rename(AgeGroup = AgeDeathCat) %>% 
  group_by(yy_dlc, AgeGroup) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>%  # Contar muertes por año
  bind_rows(data.frame(yy_dlc = c(2011, 2022, 2022, 2023, 2023), AgeGroup = c("18-59", "18-59", "60+", "18-59", "60+"), cvd_deaths_BC = c(0, 0,0, 0, 0))) %>%  
  rename(Year = yy_dlc) %>%  # Renombrar columna de año
  left_join(person_years_bc %>%  # Unir con person years por año
              group_by(Year, AgeGroup) %>% 
              summarize(PersonYears = sum(PersonYears)), 
            by = c("Year", "AgeGroup")) %>% 
  mutate(Year = as.character(Year)) %>%  # Convertir Year a character para combinar con "All years"
  bind_rows(summarise(., Year = "All years", AgeGroup = "All ages", across(where(is.numeric), sum, na.rm = TRUE))) %>%  # Agregar total por todos los años
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

# CVM by year and age categories (18-59, 60-69, 70-79, 80+)
cvm_by_year_agegroup2 <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  rename(AgeGroup2 = AgeDeathCat2) %>% 
  group_by(yy_dlc, AgeGroup2) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>%   # Contar muertes por año
  bind_rows(data.frame(yy_dlc = c(2011, 2022, 2022, 2022, 2022, 2023, 2023, 2023, 2023), 
                       AgeGroup2 = c("18-59", "18-59", "60-69", "70-79", "80+", "18-59", "60-69", "70-79", "80+"), 
                       cvd_deaths_BC = c(0, 0,0, 0, 0, 0,0,0,0))) %>%  
  rename(Year = yy_dlc) %>%  # Renombrar columna de año
  left_join(person_years_bc %>%  # Unir con person years por año
              group_by(Year, AgeGroup2) %>% 
              summarize(PersonYears = sum(PersonYears)), 
            by = c("Year", "AgeGroup2")) %>% 
  mutate(Year = as.character(Year)) %>%  # Convertir Year a character para combinar con "All years"
  bind_rows(summarise(., Year = "All years", AgeGroup2 = "All ages", across(where(is.numeric), sum, na.rm = TRUE))) %>%  
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

# CVM by period and age categories (18-59, 60+)
cvm_by_period_agegroup1 <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  mutate(Period = case_when(yy_dlc > 2004 & yy_dlc < 2010 ~ "2005-2009",
                            yy_dlc > 2009 & yy_dlc < 2015 ~ "2010-2014",
                            yy_dlc > 2014 & yy_dlc < 2020 ~ "2015-2019",
                            yy_dlc > 2019 & yy_dlc < 2025 ~ "2020-2024",
                            TRUE ~ NA)) %>%
  rename(AgeGroup = AgeDeathCat) %>% 
  group_by(Period, AgeGroup) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>% # Contar muertes por año
  left_join(
    person_years_bc %>%
      mutate(Period = case_when(Year > 2004 & Year < 2010 ~ "2005-2009",
                                Year > 2009 & Year < 2015 ~ "2010-2014",
                                Year > 2014 & Year < 2020 ~ "2015-2019",
                                Year > 2019 & Year < 2025 ~ "2020-2024",
                                TRUE ~ NA)) %>%
      group_by(Period, AgeGroup) %>%
      summarize(PersonYears = sum(PersonYears), .groups = "drop"), 
    by = c("Period", "AgeGroup")) %>% 
  mutate(Period = as.character(Period)) %>%  # Convertir Year a character para combinar con "All years"
  bind_rows(summarise(., Period = "All years", AgeGroup = "All ages", across(where(is.numeric), sum, na.rm = TRUE))) %>%  
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

# CVM by year and age categories (18-59, 60-69, 70-79, 80+)
cvm_by_period_agegroup2 <- cancer_observed %>%
  filter(Vital == "CVD death", yy_dlc <= 2024) %>%  # Filtrar muertes por CVD en el período de seguimiento
  mutate(Period = case_when(yy_dlc > 2004 & yy_dlc < 2010 ~ "2005-2009",
                            yy_dlc > 2009 & yy_dlc < 2015 ~ "2010-2014",
                            yy_dlc > 2014 & yy_dlc < 2020 ~ "2015-2019",
                            yy_dlc > 2019 & yy_dlc < 2025 ~ "2020-2024",
                            TRUE ~ NA)) %>%
  rename(AgeGroup2 = AgeDeathCat2) %>% 
  group_by(Period, AgeGroup2) %>%  # Agrupar por año de muerte
  summarize(cvd_deaths_BC = n(), .groups = "drop") %>% # Contar muertes por año
  left_join(
    person_years_bc %>%
      mutate(Period = case_when(Year > 2004 & Year < 2010 ~ "2005-2009",
                                Year > 2009 & Year < 2015 ~ "2010-2014",
                                Year > 2014 & Year < 2020 ~ "2015-2019",
                                Year > 2019 & Year < 2025 ~ "2020-2024",
                                TRUE ~ NA)) %>%
      group_by(Period, AgeGroup2) %>%
      summarize(PersonYears = sum(PersonYears), .groups = "drop"), 
    by = c("Period", "AgeGroup2")) %>% 
  mutate(Period = as.character(Period)) %>%  # Convertir Year a character para combinar con "All years"
  bind_rows(summarise(., Period = "All years", AgeGroup2 = "All ages", across(where(is.numeric), sum, na.rm = TRUE))) %>%  
  mutate(cvd_rate = (cvd_deaths_BC / PersonYears) * 1000)  # Calcular tasa por 1000 person-years

```

```{r exports}
# Exporting file grouped by year and age groups 0-59 and 60+

tryCatch({
  write.csv(cvm_by_year_agegroup1, "C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cáncer/Data/cvm_by_year_agegroup1.csv")
}, error = function(e) {
  write.csv(cvm_by_year_agegroup1, "~/Downloads/Registro Central de Cáncer/cvm_by_year_agegroup1.csv")
}, error = function(e) {
  write.csv(cvm_by_year_agegroup1, "~/../projects_shared/BBC/Project_Dra. Carola/Data/Registro Central de Cáncer/cvm_by_year_agegroup1.csv")
})

# Exporting file grouped by year and age groups 0-59, 60-69, 70-79, 80+
tryCatch({
  write.csv(cvm_by_year_agegroup2, "C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cáncer/Data/cvm_by_year_agegroup2.csv")
}, error = function(e) {
  write.csv(cvm_by_year_agegroup2, "~/Downloads/Registro Central de Cáncer/cvm_by_year_agegroup2.csv")
}, error = function(e) {
  write.csv(cvm_by_year_agegroup2, "~/../../projects_shared/BBC/Project_Dra. Carola/Data/Registro Central de Cáncer/cvm_by_year_agegroup2.csv")
})

```

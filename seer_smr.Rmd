---
title: "SMR Calculations - US Reference Population"
date: "`r format(Sys.time(), '%b %d, %Y - %I:%M %p')`"
output:
  word_document: 
    reference_docx: "template.docx"
    fig_width: 9
    fig_height: 7
    fig_caption: true
editor_options:
  chunk_output_type: console
---

```{r libraries, include = FALSE, cache = FALSE}

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE, results = "asis")

library(readxl)
library(dplyr)
library(mgcv)
library(ggplot2)
library(openxlsx)
library(popEpi) # SMR analysis
library(Epi) 
library(data.table)  
library(lubridate)
library(beepr) # sounds for R
library(stringr)
library(tidyr)
library(gtsummary)
library(gt) # for creating gt tables
library(webshot) # for saving images as png
library(survival) # for cumulative mortality km curves
library(forcats)
library(scales) # commas for numbers
library(survminer) #for ggsurvplot graphs
library(magick) # for tif file management
library(forestploter) # for forest plots
library(gridExtra) # joining forest plots
library(broom)
library(purrr)
library(conflicted)
library(extrafont)
conflicts_prefer(lubridate::year)
conflicts_prefer(dplyr::filter)
conflicts_prefer(survival::Surv)
library(showtext)
font_import(pattern = "Times", prompt = FALSE)
font_add("Times New Roman",
         regular = "/System/Library/Fonts/Supplemental/Times New Roman.ttf",
         bold = "/System/Library/Fonts/Supplemental/Times New Roman Bold.ttf")

#font_add("Times New Roman", regular = "/System/Library/Fonts/Supplemental/Times New Roman.ttf")
showtext_auto()
showtext_opts(dpi = 300)
base_path_cvd <- "~/Library/CloudStorage/Box-Box/Sanchez-Diaz Lab/CVD and BC/Statistical Analysis/Outputs/Figures/"

theme_cvd <- theme(
  text = element_text(size = 30), 
  strip.text = element_text(angle = 0, face = "bold", size = 25), 
  strip.background = element_rect(fill = NA, color = NA),
  axis.text = element_text(size = 20),  
  panel.spacing = unit(1, "lines"))

```

```{r functions}

# To suppress values under 10 for wide data frames

suppress_values <- function(data) {
  data %>%
    mutate(
      Observed = ifelse(as.numeric(Observed) < 10, "<10", Observed),
      Expected = ifelse(Observed == "<10", "-", Expected),
      SMR = ifelse(Observed == "<10", "-", SMR),
      CI.Lower = ifelse(Observed == "<10", "-", CI.Lower),
      CI.Upper = ifelse(Observed == "<10", "-", CI.Upper)
    )
}

# Changing label of other race/ethnicity

recode_race_eth <- function(df) {
  df <- df %>%
    mutate(race_eth = case_when(
      race_eth == "White" ~ "NH White",
      race_eth == "Black" ~ "NH Black",
      race_eth == "Asian American, Native Hawaiian and other Pacific Islanders" ~ "NH AANHPI/AIAN",
     # race_eth == "PR Hispanic" ~ "PR-H",
    #  race_eth == "US Hispanic" ~ "US-H",
     # race_eth == "White" ~ "US-NHW",
      #race_eth == "Black" ~ "US-NHB",
      #race_eth == "Asian American, Native Hawaiian and other Pacific Islanders" ~ "US-NH AANHPI/ \n AIAN",
      TRUE ~ as.character(race_eth)
    )) %>%
    mutate(race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "NH White", "NH Black", "NH AANHPI/AIAN")))
  return(df)
}

name_columns <- function(df) {
  race_ethnicity_pattern <- "_(White|Black|AANHPI & AIAN|US Hispanic|PR Hispanic)"
  
  setNames(
    str_replace_all(
      str_remove(colnames(df), race_ethnicity_pattern),
      c("Observed" = "O", "Expected" = "E")
    ),
    colnames(df)
  )
}


create_gt_table <- function(df, groupname_col = NULL) {
  if (!is.null(groupname_col)) {
    table <- df |> 
      gt(groupname_col = groupname_col)
  } else {
    table <- df |> 
      gt()
  }
  
  table <- table |> 
    spanners_and_header() |> 
    cols_label(.list = desired_colnames) |> 
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_row_groups()) |> 
    cols_align(align = "center", columns = everything()) |> 
    tab_options(table.font.size = px(6)) |>
    tab_source_note(
      source_note = "SMRs were calculated as the observed number of cardiovascular disease deaths among breast cancer patients divided by the expected number of cardiovascular disease deaths in the race- and ethnic-matched general female U.S. population. SMR calculations for results with <10 events were suppressed. \n
      AANHPI, Asian American, Native Hawaiian, and Pacific Islander; 
      AIAN, American Indian and Alaska Native;
      CVD: cardiovascular disease; 
      E = Expected; 
      O = Observed;
      SMR = Standardized Mortality Ratio."
    )
  
  return(table)
}


# Creating column names

spanners_and_header <- function(gt_tbl) {
  gt_tbl |> 
    tab_spanner(label = md('**White**'), columns = contains('White')) |> 
    tab_spanner(label = md('**Black**'), columns = contains('Black')) |> 
    tab_spanner(label = md('**AANHPI & AIAN**'), columns = contains('AANHPI & AIAN')) |> 
    tab_spanner(label = md('**US Hispanic**'), columns = contains('US Hispanic')) |> 
    tab_spanner(label = md('**PR Hispanic**'), columns = contains('PR Hispanic'))
}

# For quality control section: sums observations for each SEER*Stat table

sum_observed_columns <- function(df) {
  df %>%
    mutate(across(starts_with("Observed"), ~ as.numeric(gsub("<10", NA, .)))) %>%
    summarize(across(starts_with("Observed"), sum, na.rm = TRUE))
}


# JACC ggplot2 theme


jacc_theme <- function() {
 theme_bw(base_size = 16) +
 theme(strip.background = element_blank(),
 plot.title = element_text(face = "bold", hjust = 0.5))

}


```

```{r cancer_data}

# Cleansed cancer data

cancer <- suppressWarnings(tryCatch({
  read.csv("~/Library/CloudStorage/Box-Box/Sanchez-Diaz Lab/CVD and BC/Registro Central de Cancer/Data/cancer_cleansed.csv")
}, error = function(e) {
  read.csv("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Registro Central de CÃ¡ncer/cancer_cleansed.csv")
}))
cancer <- cancer %>%
  mutate(FollowUpStart = as.Date(FollowUpStart),
         DiagnosisDate = as.Date(DiagnosisDate),
         FollowUpEnd = as.Date(FollowUpEnd),
         maritallabel = str_to_title(ifelse(maritallabel == "unknown",
                               NA,
                               maritallabel)),
         Comorb.cat = factor(ifelse(Comorb == '0' , 'No', 
                             ifelse(as.numeric(Comorb) >= 1, 'Yes', 'Unknown')),
                             levels= c('Yes','No','Unknown')),
    Procedure = factor(Procedure,
                               levels = c("Surgery Only", "Chemotherapy Only",
                                          "Radiotherapy Only", "Chemotherapy and Radiotherapy",
                                          "Other")),
    Comorbidity = case_when(
    Comorb == -1 ~ NA_character_,
    Comorb == 0 ~ "0",
    Comorb == 1 ~ "1",
    Comorb == 2 ~ "2",
    Comorb >= 3 ~ "3+"
  ),
   StageAtDx = factor(StageAtDx,
                   levels = c("Localized", "Regional", "Distant", "Unstaged"),
                   labels = c("Localized", "Regional", "Distant", "Unknown/unstaged")),
   lagTime = as.numeric(difftime(FollowUpEnd, DiagnosisDate, units = "days")) / 365.25,
   status = ifelse(Vital == 'CVD death',1, 0))

cancer_observed <- cancer %>%
  filter(FollowUpYears > 0)

cancer_observed$HealthRegion <- str_to_title(cancer_observed$HealthRegion)
cancer_observed$HealthRegion <- factor(cancer_observed$HealthRegion,
                            levels = c('Noreste Metro','Central Bayamon','Oeste Aguadilla/Mayaguez',
                                       'Sureste Caguas','Sur Ponce',"Norte Arecibo",
                                       'Este Fajardo','County Unknown'
                                       ))

```

```{r us_reference}

us_reference_raw <- suppressWarnings(tryCatch({
  read.delim("C:/Users/Genesis Rodriguez/Downloads/Statistical Analysis/Inputs/us_reference_by_race_eth.txt")
}, error = function(e) {
  read.delim("~/Downloads/Statistical Analysis/Inputs/us_reference_by_race_eth.txt")
}, error = function(e) {
  read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/us_reference_by_race_eth.txt")
}))

us_reference <- us_reference_raw %>%
  rename(agegroup = Age.recode.CVD.groupings,
         Race = Race.and.origin.recode..NHW..NHB..NHAIAN..NHAPI..Hispanic.,
         deathyear = Year.of.death..2004.2021.) %>%
  filter(Race == "Hispanic (All Races)") %>%
  mutate(Count = as.numeric(gsub(",", "", Count)),
         Population = as.numeric(gsub(",", "", Population)),
         gen_cvd_rate = Count/Population,
         agegroup = case_when(
           agegroup == "00-39 years" ~ 0,
           agegroup == "40-49 years" ~ 40,
           agegroup == "50-59 years" ~ 50,
           agegroup == "60-69 years" ~ 60,
           agegroup == "70-79 years" ~ 70,
           agegroup == "80+ years" ~ 80))


```

```{r pr_description, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Descriptive Analysis ----------------------------------------------------

fisher_sim_p <- function(data, variable, by, ...) {
  result <- list()
  result$p <- stats::fisher.test(x = data %>% pull({{variable}}), y = data %>% pull({{by}}), simulate.p.value = T)$p.value
  result$test <- "Fisher's test with simulated p-value"
  result
}

gt_pr_table1 <- cancer_observed %>%
    mutate(
HealthRegion = na_if(HealthRegion, "County Unknown"),
    StageAtDx = na_if(StageAtDx, "Unknown/unstaged"),
    StageAtDx = fct_drop(StageAtDx),
    HealthRegion = fct_drop(HealthRegion)) %>%
  select(c(Vital, AgeDx, AgeDxCat, AgeDeath, FollowUpYears, HealthRegion, maritallabel, Procedure, StageAtDx)) %>%
  filter(Vital != "Alive", !is.na(AgeDxCat)) %>% 
#mutate(maritallabel = forcats::fct_na_value_to_level(maritallabel, level = "Unknown")) %>%
 tbl_summary(by = Vital,
              label = c(AgeDx ~ "Age at Diagnosis (Continuous)",
                        AgeDxCat ~ "Age at Diagnosis (Categorical)",
                        AgeDeath ~ "Age at Death",
                    #    SurvivalTime ~ "Time to Death (Years)",
                        HealthRegion ~ "Health Region",
                        maritallabel ~ "Marital Status",
                        Procedure ~ "Treatment",
                        FollowUpYears ~ "Follow Up Time (Years)",
                        StageAtDx ~ "Stage at Diagnosis"),
             type = all_continuous() ~ "continuous2",
             statistic = list(all_continuous() ~ c(
      "{mean} (Â±{sd})",
      "{median} ({p25}-{p75})",
      "{min}-{max}"),
    all_categorical() ~ "{n} ({p}%)"),
digits = list(all_continuous() ~ 2, all_categorical() ~ c(0, 2)),
missing = "no") %>%
  add_overall(col_label = "**All death causes**.   \nN = {style_number(N)}") %>%
add_p(
    test = list(
      all_continuous() ~ "oneway.test", # Welch's ANOVA due to no assumption of homogeneity of variances
      c(Procedure, HealthRegion) ~ "fisher_sim_p",
      all_categorical() ~ "chisq.test"
    )) %>%
modify_footnote(
    label ~ "The percentage of unknown participant characteristics was as follows: 7.13% for marital status, 0.13% for health region, and 4.21% for stage at diagnosis.",
    stat_0 ~ NA,
    stat_1 ~ NA,
    stat_2 ~ NA,
    stat_3 ~ NA,
    p.value ~ "P-values were calculated using Welch's one-way test for continuous variables to account for unequal variances. For categorical variables, the chi-squared test was used unless cell counts were low, in which case Fisher's exact test was applied to obtain a simulated p-value.") %>%
  #modify_footnote(everything() ~ NA) %>%
  modify_caption("**Table 1: Baseline Characteristics of Study Population**") %>%
  as_gt()

```

```{r pr_smrs}
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, ydiag, AgeDxCat, yearDiagCat, deathYearCat, Comorb.cat, Comorbidity, maritallabel, StageAtDx))

gen_2 <- suppressWarnings(tryCatch({
  read.csv("C:/Users/Genesis Rodriguez/Box/Sanchez-Diaz Lab/CVD and BC/Defunciones/cvm_rate_gen_pop2.csv")
}, error = function(e) {
  read.csv("~/Downloads/NCHS/cvm_rate_gen_pop2.csv")
}))
gen_2 <- as.data.table(gen_2)
setnames(gen_2, old = c("current_data_year", "AgeDeathCat2"), new = c("deathyear", "agegroup"))
gen_2 <- gen_2[, .(agegroup, deathyear, n, Population, gen_cvd_rate)]
gen_2[, agegroup := ifelse(agegroup == "80+", "80", 
                           ifelse(agegroup == "18-39", "0", 
                                sub("([0-9]+)-([0-9]+)", "\\1", agegroup)))]
gen_2[, agegroup := as.numeric(agegroup)]
gen_2[, gen_cvd_rate := gen_cvd_rate / 1000]

gt_pr_general <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = gen_2, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "wald",
                  conf.level = 0.95) %>%
    mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
    sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected)) %>% 
  gt() %>%
  fmt_number(columns = c(expected, sir, sir.lo, sir.hi), decimals = 2)

# SMRs by year of diagnosis

# By year of diagnosis
smr_ydiag <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = gen_2, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "trend",
                  conf.type = "wald",
                  conf.level = 0.95,
                  print ='ydiag') %>%
    mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
    sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected))  %>%
  rename(
    "Year of Diagnosis" = ydiag,
    "Observed" = observed,
    "Expected" = expected,
    "Person-Years" = pyrs,
    "Standardized Mortality Ratio (SMR)" = sir,
    "Lower 95% CI" = sir.lo,
    "Upper 95% CI" = sir.hi,
    "P-Value" = p_value
  ) %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))

f_ydiag <- ggplot(data = smr_ydiag, aes(x = `Year of Diagnosis`, y = `Standardized Mortality Ratio (SMR)`)) +
   geom_ribbon(aes(ymin = `Lower 95% CI`, ymax = `Upper 95% CI`), fill = "#d9eaf7", alpha = 0.4) +  # Confidence interval with fill color
  geom_text(aes(label = format(round(`Standardized Mortality Ratio (SMR)`, 2), nsmall = 2)), nudge_y = 1, nudge_x = -0.1, size = 5, color = "black", 
family = "Times New Roman") + 
  geom_line(color = "royalblue4", size = 0.8) +
  geom_point(size = 1.25, shape = 21, fill = "royalblue4", color = "royalblue4") +
  geom_hline(yintercept = 1, color = "#FF3D2E", linetype = "dashed", size = 0.5) +  # #Red dashed line at SMR = 1
  xlab("Year of Diagnosis") +
  ylab("SMR") +
  scale_x_continuous(breaks = smr_ydiag$`Year of Diagnosis`) +
  scale_y_continuous(breaks = seq(1, max(smr_ydiag$`Upper 95% CI`, na.rm = TRUE), by = 2), limits = c(1, NA)) +
  jacc_theme() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 24),
        axis.text = element_text(size = 16),
    axis.text.x = element_text(angle = 45, hjust = 1), text = element_text(family = "Times New Roman"))

ggsave(file.path(base_path_cvd, "pr_diagnosisyear_graph.png"), plot = f_ydiag, width = 10, height = 6, dpi = 300,  bg = "white")


# SMRs by age group

# By age group
smr_agegroup <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = gen_2, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity", # test for equal SMRs
                  conf.type = "wald",
                  conf.level = 0.95,
                  print ='AgeDxCat') %>%
    mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
    sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected))

f_pragegroup <- ggplot(data = smr_agegroup[smr_agegroup$AgeDxCat != "18-39", ], aes(y = fct_rev(AgeDxCat), x = sir, fill = AgeDxCat)) +
  #geom_bar(stat = "identity", color = "royalblue4", width = 0.5) +
  geom_errorbarh(aes(xmin = sir.lo, xmax = sir.hi), height = 0.2, color = "royalblue4") +  
  geom_point(size = 4, color = "royalblue4") +  
  geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +  
  geom_text(aes(label = sprintf("%.2f", sir)), vjust = -1, hjust = 0.5, size = 4, family = "Times New Roman") + 
  ylab("Age at Diagnosis") +
  xlab("SMR") +
  scale_fill_manual(values = rep("#d9eaf7", length(unique(smr_agegroup$AgeDxCat)))) +
  jacc_theme() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none", 
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 12),
    text = element_text(family = "Times New Roman"))

ggsave(file.path(base_path_cvd, "pr_agegroup_diagnosis_graph.png"), plot = f_pragegroup, width = 7, height = 5.5, dpi = 300,  bg = "white")

# By treatment
c_treatment <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, Procedure))

smr_treatment <- sir(coh.data = c_treatment, coh.obs = 'from0to1',
                coh.pyrs = 'pyrs',
                ref.data = gen_2,
                ref.rate = 'gen_cvd_rate',
                adjust = c('deathyear', 'agegroup'),
                test.type = "homogeneity",
                conf.type = "wald",
                conf.level = 0.95,
                print ='Procedure') %>%
    mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
    sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected))

f_prtreatment <- ggplot(data = smr_treatment[smr_treatment$observed >= 10,], aes(y = fct_rev(Procedure), x = sir, fill = Procedure)) +
  geom_errorbarh(aes(xmin = sir.lo, xmax = sir.hi), height = 0.2, color = "royalblue4") +  
  geom_point(size = 4, color = "royalblue4") +  
  geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +  
  geom_text(aes(label = sprintf("%.2f", sir)), vjust = -1, hjust = 0.5, size = 4, family = "Times New Roman") + 
  ylab("Initial Treatment") +
  xlab("SMR") +
  scale_fill_manual(values = rep("#d9eaf7", length(unique(smr_treatment$Procedure)))) + 
  jacc_theme() + 
  scale_y_discrete(labels = function(x) str_wrap(x, width = 10)) +
  jacc_theme()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none", 
        text = element_text(family = "Times New Roman"),
            axis.title = element_text(size = 18),
        axis.text = element_text(size = 12))

ggsave(file.path(base_path_cvd, "pr_treatment.png"), plot = f_prtreatment, width = 7.5, height = 5, dpi = 300,  bg = "white")

```

```{r sir, include = FALSE}

# SIR session

pr_sir_general <- cancer_observed %>%
  mutate(Vital = as.character(Vital),
    `Cause of Death` = case_when(
      Vital == "CVD death" ~ "CVD Death",
      Vital == "BC death" ~ "Other Causes of Death",
      Vital == "Other Death" ~ "Other Causes of Death",
      TRUE ~ Vital)) %>%
  group_by(`Cause of Death`) %>%
  count(name = "Count") %>%
  mutate(race_eth = "PR Hispanic")

us_sir_general <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/sir_general.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/sir_general.txt")
  } )) %>%
select(Index.Record.Cause.of.Death.CVD.recode,
       Index.Record.Race.Ethnicity.CVD, 
       Count) %>%
  rename(`Cause of Death` = Index.Record.Cause.of.Death.CVD.recode,
         race_eth = Index.Record.Race.Ethnicity.CVD) %>% 
  relocate(race_eth) %>%
  mutate(Count = as.numeric(gsub(",", "", Count)),
        `Cause of Death` = gsub("\\[OTHER\\]", "Other Causes of Death",
    `Cause of Death`),
    `Cause of Death` = gsub("CVD", "CVD Death",
    `Cause of Death`))

us_sir_general <- recode_race_eth(us_sir_general)

us_sir_general_wider <- us_sir_general %>%
 pivot_wider(names_from = c(race_eth), values_from = Count)


merged_sir_general <- rbind(pr_sir_general, us_sir_general) %>%
  mutate(race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "AANHPI & AIAN"))) %>%
  group_by(race_eth) %>%
  mutate(Count = paste0(comma(Count), " (", sprintf("%.2f", Count/ sum(Count) * 100), "%)")) %>%
  arrange(race_eth) 

merged_sir_general_wider <- merged_sir_general %>%
  pivot_wider(names_from = c(race_eth), values_from = Count)

# Creating gt table
  
gt_sir_general <- merged_sir_general_wider |> 
  rename(`Vital status` = `Cause of Death`) |>
  gt() |> 
    tab_style(
      style = cell_text(weight = "bold"), 
      locations = cells_column_labels(everything())) |> 
  cols_align(align = "center", columns = everything()); #gt_sir_general

# US sample size
us_n <- us_sir_general %>% summarise(sum = sum(Count))

```

```{r sir_case_listing, include = FALSE}

us_sir_general_cl_df <- read.delim2("~/Downloads/Statistical Analysis/Inputs/sir_general_case_listing.txt") %>%
  mutate(Survival.months = as.numeric(Survival.months),
         FollowUpYears = round((Survival.months - 12) / 12, 2),
         cvdStatus = ifelse(Cause.of.Death.CVD.recode == "CVD", 1, 0)) %>%
  filter(Event.Number == "Index Record",
         Race.Ethnicity.CVD != " ")

# US General SIR table
#us_sir_general %>% arrange(`Cause of Death`)
us_sir_general_cl <- us_sir_general_cl_df %>%
  count(Cause.of.Death.CVD.recode, Race.Ethnicity.CVD, name = "Count") %>%
  arrange(Cause.of.Death.CVD.recode)

# Total U.S. CVD Deaths
#us_sir_general %>% filter(`Cause of Death` == "CVD Death") %>% summarise(sum = sum(Count))
#us_sir_general_cl %>% filter(Cause.of.Death.CVD.recode == "CVD") %>% nrow()

# Total U.S. Persons
#us_sir_general %>% summarise(sum = sum(Count))
#us_sir_general_cl %>% nrow()

# U.S. case listing by vital status
#us_sir_general %>% group_by(`Cause of Death`) %>% summarise(n = sum(Count))
#table(us_sir_general_cl$Cause.of.Death.CVD.recode)

```

```{r}

#source("~/BC_CVD/flowChart.R")

```

```{r global}

# PR SMR
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart,
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per))

pr_smr_general <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95) %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic") %>%
  select(-c(pyrs, p_value)) %>%
  rename(Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
   mutate(CI.Lower = round(qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected), 2),
    CI.Upper = round(qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected),2))  %>% 
  relocate(race_eth)

us_smr_general <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_general.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_general.txt")
})) %>%
select(Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper) %>%
  rename(race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected))

merged_general <- rbind(pr_smr_general, us_smr_general) %>%
  mutate(race_eth = as.factor(race_eth),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(race_eth)

merged_general <- recode_race_eth(merged_general)

f_general <- ggplot(merged_general, aes(y = fct_rev(race_eth), x = as.numeric(SMR))) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 1) +
  geom_errorbar(aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)), color = "royalblue4", width = 0.3, linewidth = 1) +
    geom_point(size = 4, color = "royalblue4") +  # Plot SMR points
    jacc_theme() +
    scale_x_continuous(limits = c(0.60, 1.5), expand = expansion(mult = c(0.1, 0.1))) +
    geom_text(aes(label = sprintf("%.2f", as.numeric(SMR))), size = 7, position = position_dodge(0), vjust = -1.5) +
    labs(x = "SMR", y = "Race/Ethnicity") +
  xlab("SMR") +
  jacc_theme() +
  coord_cartesian(clip = "off") +
   theme(axis.text = element_text(size = 25),
          axis.text.x = element_text(hjust = 1),
          axis.text.y = element_text(colour = "black", face = "bold")) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    text = element_text(size = 30, family = "Times New Roman"),
    strip.text = element_text(angle = 0, size = 25, lineheight = 0.7, face = "bold", margin = margin(b = 5)), 
    strip.background = element_rect(fill = NA, color = NA))


ggsave(file.path(base_path_cvd, "general_graph.png"), plot = f_general, width = 11.5, height = 10, dpi = 300,  bg = "white")

# Supressing values under 10

merged_general <- suppress_values(merged_general)

# Merging US and PR General
merged_general_wider <- merged_general %>%
  mutate("95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Age Group")

# Setting column names
desired_colnames <- name_columns(merged_general_wider)

# Creating gt table
gt_general <- create_gt_table(merged_general_wider)


```

```{r deathyear_table}

# PR SMRs by Death Year
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per))

pr_smr_deathyear <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = "deathyear") %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic") %>%
  select(-c(pyrs, p_value)) %>%
  rename("Year of Death" = deathyear,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
   mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
    CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US SMRs by Death Year
us_smr_deathyear <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_deathyear.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_deathyear.txt")
})) %>%
select(c(Year.of.death.recode,
  Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  filter(!(Year.of.death.recode %in% c("2000-2021", "2000", "2001", "2002", "2003",
                                       "2004", "Alive at last contact")),
                  Race.Ethnicity.CVD != "All races/ethnicities") %>%
  rename("Year of Death" = Year.of.death.recode, 
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected))

# Merging PR and US by Death Year 

merged_deathyear <- rbind(pr_smr_deathyear, us_smr_deathyear) %>%
  mutate(Observed = as.numeric(Observed),
    across(c(race_eth, "Year of Death"), as.factor),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(race_eth)

# Suppressing values under 10

merged_deathyear <- suppress_values(merged_deathyear)

# Renaming other race/ethnicity

merged_deathyear <- recode_race_eth(merged_deathyear)

# Widening by Race/Ethnicity

merged_deathyear_wider <- merged_deathyear %>%
 mutate("95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Year of Death")

# Naming columns
desired_colnames <- name_columns(merged_deathyear_wider)

# Creating gt table

gt_deathyear <- create_gt_table(merged_deathyear_wider)

```

```{r deathyear_graph}

# Create the ggplot
f_deathyear <- ggplot(merged_deathyear, aes(x = `Year of Death`, y = as.numeric(SMR), color = race_eth, fill = race_eth, group = race_eth)) +
  geom_line(size = 1) +  # Line for SMR over years
 # geom_ribbon(aes(ymin = as.numeric(CI.Lower), ymax = as.numeric(CI.Upper)), alpha = 0.2, color = NA) +  # Confidence interval ribbons
  jacc_theme() +
  geom_hline(yintercept = 1, linetype = "solid", color = "black", size = 0.5) +  # Horizontal line at SMR = 1
  labs(
    x = "Year of Death",
    y = "SMR",
    color = "Race/Ethnicity",
    fill = "Race/Ethnicity"
  ) +
  scale_y_continuous(limits = c(0, 35)) +
  scale_fill_manual(values = c('#4E86A7', '#6B9F88', '#F1C04A', '#F07F47', '#D08690', '#9E7DB4')) +
  scale_color_manual(values = c('#4E86A7', '#6B9F88', '#F1C04A', '#F07F47', '#D08690', '#9E7DB4')) +
  guides(
    color = guide_legend(nrow = 2),
    fill = guide_legend(nrow = 2)
  ) +
  theme(
    text = element_text(size = 10),
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9))

ggsave(file.path(base_path_cvd, "grouped_deathyear_graph.png"), plot = f_deathyear, width = 10, height = 8, dpi = 300,  bg = "white")

```

```{r grouped_deathyear_table}

 pr_smr_g_deathyear <- pr_smr_deathyear %>%
  mutate(`Year of Death` = case_when(
    `Year of Death` >= 2005 & `Year of Death` <= 2010 ~ "2005-2010",
    `Year of Death` >= 2011 & `Year of Death` <= 2016 ~ "2011-2016",
    `Year of Death` >= 2017 & `Year of Death` <= 2021 ~ "2017-2021"
  )) %>%
  group_by(`Year of Death`) %>%
  summarise(
    Observed = sum(Observed),
    Expected = sum(Expected),
    .groups = "drop"
  ) %>%
  mutate(race_eth = "PR Hispanic",
         SMR = Observed / Expected,
         CI.Lower = ifelse(
           Observed == 0, 0, 
           qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected)
         ),
         CI.Upper =  ifelse(
           Observed == 0, Inf, 
           qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))
         )  %>% 
  relocate(race_eth)


# US SMRs by Death Year
us_smr_g_deathyear <- us_smr_deathyear %>%
  mutate(`Year of Death` = case_when(
    `Year of Death` >= 2005 & `Year of Death` <= 2010 ~ "2005-2010",
    `Year of Death` >= 2011 & `Year of Death` <= 2016 ~ "2011-2016",
    `Year of Death` >= 2017 & `Year of Death` <= 2021 ~ "2017-2021"
  ),
  Observed = as.numeric(Observed),
  Expected = as.numeric(Expected)) %>%
  group_by(race_eth, `Year of Death`) %>%
   summarise(
    Observed = sum(Observed),
    Expected = sum(Expected),
    .groups = "drop") %>%
  mutate(SMR = Observed / Expected,
         CI.Lower = ifelse(
           Observed == 0, 0, 
           SMR * exp(-1.96 * sqrt(1 / Observed))
         ),
         CI.Upper =  ifelse(
           Observed == 0, Inf, 
           SMR * exp(1.96 * sqrt(1 / Observed)))) %>%
  arrange(race_eth, `Year of Death`)

# Merging PR and US by Death Year 

merged_g_deathyear <- rbind(pr_smr_g_deathyear, us_smr_g_deathyear) %>%
  mutate(`Year of Death` = as.factor(`Year of Death`),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic", "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
        # across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 1), nsmall = 1))) %>%
  arrange(race_eth)

# Suppressing values under 10

merged_g_deathyear <- suppress_values(merged_g_deathyear)


# Renaming other race/ethnicity

merged_g_deathyear <- recode_race_eth(merged_g_deathyear)

# Widening by Race/Ethnicity

merged_g_deathyear_wider <- merged_g_deathyear %>%
 mutate("95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Year of Death")

# Naming columns
desired_colnames <- name_columns(merged_g_deathyear_wider)

# Creating gt table

gt_g_deathyear <- create_gt_table(merged_g_deathyear_wider)

```

```{r grouped_deathyear_graph}

f_g_deathyear <- ggplot(merged_g_deathyear, aes(y = `Year of Death`, x = as.numeric(SMR))) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +
    geom_point(size = 0.7, position = position_dodge(width = 0.5), color = "royalblue4") +
    geom_errorbar(color = "royalblue4",
        aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)),
        width = 0.2, position = position_dodge(width = 0.5)) +
    facet_wrap(~ race_eth, ncol = 2, scales = "free_x") +  # Adjust `ncol` to create square facets
    #facet_wrap(~ race_eth, ncol = 2) +  # Adjust `ncol` to create square facets
  scale_y_discrete(limits = rev(unique(merged_g_deathyear$`Year of Death`))) +
  #scale_x_continuous(limits = c(1,12)) +
  theme_bw(base_family = "lato") +
    labs(x = "SMR") +
  theme_cvd +
  theme(legend.position = "none")

ggsave(file.path(base_path_cvd, "g_deathyear.png"), plot = f_g_deathyear, width = 10, height = 8, dpi = 300,  bg = "white")

```

```{r diagnosis_table}

# PR SMRs by Diagnosis Year
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, ydiag))

pr_smr_diagnosisyear <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = "ydiag") %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic") %>%
  select(-c(pyrs, p_value)) %>%
  rename("Year of Diagnosis" = ydiag,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
  mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
         CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US SMRs by Diagnosis Year
us_smr_diagnosisyear <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_diagnosisyear.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_diagnosisyear.txt")
})) %>% select(c(Year.of.diagnosis,
  Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  filter(!(Year.of.diagnosis %in% c("2000-2021", "2000", "2001", "2002", "2003", "2020", "2021")),
                  Race.Ethnicity.CVD != "All races/ethnicities") %>%
  rename("Year of Diagnosis" = Year.of.diagnosis, 
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected))

# Merging PR and US by Death Year 

merged_diagnosisyear <- rbind(pr_smr_diagnosisyear, us_smr_diagnosisyear) %>%
  mutate(across(c(race_eth, "Year of Diagnosis"), as.factor),
         across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 2), nsmall = 1)),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(race_eth)

# Suppressing values under 10

merged_diagnosisyear <- suppress_values(merged_diagnosisyear)


# Renaming other race/ethnicity

merged_diagnosisyear <- recode_race_eth(merged_diagnosisyear)

# Widening by Race/Ethnicity

merged_diagnosisyear_wider <- merged_diagnosisyear %>%
 mutate("95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Year of Diagnosis")

# Naming columns
desired_colnames <- name_columns(merged_diagnosisyear_wider)

# Creating gt table

gt_diagnosisyear <- create_gt_table(merged_diagnosisyear_wider)

```

```{r diagnosisyear_graph}

f_diagnosisyear <- ggplot(merged_diagnosisyear, aes(x = `Year of Diagnosis`, y = as.numeric(SMR), color = race_eth, fill = race_eth, group = race_eth)) +
  geom_line(size = 1.5) +
  jacc_theme() +
  geom_ribbon(aes(ymin = as.numeric(CI.Lower), ymax = as.numeric(CI.Upper), fill = race_eth), alpha = 0.1, color = NA) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 1.5) +  
  labs(
    x = "Year of Diagnosis",
    y = "SMR",
    color = "Race/Ethnicity",
    fill = "Race/Ethnicity") +
  scale_color_manual(values = c('#8AC926', '#FFCA3A', '#6A4C93', '#ff8fab', "#1982C4")) +
  scale_fill_manual(values = c('#8AC926', '#FFCA3A', '#6A4C93', '#ff8fab', "#1982C4")) +
  guides(
  #  color = guide_legend(nrow = 2),
  #  fill = guide_legend(nrow = 2)
    color = guide_legend(nrow = 1),
    fill = guide_legend(nrow = 1)
  ) +
  coord_cartesian(clip = "off") +
  scale_x_discrete(expand = c(0.001, 0.001)) +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
  text = element_text(size = 30, family = "Times New Roman"), 
  strip.text = element_text(angle = 0, size = 25), 
  legend.spacing.y = unit(3, "cm"),
  legend.box.margin = margin(0, -7, 0, -5),
  legend.key.height = unit(1.3, "cm"),  
  strip.background = element_rect(fill = NA, color = NA),
  axis.text = element_text(size = 30),  
  #plot.margin = margin(t = 20, r = 40, b = 20, l = 20),
  plot.margin = margin(t = 20, r = 60, b = 20, l = 20),
  axis.text.x = (element_text(angle = 45, vjust = 0.5)))

ggsave(file.path(base_path_cvd, "diagnosisyear_graph.png"), plot = f_diagnosisyear, width = 14, height = 10, dpi = 300,  bg = "white")


```

```{r grouped_diagnosisyear_table}

 pr_smr_g_diagnosisyear <- pr_smr_diagnosisyear %>%
  mutate(`Year of Diagnosis` = case_when(
    `Year of Diagnosis` >= 2004 & `Year of Diagnosis` <= 2009 ~ "2004-2009",
    `Year of Diagnosis` >= 2010 & `Year of Diagnosis` <= 2015 ~ "2010-2015",
    `Year of Diagnosis` >= 2016 & `Year of Diagnosis` <= 2019 ~ "2016-2019"
  )) %>%
  group_by(race_eth, `Year of Diagnosis`) %>%
  summarise(
    Observed = sum(Observed),
    Expected = sum(Expected),
    .groups = "drop"
  ) %>%
  mutate(SMR = Observed / Expected,
         CI.Lower = ifelse(
           Observed == 0, 0, 
           qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected)
         ),
         CI.Upper =  ifelse(
           Observed == 0, Inf, 
           qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))
         )

# US SMRs by Death Year
us_smr_g_diagnosisyear <- us_smr_diagnosisyear %>%
  mutate(`Year of Diagnosis` = case_when(
   `Year of Diagnosis` >= 2004 & `Year of Diagnosis` <= 2009 ~ "2004-2009",
    `Year of Diagnosis` >= 2010 & `Year of Diagnosis` <= 2015 ~ "2010-2015",
    `Year of Diagnosis` >= 2016 & `Year of Diagnosis` <= 2019 ~ "2016-2019"
  ),
  Observed = as.numeric(Observed),
  Expected = as.numeric(Expected)) %>%
  group_by(race_eth, `Year of Diagnosis`) %>%
   summarise(
    Observed = sum(Observed),
    Expected = sum(Expected),
    .groups = "drop") %>%
  mutate(SMR = Observed / Expected,
         CI.Lower = ifelse(
           Observed == 0, 0, 
           SMR * exp(-1.96 * sqrt(1 / Observed))
         ),
         CI.Upper =  ifelse(
           Observed == 0, Inf, 
           SMR * exp(1.96 * sqrt(1 / Observed)))) %>%
  arrange(race_eth, `Year of Diagnosis`)

# Merging PR and US by Diagnosis Year 

merged_g_diagnosisyear <- rbind(pr_smr_g_diagnosisyear, us_smr_g_diagnosisyear) %>%
  mutate(`Year of Diagnosis` = as.factor(`Year of Diagnosis`),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic", "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(race_eth)

# Suppressing values under 10

merged_g_diagnosisyear <- suppress_values(merged_g_diagnosisyear)


# Renaming other race/ethnicity

merged_g_diagnosisyear <- recode_race_eth(merged_g_diagnosisyear)

# Widening by Race/Ethnicity

merged_g_diagnosisyear_wider <- merged_g_diagnosisyear %>%
 mutate( across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 1), nsmall = 1)),
         "95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Year of Diagnosis")

# Naming columns
desired_colnames <- name_columns(merged_g_diagnosisyear_wider)

# Creating gt table

gt_g_diagnosisyear <- create_gt_table(merged_g_diagnosisyear_wider)

```

```{r grouped_diagnosisyear_graph}

f_g_diagnosisyear <- ggplot(merged_g_diagnosisyear, aes(y = fct_rev(`Year of Diagnosis`), x = as.numeric(SMR))) +
    geom_point(size = 0.5, position = position_dodge(width = 0.5), color = "royalblue4") +
    geom_errorbar(
        aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)), color = "royalblue4",
        width = 0.2, position = position_dodge(width = 0.5)) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +
  geom_text(aes(label = format(round(SMR, 2), nsmall = 2)), vjust = -0.8, size = 3) +
    facet_wrap(~ race_eth, ncol = 2) +
    jacc_theme() +
    labs(y = "Year of Diagnosis", x = "SMR") +
    theme(
        strip.background = element_rect(fill = NA, color = NA),
        legend.position = "none",
        panel.spacing = unit(0.5, "lines"))


ggsave(file.path(base_path_cvd, "g_deathyear.png"), plot = f_g_diagnosisyear, width = 10, height = 8, dpi = 300,  bg = "white")

```

```{r agegroup_diagnosis_table}

# PR SMRs by Age Group
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, AgeDxCat))

pr_smr_dx_agegroup <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = "AgeDxCat") %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic") %>%
  select(-c(pyrs, p_value)) %>%
  rename(`Age at Diagnosis` = AgeDxCat,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
     mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
    CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US Age Groups
us_smr_dx_agegroup <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_dx_agegroup.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_dx_agegroup.txt")
})) %>%
select(c(Age.at.Diagnosis.recode,
  Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  rename(`Age at Diagnosis` = Age.at.Diagnosis.recode, 
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected))
  
# Merging PR and US

merged_dx_agegroup <- rbind(pr_smr_dx_agegroup, us_smr_dx_agegroup) %>%
  mutate(across(c(race_eth, "Age at Diagnosis"), as.factor),
         Observed = as.numeric(Observed),
         across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 2), nsmall = 2)),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(race_eth)

# Supressing values under 10

merged_dx_agegroup <- suppress_values(merged_dx_agegroup)

# Renaming other race/ethnicity

merged_dx_agegroup <- recode_race_eth(merged_dx_agegroup)

# Merging US and PR by Age Group
merged_dx_agegroup_wider <- merged_dx_agegroup %>%
 mutate("95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Age Group")

# Setting column names
desired_colnames <- name_columns(merged_dx_agegroup_wider)

# Creating gt table
gt_dx_agegroup <- create_gt_table(merged_dx_agegroup_wider)

```

```{r agegroup_diagnosis_graph}

merged_dx_agegroup$`Age at Diagnosis` <- factor(merged_dx_agegroup$`Age at Diagnosis`,                                                  levels = rev(levels(factor(merged_dx_agegroup$`Age at Diagnosis`))))

f_dx_agegroup <- ggplot(merged_dx_agegroup, aes(y = `Age at Diagnosis`, x = as.numeric(SMR))) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 1) +
  geom_errorbar(aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)), color = "royalblue4",
                width = 0.3, linewidth = 1) +
  geom_point(size = 4, color = "royalblue4") +  
  geom_text(aes(label = sprintf("%.2f", as.numeric(SMR))), size = 5, vjust = -0.7, fontface = "plain") +
  facet_wrap(~ race_eth, scales = "free_x", ncol = 3) +
scale_x_continuous(breaks = scales::breaks_extended(n = 5), expand = expansion(mult = c(0.15, 0.1))) +
  xlab("SMR") +
  jacc_theme() +
  coord_cartesian(clip = "off") +
  theme(
  panel.spacing.x = unit(1, "cm"),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.spacing.y = unit(1.25, "cm"),
  text = element_text(size = 30, family = "Times New Roman"),
  strip.text = element_text(angle = 0, size = 25, lineheight = 0.7, face = "bold", margin = margin(b = 5)), 
  strip.background = element_rect(fill = NA, color = NA),
  axis.text = element_text(size = 20))

ggsave(file.path(base_path_cvd, "agegroup_diagnosis_graph.png"), plot = f_dx_agegroup, width = 10, height = 8, dpi = 300,  bg = "white")

```

```{r agegroup_death_table}

# PR SMRs by Age Group
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per))

pr_smr_agegroup <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = "agegroup") %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic",
         agegroup = case_when(
           agegroup == 0 ~ "18-39",
           agegroup == 80 ~ "80+",
           .default =  paste0(agegroup, "-", agegroup+9))) %>%
  select(-c(pyrs, p_value)) %>%
  rename("Age Group" = agegroup,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
     mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
    CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US Age Groups
us_smr_agegroup <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_agegroup.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_agegroup.txt")
  } )) %>%
select(c(Attained.Age,
  Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  filter(Attained.Age != "Total") %>%
  rename("Age Group" = Attained.Age, 
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected),
        `Age Group` = gsub("0-39", "18-39", `Age Group`))
  
# Merging PR and US

merged_deathyear_agegroup <- rbind(pr_smr_agegroup, us_smr_agegroup) %>%
  mutate(across(c(race_eth, "Age Group"), as.factor),
         Observed = as.numeric(Observed),
         across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 1), nsmall = 2)),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(race_eth)

# Supressing values under 10

merged_deathyear_agegroup <- suppress_values(merged_deathyear_agegroup)

# Renaming other race/ethnicity

merged_deathyear_agegroup <- recode_race_eth(merged_deathyear_agegroup)

# Merging US and PR by Age Group
merged_deathyear_agegroup_wider <- merged_deathyear_agegroup %>%
 mutate("95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  arrange("Age Group")

# Setting column names
desired_colnames <- name_columns(merged_deathyear_agegroup_wider)

# Creating gt table
gt_agegroup <- create_gt_table(merged_deathyear_agegroup_wider)

```

```{r agegroup_death_graph}

# Create the ggplot
f_agegroup <- ggplot(merged_deathyear_agegroup, aes(x = `race_eth`, y = as.numeric(`SMR`), fill = `race_eth`)) +
    geom_bar(stat = "identity") + 
    facet_wrap(~ `Age Group`, scales = "fixed") + 
    labs(
        x = "Age at Death",
        y = "SMR",
        fill = "Race/Ethnicity"
    ) +
    jacc_theme() +
    geom_text(aes(label = `SMR`), vjust = -0.5, size = 3) +  # Add SMR value above each bar
    theme(axis.text.x = element_blank(),
        strip.text = element_text(size = 10, face = "bold")) +
            scale_fill_manual(values = c('#4E86A7', '#6B9F88', '#F1C04A', '#F07F47', '#D08690', '#9E7DB4'),
                               labels = function(x) str_wrap(x, width = 25)) +
  scale_y_continuous(
        breaks = scales::pretty_breaks(n = 6), limits = c(0, 4))
  

ggsave(file.path(base_path_cvd, "agegroup_deathyear_graph.png"), plot = f_agegroup, width = 10, height = 8, dpi = 300,  bg = "white")



```

```{r stage_table}

# PR SMRs by Death Year
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, StageAtDx))

pr_smr_stage <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = "StageAtDx") %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic") %>%
  select(-c(pyrs, p_value)) %>%
  rename(Stage = StageAtDx,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
   mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
    CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US SMRs by Stage
us_smr_stage <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_stage.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_stage.txt")
  } )) %>%
select(c(Combined.Summary.Stage..2004..,
  Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  filter(Race.Ethnicity.CVD != "All races/ethnicities",
         !(Combined.Summary.Stage..2004.. %in% c("In situ", "N/A", "Blank(s)"))) %>%
  rename(Stage = Combined.Summary.Stage..2004.., 
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected))

# Merging PR and US by Death Year 

merged_stage <- rbind(pr_smr_stage, us_smr_stage) %>%
  mutate(across(c(race_eth, Stage), as.factor),
        # across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 1), nsmall = 1)),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders")),
         Stage = factor(Stage,
         levels = c("Localized", "Regional", "Distant", "Unknown/unstaged"))) %>%
  arrange(race_eth, Stage)

# Suppressing values under 10

merged_stage <- suppress_values(merged_stage)

# Renaming other race/ethnicity

merged_stage <- recode_race_eth(merged_stage)

# Suppressing values for Stage = Unknown/unstaged

merged_stage <- merged_stage %>%
    mutate(
      Expected = ifelse(Stage == "Unknown/unstaged", "-", Expected),
      SMR = ifelse(Stage == "Unknown/unstaged", "-", SMR),
      CI.Lower = ifelse(Stage == "Unknown/unstaged", "-", CI.Lower),
      CI.Upper =  ifelse(Stage == "Unknown/unstaged", "-", CI.Upper))

# Widening by Race/Ethnicity

merged_stage_wider <- merged_stage %>%
  mutate(across(c(Expected:CI.Upper), ~ ifelse(Stage != "Unknown/unstaged", format(round(as.numeric(.), 2), nsmall = 2), "-")),
         "95% CI" = ifelse(Expected != "-",
                           paste0("(", CI.Lower, " - ", CI.Upper, ")"), "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI"))




# Naming columns
desired_colnames <- name_columns(merged_stage_wider)

# Creating gt table

gt_stage <- create_gt_table(merged_stage_wider)

```

```{r stage_graph}

f_stage <- ggplot(merged_stage[merged_stage$Stage != "Unknown/unstaged",], aes(y = fct_rev(Stage), x = as.numeric(SMR))) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 1) +
  geom_point(size = 4, position = position_dodge(width = 0.5), color = "royalblue4") +
  geom_errorbar(aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)), color = "royalblue4",
                width = 0.3, linewidth = 1) +
  geom_text(aes(label = sprintf("%.2f", as.numeric(SMR))), vjust = -1.5, size = 6) +
  labs(y = "Stage at Diagnosis", x = "SMR") +
  facet_wrap(~ race_eth, scales = "free_x", ncol = 3) +
  scale_x_continuous(breaks = scales::breaks_extended(n = 5), expand = expansion(mult = c(0.15, 0.1))) +
  xlab("SMR") +
  jacc_theme() +
  coord_cartesian(clip = "off") +
  theme(
    panel.spacing.x = unit(1, "cm"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing.y = unit(1.25, "cm"),
    text = element_text(size = 30, family = "Times New Roman"),
    strip.text = element_text(angle = 0, size = 25, face = "bold", lineheight = 0.7, margin = margin(b = 5)), 
    strip.background = element_rect(fill = NA, color = NA),
    axis.text = element_text(size = 20))

ggsave(file.path(base_path_cvd, "us_stage_graph.png"), plot = f_stage, width = 11.5, height = 10, dpi = 300,  bg = "white")

```

```{r treatment_table}

# PR SMRs by Death Year
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, Procedure))

pr_smr_procedure <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = "Procedure") %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic") %>%
  select(-c(pyrs, p_value)) %>%
  rename(Treatment = Procedure,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
   mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
    CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US SMRs by Procedure
us_smr_procedure <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_procedure.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_procedure.txt")
  } ))  %>%
select(c(Merged.Procedures,
  Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  filter(Race.Ethnicity.CVD != "All races/ethnicities") %>%
  rename(Treatment = Merged.Procedures,
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth) %>%
  mutate(SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected),
         Treatment = gsub("\\[OTHER\\]", "Other", Treatment, ignore.case = FALSE))

# Merging PR and US by Death Year 

merged_procedure <- rbind(pr_smr_procedure, us_smr_procedure) %>%
  mutate(across(c(race_eth, Treatment), as.factor),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders")),
         Treatment = factor(Treatment,
                               levels = c("Surgery Only", "Chemotherapy Only",
                                          "Radiotherapy Only", "Chemotherapy and Radiotherapy",
                                          "Other"))) %>%
  arrange(race_eth, Treatment)

# Suppressing values under 10

merged_procedure <- suppress_values(merged_procedure)

# Renaming other race/ethnicity

merged_procedure <- recode_race_eth(merged_procedure)

# Widening by Race/Ethnicity

merged_procedure_wider <- merged_procedure %>%
 mutate(across(c(Expected:CI.Upper), ~ format(round(as.numeric(.), 2), nsmall = 2)),
                 "95% CI" = ifelse(Observed != "<10",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI"))

# Naming columns
desired_colnames <- name_columns(merged_procedure_wider)

# Creating gt table

gt_procedure <- create_gt_table(merged_procedure_wider)

```

```{r treatment_graph}
                             
f_treatment <- ggplot(merged_procedure, aes(
  y = fct_rev(Treatment), 
  x = as.numeric(SMR))) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 1) +
   geom_point(size = 4, color = "royalblue4") +  
    geom_errorbar(aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)), color = "royalblue4",
                  width = 0.3, linewidth = 1) +
  geom_text(aes(label = format(round(as.numeric(`SMR`), 2), nsmall = 2)), vjust = -0.8, size = 7) +
 scale_y_discrete(labels = c(
   "Surgery Only" = "Surgery Only",
   "Chemotherapy Only" = "Chemotherapy Only",
   "Radiotherapy Only" = "Radiotherapy Only",
   "Chemotherapy and Radiotherapy" = "Chemotherapy and\n Radiotherapy",
   "Other" = "Other")) +
  facet_wrap(~ race_eth, scales = "free_x", ncol = 3) +
  scale_x_continuous(breaks = scales::breaks_extended(n = 5), expand = expansion(mult = c(0.15, 0.1))) +
  xlab("SMR") +
  ylab("Initial Treatment") +
  jacc_theme() +
  coord_cartesian(clip = "off") +
  theme(
    panel.spacing.x = unit(1, "cm"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.spacing.y = unit(1.25, "cm"),
    text = element_text(size = 30, family = "Times New Roman"),
    strip.text = element_text(angle = 0, size = 25, lineheight = 0.7, family = "Times New Roman", face = "bold", margin = margin(b = 5)), 
    strip.background = element_rect(fill = NA, color = NA),
    axis.text = element_text(size = 20))

ggsave(file.path(base_path_cvd, "us_treatment_graph.png"), plot = f_treatment, width = 11.5, height = 10, dpi = 300,  bg = "white")

```

```{r proc_stage_table, results='asis'}

# PR SMRs - Numerator
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per, Procedure = Procedure, StageAtDx))

# PR SMRs by Procedure and Stage

pr_smr_proc_stage <- sir(coh.data = c, coh.obs = 'from0to1', 
                  coh.pyrs = 'pyrs', 
                  ref.data = us_reference, 
                  ref.rate = 'gen_cvd_rate', 
                  adjust = c('deathyear', 'agegroup'), 
                  test.type = "homogeneity",
                  conf.type = "univariate",
                  conf.level = 0.95, print = list(Procedure, StageAtDx)) %>%
  as_tibble() %>%
  mutate(race_eth = "PR Hispanic",
         StageAtDx = ifelse(StageAtDx == "Unstaged", "Unknown/unstaged", StageAtDx)) %>%
  select(-c(pyrs, p_value)) %>%
  rename(Stage = StageAtDx,
         Observed = observed,
         Expected = expected,
         SMR = sir,
        CI.Lower = sir.lo,
        CI.Upper = sir.hi) %>%
   mutate(CI.Lower = qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected),
    CI.Upper = qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))  %>% 
  relocate(race_eth)

# US SMRs by Procedure and Stage

us_smr_proc_stage <- suppressWarnings(tryCatch({
  read.delim("~/Downloads/Statistical Analysis/Inputs/smr_procedure_stage.txt")
}, error = function(e) {
read.delim("C:/Users/lcastro/OneDrive - Centro Comprensivo de Cancer UPR/projects_shared/BBC/Project_Dra. Carola/Data/Inputs/smr_procedure_stage.txt")
  } )) %>%
  filter(!(Combined.Summary.Stage..2004.. %in% c("In situ", "Blank(s)", "N/A")),
         Race.Ethnicity.CVD != "All races/ethnicities") %>%
select(c(Merged.Procedures, Combined.Summary.Stage..2004.., Race.Ethnicity.CVD, 
         Observed, Expected, O.E, CI.Lower, CI.Upper)) %>%
  rename(Procedure = Merged.Procedures, 
         Stage = Combined.Summary.Stage..2004.., 
         race_eth = Race.Ethnicity.CVD,
         SMR = O.E) %>% 
  relocate(race_eth, Procedure) %>%
  mutate(Procedure = ifelse(Procedure == "[OTHER]", "Other", Procedure),
         SMR = gsub("#", "", SMR),
         Observed = gsub(",", "", Observed),
         Expected = gsub(",", "", Expected),
         race_eth = gsub("Asian American, Native Hawaiian and other Pacific Islanders", "AANHPI & AIAN", race_eth))
  
# US and PR Procedure and Stage

merged_proc_stage <- rbind(pr_smr_proc_stage, us_smr_proc_stage) %>%
    mutate(Procedure = factor(Procedure,
                               levels = c("Surgery Only", "Chemotherapy Only",
                                          "Radiotherapy Only", "Chemotherapy and Radiotherapy",
                                          "Other")),
         Stage = factor(Stage, levels = c("Localized", "Regional", "Distant", "Unknown/unstaged")),
         race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "AANHPI & AIAN"))) %>%
  arrange(race_eth)

# Supressing values under 10

merged_proc_stage <- suppress_values(merged_proc_stage)

# Suppressing values for Stage = Unknown/unstaged

merged_proc_stage <- merged_proc_stage %>%
    mutate(
      Expected = ifelse(Procedure == "Other", "-", Expected),
      SMR = ifelse(Procedure == "Other", "-", SMR),
      CI.Lower = ifelse(Procedure == "Other", "-", CI.Lower),
      CI.Upper =  ifelse(Procedure == "Other", "-", CI.Upper))

# Widen table based on Race/Ethnicity

merged_proc_stage_wider <- merged_proc_stage %>%
 mutate("95% CI" = ifelse(Expected != "-",
         paste0("(", CI.Lower, " - ", CI.Upper, ")"),
         "-")) %>%
  select(-c(CI.Lower, CI.Upper)) %>%
  filter(Stage != "Unknown/unstaged") %>%
  pivot_wider(names_from = c(race_eth), values_from = c(Observed, Expected, SMR, "95% CI")) |> 
  mutate(Procedure = factor(Procedure,
                               levels = c("Surgery Only", "Chemotherapy Only",
                                          "Radiotherapy Only", "Chemotherapy and Radiotherapy",
                                          "Other")),
         Stage = factor(Stage, levels = c("Localized", "Regional", "Distant"))) |>
  arrange(Procedure, Stage)

# Column titles
desired_colnames <- name_columns(merged_proc_stage_wider)

# Creating gt table
gt_proc_stage <- create_gt_table(merged_proc_stage_wider, groupname_col = "Procedure")

```

```{r proc_stage_figure}

merged_proc_stage2 <- merged_proc_stage %>%
  filter(Stage != "Unknown/unstaged") %>%
  mutate(race_eth = case_when(
    race_eth == "Asian American, Native Hawaiian and other Pacific Islanders" ~ "Asian American,\nNative Hawaiian,\nand other Pacific Islanders",
    TRUE ~ race_eth),
    race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic",
               "White", "Black", "AANHPI & AIAN")),
     Procedure = str_wrap(Procedure, width = 15))

f_proc_stage <- ggplot(merged_proc_stage2[merged_proc_stage2$Procedure != "Other", ], aes(y = Stage, x = as.numeric(SMR))) +
    geom_point(size = 0.5, position = position_dodge(width = 0.5), color = "royalblue4") +
    geom_errorbar(color = "royalblue4",
        aes(xmin = as.numeric(CI.Lower), xmax = as.numeric(CI.Upper)),
        width = 0.2, position = position_dodge(width = 0.5)
    ) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +
    facet_grid(Procedure ~ race_eth, scales = "fixed", space = "fixed", switch = "y") +
   geom_text(aes(label = round(as.numeric(SMR), 2)), 
            vjust = -1.7, size = 3, fontface = "bold", color = "grey30") +
  jacc_theme() +
    labs(y = "", x = "SMR") +
    theme(
      #  text = element_text(size = 7), 
        strip.text.y = element_text(angle = 0, face = "bold"), #size = 6), 
       # strip.text.x = element_text(size = 6), 
        strip.background = element_rect(fill = NA, color = NA),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(hjust = 1),  
       # axis.text.y = element_text(size = 6), 
        legend.position = "none",
        panel.spacing.x = unit(1, "lines"),
        panel.spacing.y = unit(1, "lines"),
        panel.grid = element_blank()) +
  scale_x_continuous(limits = c(-5,10), breaks = c(-5, 1, 5.0, 10))

ggsave(file.path(base_path_cvd, "proc_stage_graph.png"), plot = f_proc_stage, width = 8, height = 6.5, dpi = 500,  bg = "white")

```

```{r smr_table1}

table1_general <- merged_general_wider %>%
  mutate(Variable = "Overall") %>%
         #across(starts_with("Observed_"), ~ round(as.numeric(.x), 0))) %>%
  relocate(Variable)

table1_agegroup <- merged_deathyear_agegroup_wider %>%
  rename(Variable = `Age Group`) %>%
  bind_rows(tibble(Variable = "Age at Death"),.) %>%
  relocate(Variable)

 table1_dx_agegroup <- merged_dx_agegroup_wider %>%
  rename(Variable = `Age at Diagnosis`) %>%
  bind_rows(tibble(Variable = "Age at Diagnosis"),.) %>%
  relocate(Variable)
 
 table1_stage <- merged_stage_wider %>%
  rename(Variable = Stage) %>%
  bind_rows(tibble(Variable = "Stage"),.) %>%
  relocate(Variable)
 
 table1_procedure <- merged_procedure_wider %>%
  rename(Variable = Treatment) %>%
  bind_rows(tibble(Variable = "Treatment"),.) %>%
  relocate(Variable)
 
 table1_g_deathyear <- merged_g_deathyear_wider %>%
  rename(Variable = `Year of Death`) %>%
  bind_rows(tibble(Variable = "Year of Death"),.) %>%
  relocate(Variable)

 table1_g_diagnosisyear <- merged_g_diagnosisyear_wider %>%
  rename(Variable = `Year of Diagnosis`) %>%
  bind_rows(tibble(Variable = "Year of Diagnosis"),.) %>%
  relocate(Variable)
 
combined_table <- rbind(table1_general, table1_dx_agegroup, table1_stage, table1_procedure, table1_g_diagnosisyear, table1_g_deathyear) %>%
    mutate(has_na = apply(., 1, function(row) any(is.na(row))), # Rows to make bold
           across(everything(), ~ ifelse(is.na(.), "", .))) # Make NAs Blank
 
desired_colnames <- name_columns(combined_table)

gt_smr_table1 <- combined_table %>%
   create_gt_table() %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(rows = has_na)) %>%
  cols_hide(columns = has_na)

```

```{r cohort_cumulative_mortality}

cancer_plot_data <- cancer_observed %>%
  mutate(Cohort = case_when(
    year(DiagnosisDate) >= 2004 & year(DiagnosisDate) <= 2009 ~ "2004â2009",
    year(DiagnosisDate) >= 2010 & year(DiagnosisDate) <= 2014 ~ "2010â2014",
    year(DiagnosisDate) >= 2015 & year(DiagnosisDate) <= 2019 ~ "2015â2019"
  )) %>%
  filter(!is.na(Cohort), !is.na(Procedure), !is.na(lagTime), !is.na(status)) %>%
  mutate(
    Cohort = factor(Cohort, levels = c("2004â2009", "2010â2014", "2015â2019")),
    Procedure = factor(Procedure, levels = c("Surgery Only","Chemotherapy Only","Radiotherapy Only",            
                                             "Chemotherapy and Radiotherapy", "Other")))

# Fit survival model
fit <- survfit(Surv(lagTime, status) ~ Cohort + Procedure, data = cancer_plot_data)
cuminc <- broom::tidy(fit) %>%
  mutate(
    cuminc = 1 - estimate,
    Cohort = str_extract(strata, "Cohort=\\s*[^,]+") %>% str_remove("Cohort=") %>% str_trim(),
    Procedure = str_extract(strata, "Procedure=.+") %>% str_remove("Procedure=") %>% str_trim(),
    Procedure = factor(Procedure, levels = c("Surgery Only","Chemotherapy Only","Radiotherapy Only",            
                                             "Chemotherapy and Radiotherapy", "Other"))
  )

# In color
ggplot(cuminc, aes(x = time, y = cuminc, color = Cohort)) +
  geom_smooth(se = FALSE, method = "loess", span = 0.3, size = 0.5) +
  facet_wrap(~ Procedure, ncol = 2) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = "Years Since Diagnosis",
    y = "Cumulative CVD Mortality",
    color = "Diagnosis Cohort"
  ) +
  jacc_theme() +
  theme(legend.position = "bottom")

# Black and white
ggplot(cuminc, aes(x = time, y = cuminc, linetype = Cohort)) +
  geom_line(size = 0.5, color = "black") +  # black lines with different styles
  facet_wrap(~ Procedure, ncol = 2) +
  scale_linetype_manual(
    values = c("2004â2009" = "dotted", "2010â2014" = "dashed", "2015â2019" = "solid")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(n.breaks = 10) +
  labs(
    x = "Years Since Diagnosis",
    y = "Cumulative CVD Mortality",
    linetype = "Diagnosis Cohort"
  ) +
  jacc_theme() +
  theme(legend.position = "bottom")

```

```{r cumulative_mortality}
# cuminc_fit <- cuminc(FollowUpYears, fstatus = cvdStatus, group = cancer_observed)

# km_fit <- survfit(Surv(FollowUpYears, cvdStatus) ~ 1, data = cancer_observed)
# km_fit_2 <- survfit(Surv(FollowUpYears, cvdStatus) ~ Race.Ethnicity.CVD, data = us_sir_general_cl_df)
# 
# # Define time points
# time_points <- c(1, 5, 10)
# 
# # Function to extract Kaplan-Meier estimates
# extract_km <- function(km_fit, race_ethnicity) {
#   summary_km <- summary(km_fit, times = time_points)
#   data.frame(
#     Time = summary_km$time,
#     Cumulative_Mortality = round((1 - summary_km$surv) * 100,2),  # Convert to %
#     Lower_CI = (1 - summary_km$upper) * 100,  # Invert CI
#     Upper_CI = (1 - summary_km$lower) * 100,
#     Race_Ethnicity = race_ethnicity
#   ) %>%
#     mutate(Cumulative_Mortality = sprintf("%.2f%% (%.2f%% to %.2f%%)", Cumulative_Mortality, Lower_CI, Upper_CI))
# }
# 
# # Extract estimates for PR and US racial/ethnic groups
# pr_df <- extract_km(km_fit, "PR Hispanic")
# us_df <- extract_km(km_fit_2, rep(c("AANHPI & AIAN", "Black", "US Hispanic", "White"), each = length(time_points)))
# 
# # Combine and reshape data
# final_table <- bind_rows(pr_df, us_df) %>%
#   select(Race_Ethnicity, Time, Cumulative_Mortality) %>%
#   pivot_wider(names_from = Time, values_from = Cumulative_Mortality, names_prefix = "Year_") %>%
#   rename(
#     `1-year CM (95% CI)` = Year_1,
#     `5-year CM (95% CI)` = Year_5,
#     `10-year CM (95% CI)` = Year_10) %>%
#   mutate(Race_Ethnicity = factor(Race_Ethnicity, levels = c("PR Hispanic", "US Hispanic", "White", "Black", "AANHPI & AIAN"))) %>%
#   arrange(Race_Ethnicity) 
# 
# # Generate gt table
# km_table <- final_table %>%
#   gt(rowname_col = "Race_Ethnicity") %>%
#   tab_header(
#     title = "CVD Cumulative Mortality (CM) and 95% Confidence Intervals",
#     subtitle = "By Race/Ethnicity"
#   ) %>%
#   cols_label(
#     `1-year CM (95% CI)` = "1-year CM (95% CI)",
#     `5-year CM (95% CI)` = "5-year CM (95% CI)",
#     `10-year CM (95% CI)` = "10-year CM (95% CI)"
#   ) %>%
#   tab_options(
#     table.font.size = px(14),
#     column_labels.font.weight = "bold",
#     heading.title.font.size = px(18),
#     heading.subtitle.font.size = px(14),
#     table.border.top.color = "black",
#     table.border.bottom.color = "black"
#   ) %>%
#   tab_style(
#     style = cell_text(weight = "bold"),
#     locations = cells_row_groups()
#   ); km_table

# library(cmprsk)
# cancer_observed$status2 <- case_when(cancer_observed$Vital == "Alive" ~ 0,
#                                 cancer_observed$Vital == "CVD death" ~ 1,
#                                 TRUE ~ 2)
# cm_fit <- crr(cancer_observed$FollowUpYears, cancer_observed$status2, cov1 = cancer_observed[, c("AgeDxCat2", "StageAtDx2", "yearDiagCat2")])
# 
# cuminc(ftime = cancer_observed$FollowUpYears, 
#        fstatus = cancer_observed$status2, 
#        group = cancer_observed$AgeDxCat2)

```

```{r quality_control, include = FALSE}

# Verifying categorization is donde correctly in grid for rates

# SIR Function's
  
c <- lexpand(cancer_observed, status = cvdStatus != 0, 
             birth = birth_date,
             entry = FollowUpStart, # Without those that did not meet follow-up
             exit = FollowUpEnd, 
             breaks = list(per = 2004:2022, age = c(0, 40, 50, 60, 70, 80, Inf)),
             aggre = list(agegroup = age, deathyear = per))

t1 <- c %>% arrange(deathyear, agegroup)

# Manually calculated with wrangling_cancer_registry_patients.Rmd

t2 <- read.csv("~/Downloads/Registro Central de Cancer/cvm_by_year_agegroup2.csv") %>%
  filter(AgeGroup2 != "All ages") %>%
  mutate(AgeGroup2 = as.numeric(substr(AgeGroup2, 1, 2)),
         Year = as.numeric(Year),
         cvd_deaths_BC = ifelse(is.na(cvd_deaths_BC), 0, cvd_deaths_BC)) %>%
  rename(agegroup = AgeGroup2, 
         deathyear = Year)

# Merging

merged_data <- t1 %>%
  left_join(t2, by = c("agegroup", "deathyear")) %>%
  select(-c(from0to0, at.risk, cvd_rate)) %>%
  relocate(PersonYears, .before = pyrs) %>%
  mutate(across(cvd_deaths_BC, ~ replace_na(., 0))) %>%
  bind_rows(summarise(., across(where(is.numeric), sum, na.rm = TRUE))) 

# 2. Checking n for each race/ethnicity is consistent across variables

sum_observed_columns(merged_general_wider)
sum_observed_columns(merged_deathyear_wider)
sum_observed_columns(merged_g_deathyear_wider)
sum_observed_columns(merged_diagnosisyear_wider)
sum_observed_columns(merged_dx_agegroup_wider)
sum_observed_columns(merged_stage_wider)
sum_observed_columns(merged_procedure_wider)

# Race/Ethnicity percentages
rbind(pr_sir_general, us_sir_general) %>% group_by(race_eth) %>% summarise(n = sum(Count)) %>% mutate(perc = n/sum(n)*100)

# Follow-up time
bind_rows(
  us_sir_general_cl_df %>%
    mutate(FollowUpYears = ifelse(FollowUpYears < 0, 0, FollowUpYears)) %>%
    group_by(Race.Ethnicity.CVD) %>%
    summarize(
      Min. = min(FollowUpYears, na.rm = TRUE),
      `1st Qu.` = quantile(FollowUpYears, 0.25, na.rm = TRUE),
      Median = median(FollowUpYears, na.rm = TRUE),
      Mean = mean(FollowUpYears, na.rm = TRUE),
      `3rd Qu.` = quantile(FollowUpYears, 0.75, na.rm = TRUE),
      Max. = max(FollowUpYears, na.rm = TRUE)
    ),
  cancer_observed %>%
    summarize(
      Race.Ethnicity.CVD = "PR Hispanic",
      Min. = min(FollowUpYears, na.rm = TRUE),
      `1st Qu.` = quantile(FollowUpYears, 0.25, na.rm = TRUE),
      Median = median(FollowUpYears, na.rm = TRUE),
      Mean = mean(FollowUpYears, na.rm = TRUE),
      `3rd Qu.` = quantile(FollowUpYears, 0.75, na.rm = TRUE),
      Max. = max(FollowUpYears, na.rm = TRUE)
    )) %>%
  mutate(Race.Ethnicity.CVD = factor(Race.Ethnicity.CVD, levels = c("PR Hispanic", "US Hispanic",
                                                "White", "Black", "Asian American, Native Hawaiian and other Pacific Islanders"))) %>%
  arrange(Race.Ethnicity.CVD)


# Year of diagnosis
us_sir_general_cl_df %>% count(Year.of.diagnosis) %>% 
  mutate(perc = n/sum(n)*100)
cancer_observed %>% count(ydiag) %>% 
  mutate(perc = n/sum(n)*100)

# Year of death
us_sir_general_cl_df %>% 
  count(Year.of.death.recode) %>% 
  mutate(perc = n/sum(n)*100)
cancer_observed %>%
  mutate(Year.of.death.recode = ifelse(FollowUpEnd == as.Date("2021-12-31") | Vital == "Alive", 
                                       "Alive at last contact", 
                                       as.character(year(FollowUpEnd)))) %>%
  count(Year.of.death.recode) %>% 
  mutate(perc = n/sum(n)*100)


# Vital status
us_sir_general_cl_df %>% count(Cause.of.Death.CVD.recode) %>% mutate(perc = n/sum(n))
cancer_observed %>% mutate(Vital = as.character(Vital),
    Vital = case_when(
      Vital == "CVD death" ~ "CVD Death",
      Vital == "BC death" ~ "Other Causes of Death",
      Vital == "Other Death" ~ "Other Causes of Death",
      TRUE ~ Vital)) %>%
  count(Vital) %>% 
  mutate(perc = n/sum(n))

# Percentage of deaths by race/ethnicity

merged_general %>% mutate(Observed = as.numeric(gsub(",", "", Observed)), Percentage_Deaths = Observed/sum(Observed)* 100)

# Mean age at diagnosis

summary(cancer_observed$AgeDx)
summary(cancer_observed$FollowUpYears)

tblFun <- function(x){
    tbl <- table(x)
    res <- cbind(tbl,round(prop.table(tbl)*100,1))
    colnames(res) <- c('Count','Percentage')
    res
}
tblFun(cancer_observed$Procedure)
tblFun(cancer_observed$StageAtDx)
tblFun(cancer_observed$yearDiagCat)
tblFun(cancer_observed$deathYearCat)
tblFun(cancer_observed$Vital)

# Number of deaths
sum(cancer_observed$Vital != "Alive")

# Proportion of CVD deaths
round(sum(cancer_observed$Vital == "CVD death") / sum(cancer_observed$Vital != "Alive") * 100, 2)

```

```{r outline, cache = FALSE, results = 'asis'}

# Flow diagram
f <- 0
#cat(paste("\n\n Figure", f + 1, "  Flow diagram defining selection of women diagnosed with first breast cancer between 2004-2019 and followed through 2021 in PR and 17 SEER registries. \n"))
#f <- f + 1

#image_read("~/Downloads/Statistical Analysis/Outputs/Figures/Flowchart.png")

#cat("\n\n\\pagebreak\n")

# PR Table 1
t <- 0
cat(paste("\n Table", t + 1, " Baseline Characteristics of women who died in Puerto Rico diagnosed with Breast Cancer from 2004-2019 and followed through 2021\n"))
t <- t + 1

gt_pr_table1

cat("\n\n\\pagebreak\n")

cat("\n## CVD SMR for PR BC Survivors with PR Population as Referent\n")

gt_pr_general
cat(paste("\n(To be put in text)\n"))

# PR SMR by deathyear
#cat(paste("\n Table", t + 1, " CVD SMRs by Year of Death for BC Survivors in Puerto Rico Using PR Population as Referent\n"))
#t <- t + 1

#smr_deathyear %>% gt()

# PR SMRs by year of death figure
#cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Death for BC survivors in Puerto Rico Using PR population as Referent\n"))
#f <- f + 1

#f_prdeathyear

#cat("\n\n\\pagebreak\n")

# PR SMR by deathyear
#cat(paste("\n Table", t + 1, " CVD SMRs by Year of Death for BC Survivors in Puerto Rico Using PR Population as Referent\n"))
#t <- t + 1

#smr_deathYearCat %>% gt()


# PR SMRs by year of death figure
#cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Death for BC survivors in Puerto Rico Using PR population as Referent\n"))
#f <- f + 1

#f_deathYearCat

cat("\n\n\\pagebreak\n")

# PR SMR by diagnosis year
cat(paste("\n Table", t + 1, " CVD SMRs by Year of Diagnosis for BC Survivors in Puerto Rico\n"))
t <- t + 1
smr_ydiag %>% gt()

cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))

# PR SMRs by year of diagnosis figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Diagnosis for BC survivors in Puerto Rico\n"))
f <- f + 1

f_ydiag
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))

# PR SMRs by year of diagnosis figure
cat(paste("\n V2: Figure", f + 1, " CVD SMRs by Year of Diagnosis for BC survivors in Puerto Rico\n"))
f <- f + 1

f_ydiag2
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))

cat("\n\n\\pagebreak\n")

# PR SMR by diagnosis year
cat(paste("\n Table", t + 1, " CVD SMRs by Year of Diagnosis for BC Survivors in Puerto Rico\n"))
t <- t + 1

smr_diagCat %>% gt()
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# PR SMRs by year of diagnosis figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Diagnosis for BC survivors in Puerto Rico\n"))
f <- f + 1

f_ydiagcat
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# PR SMR by agegroup
cat(paste("\n Table", t + 1, " CVD SMRs by Age at Diagnosis for BC Survivors in Puerto Rico\n"))
t <- t + 1

smr_agegroup %>% gt()
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))


# PR SMRs by agegroup figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Age at Diagnosis for BC survivors in Puerto Rico\n"))
f <- f + 1

f_pragegroup
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# PR SMR by treatment
cat(paste("\n Table", t + 1, " CVD SMRs by Initial Treatment for BC Survivors in Puerto Rico\n"))
t <- t + 1

smr_treatment %>% gt()
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))

# PR SMRs by treatment figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Initial Treatment for BC survivors in Puerto Rico\n"))
f <- f + 1

f_prtreatment
cat(paste("\n The SMRs were calculated using Puerto Rico as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# Overall SMR
cat(paste("\n Table", t + 1, " CVD SMRs for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1

gt_general
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))

# Overall SMR figure
cat(paste("\n Figure", f + 1, " CVD SMRs for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1
f_general
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))

cat("\n\n\\pagebreak\n")

# SMRs by year of death
#cat(paste("\n Table", t + 1, " CVD SMRs by Year of Death for BC Survivors in PR Hispanic and US Race/Ethnicity Groups Using US population as Referent\n"))
#t <- t + 1

#gt_deathyear

#cat("\n\n\\pagebreak\n")

# SMRs by year of death figure
#cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Death for BC survivors in PR Hispanic and US Race/Ethnicity Groups Using US population as Referent\n"))
#f <- f + 1

#f_deathyear

#cat("\n\n\\pagebreak\n")

# SMRs by grouped year of death
#cat(paste("\n Table", t + 1, " CVD SMRs by Year of Death for BC Survivors in PR Hispanic and US Race/Ethnicity Groups Using US population as Referent\n"))
#t <- t + 1

#gt_g_deathyear

#cat("\n\n\\pagebreak\n")

# SMRs by grouped year of death figure

#cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Death for BC survivors in PR Hispanic and US Race/Ethnicity Groups Using US population as Referent\n"))
#f <- f + 1
#f_g_deathyear

#cat("\n\n\\pagebreak\n")

# SMRs by year of diagnosis
cat(paste("\n Table", t + 1, " CVD SMRs by Year of Diagnosis for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1

gt_diagnosisyear
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))

cat("\n\n\\pagebreak\n")

# SMRs by year of diagnosis figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Diagnosis for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1

f_diagnosisyear
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by grouped year of diagnosis

cat(paste("\n Table", t + 1, " CVD SMRs by Year of Diagnosis for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1

gt_g_diagnosisyear
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))

cat("\n\n\\pagebreak\n")

# SMRs by grouped year of diagnosis figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Year of Diagnosis for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1

f_g_diagnosisyear
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))

cat("\n\n\\pagebreak\n")

# SMRs by age at diagnosis
cat(paste("\n Table", t + 1, " CVD SMRs by Age at Diagnosis for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1
gt_dx_agegroup
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by age at diagnosis figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Age at Diagnosis for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1
f_dx_agegroup
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by age at death
#cat(paste("\n Table", t + 1, " CVD SMRs by Age at Death for BC Survivors in PR Hispanic and US Race/Ethnicity Groups Using US population as Referent\n"))
#t <- t + 1
#gt_agegroup

#cat("\n\n\\pagebreak\n")

# SMRs by age at death figure
#cat(paste("\n Figure", f + 1, " CVD SMRs by Age at Death for BC survivors in PR Hispanic and US Race/Ethnicity Groups Using US population as Referent\n"))
#f <- f + 1
#f_agegroup

cat("\n\n\\pagebreak\n")

# SMRs by stage
cat(paste("\n Table", t + 1, " CVD SMRs by Stage at Diagnosis for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1
gt_stage
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by stage figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Stage at Diagnosis for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1
f_stage
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by initial treatment
cat(paste("\n Table", t + 1, " CVD SMRs by Initial Treatment for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1
gt_procedure
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by initial treatment figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Initial Treatment for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1
f_treatment

cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by treatment and stage
cat(paste("\n Table", t + 1, " CVD SMRs by Stage and Treatment for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1
gt_proc_stage
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs by treatment and stage figure
cat(paste("\n Figure", f + 1, " CVD SMRs by Stage and Treatment for BC survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
f <- f + 1
f_proc_stage
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))
cat("\n\n\\pagebreak\n")

# SMRs Table 1
cat(paste("\n Table", t + 1, " CVD SMRs for BC Survivors in PR Hispanic and US Race/Ethnicity Groups\n"))
t <- t + 1
gt_smr_table1
cat(paste("\n The SMRs were calculated using the United States, stratified by race and ethnicity, as the referent population.\n"))


cat(paste("\n Table", t + 1, " Population counts for PR Registry and SEER Registries"))

rbind(pr_sir_general, us_sir_general) %>%
  mutate(race_eth = factor(race_eth, levels = c("PR Hispanic", "US Hispanic", "White", "Black", "AANHPI & AIAN"))) %>%
  group_by(race_eth) %>%
  summarise(survivors = sum(Count, na.rm = TRUE),
            cvd_deaths = sum(Count[`Cause of Death` == "CVD Death"], na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(percentage = survivors / sum(survivors) * 100) %>%
  add_row(race_eth = "Total", survivors = sum(.$survivors), cvd_deaths = sum(.$cvd_deaths), percentage = 100)


# Median follow-up time

round(summary(cancer_observed$FollowUpYears), 2)
round(summary(cancer_observed[cancer_observed$Vital == "CVD death", ]$FollowUpYears), 2)

us_sir_general_cl_df %>% group_by(Race.Ethnicity.CVD) %>% 
    summarise(
        Median = median(FollowUpYears, na.rm = TRUE),
        iqr = paste0(quantile(FollowUpYears, 0.25, na.rm = TRUE), " - ", quantile(FollowUpYears, 0.75, na.rm = TRUE)),
        .groups = "drop")

us_sir_general_cl_df %>% 
  filter(Cause.of.Death.CVD.recode == "CVD") %>%
  group_by(Race.Ethnicity.CVD) %>% 
    summarise(
        Median = round(median(FollowUpYears, na.rm = TRUE), 2),
        iqr = paste0(round(quantile(FollowUpYears, 0.25, na.rm = TRUE), 2), 
        " - ", 
        round(quantile(FollowUpYears, 0.75, na.rm = TRUE),2)),
        .groups = "drop")

```

# Details

Figure legends should be an in-depth explanation of each figure, including a figure TITLE, and a CAPTION that includes the purpose of the figure, and brief method, results, and discussion statements pertaining to the figure. All abbreviations used in the figure should be identified either after their first mention in the legend or in alphabetical order at the end of each legend. All symbols used (arrows, circles, etc.) must be explained. Target length should be 50-100 words per figure.

Graphics software, such as Photoshop and Illustrator, should be used to create the art, but not presentation software such as PowerPoint, CorelDraw, or Harvard Graphics. Line art (black and white or color) and combinations of gray scale images and line art should be at least 1200 DPI. Lettering should be of sufficient size to be legible after reduction for publication. The optimal size is 12 points. Symbols should be of a similar size. Figures should be no smaller than 13 cm Ã 18 cm (500 Ã 700). Decimals, lines, and other details must be strong enough for reproduction. Use only black and whiteânot grayâin charts and graphs. Place crop marks on photomicrographs to show only the essential field. Designate special features with arrows. All symbols, arrows, and lettering on half-tone illustrations must contrast with the background. There is no fee for the publication of color figures. Our editors encourage authors to submit figures in color, as we feel it improves the clarity and visual impact of the images.

*	Your Central Illustration, if not an existing figure, should be listed first.

*	If the figure has been previously published, cite the figure source in the legend.

```{r forest_plots, include = FALSE}

# forest_format <- function(race_eth_select, ...) {
#   # List all input dataframes
#   dfs <- list(...)
#   
#   # Apply the transformation to each dataframe
#   result <- dfs %>%
#     lapply(function(df) {
#       # Filter the dataframe by the specified race_eth value, rename columns, and apply formatting to Observed
#       df %>%
#         filter(race_eth == race_eth_select) %>%
#         rename(Variable = names(df)[2]) %>%
#         mutate(Variable = paste("    ", Variable)) %>%
#         mutate(Observed = format(round(as.numeric(gsub(",", "", Observed)), 1), nsmall = 1)) %>%
#         bind_rows(
#           tibble(race_eth = NA, Variable = names(df)[2], Observed = NA, Expected = NA, SMR = NA, CI.Lower = NA, CI.Upper = NA)
#         ) %>%
#         arrange(desc(is.na(race_eth)), .by_group = TRUE)
#     }) %>%
#     bind_rows() %>%
#     select(-race_eth) %>%
#     mutate(` ` = paste(rep(" ", 20), collapse = " "),
#            `SMR (95%)` = case_when(
#              is.na(Observed) ~ "", 
#              Observed == "-" ~ "", 
#              TRUE ~ paste0(SMR, " (", CI.Lower, " - ", CI.Upper, ")")))
#   
#   return(result)
# }
# 
# white_f <- forest_format(
#   race_eth_select = "White", 
#   merged_dx_agegroup, 
#   merged_stage, 
#   merged_procedure, 
#   merged_g_deathyear, 
#   merged_g_diagnosisyear
# )
# 
# black_f <- forest_format(
#   race_eth_select = "Black",  
#   merged_dx_agegroup, 
#   merged_stage, 
#   merged_procedure, 
#   merged_g_deathyear, 
#   merged_g_diagnosisyear
# )
# 
# us_hispanic_f <- forest_format(
#   race_eth_select = "US Hispanic",  
#   merged_dx_agegroup, 
#   merged_stage, 
#   merged_procedure, 
#   merged_g_deathyear, 
#   merged_g_diagnosisyear
# )
# 
# pr_hispanic_f <- forest_format(
#   race_eth_select = "PR Hispanic",  
#   merged_dx_agegroup, 
#   merged_stage, 
#   merged_procedure, 
#   merged_g_deathyear, 
#   merged_g_diagnosisyear
# )
# aanhpi_f <- forest_format(
#   race_eth_select = "AANHPI & AIAN", 
#   merged_dx_agegroup, 
#   merged_stage, 
#   merged_procedure, 
#   merged_g_deathyear, 
#   merged_g_diagnosisyear
# )
# 
# pr_hispanic_forest <- forest(pr_hispanic_f %>% select(-c(Observed, Expected, SMR, CI.Lower, CI.Upper)),
#        est = as.numeric(pr_hispanic_f$SMR),
#        lower = as.numeric(pr_hispanic_f$CI.Lower), 
#        upper = as.numeric(pr_hispanic_f$CI.Upper),
#        xlim = c(0, 25),
#        ci_column = 2,
#        ref_line = 1,
#        xlab = "SMR",
#        ticks_at = pretty(c(0, 25), n = 5),
#        plot.margin=unit(c(-10,-10,-10,-10), "cm")); pr_hispanic_forest
# 
# us_hispanic_forest <- forest(us_hispanic_f %>% select(-c(Variable, Observed, Expected, SMR, CI.Lower, CI.Upper)),
#        est = as.numeric(us_hispanic_f$SMR),
#        lower = as.numeric(us_hispanic_f$CI.Lower), 
#        upper = as.numeric(us_hispanic_f$CI.Upper),
#        xlim = c(0, 25),
#        ci_column = 1,
#        ref_line = 1,
#        xlab = "SMR",
#        ticks_at = pretty(c(0, 25), n = 5),
#        plot.margin=unit(c(-10,-10,-10,-10), "cm")); us_hispanic_forest
# 
# white_forest <- forest(white_f %>% select(-c(Variable, Observed, Expected, SMR, CI.Lower, CI.Upper)),
#        est = as.numeric(white_f$SMR),
#        lower = as.numeric(white_f$CI.Lower), 
#        upper = as.numeric(white_f$CI.Upper),
#        xlim = c(0, 25),
#        ci_column = 1,
#        ref_line = 1,
#        xlab = "SMR",
#        ticks_at = pretty(c(0, 25), n = 5),
#        plot.margin=unit(c(-10,-10,-10,-10), "cm")); white_forest
# 
# black_forest <- forest(black_f %>% select(-c(Variable, Observed, Expected, SMR, CI.Lower, CI.Upper)),
#        est = as.numeric(black_f$SMR),
#        lower = as.numeric(black_f$CI.Lower), 
#        upper = as.numeric(black_f$CI.Upper),
#        xlim = c(0, 25),
#        ci_column = 1,
#        ref_line = 1,
#        xlab = "SMR",
#        ticks_at = pretty(c(0, 25), n = 5),
#        plot.margin=unit(c(-10,-10,-10,-10), "cm")); black_forest
# 
# aanhpi_forest <- forest(aanhpi_f %>% select(-c(Variable, Observed, Expected, SMR, CI.Lower, CI.Upper)),
#        est = as.numeric(aanhpi_f$SMR),
#        lower = as.numeric(aanhpi_f$CI.Lower), 
#        upper = as.numeric(aanhpi_f$CI.Upper),
#        xlim = c(0, 25),
#        ci_column = 1,
#        ref_line = 1,
#        xlab = "SMR",
#        ticks_at = pretty(c(0, 25), n = 5),
#        plot.background = element_rect(fill = "yellow"),
#        plot.margin=unit(c(-10,-10,-10,-10), "cm")); aanhpi_forest
# 
# forest_figure <- grid.arrange(pr_hispanic_forest, us_hispanic_forest, white_forest, black_forest, aanhpi_forest, ncol = 5, clip = "on")
# 
# # knitr::plot_crop("/Users/genesisrodriguez/Downloads/Statistical Analysis/Outputs/Figures/pr_hispanic_forest.png")
# 
# ggsave(file.path(base_path_cvd, "forest_figure.png"), plot = forest_figure, width = 30, height = 8, dpi = 400,  bg = NULL)
# 
# beepr::beep(1)

```

```{r hazard_ratios_lag_times}

# Define function to get HR table
get_hr_table <- function(data, lag_cutoff) {
  filtered_data <- data %>% filter(lagTime >= lag_cutoff)
  n <- nrow(filtered_data)
  
  if (n == 0) return(NULL)  # Skip empty subsets
  
  model <- coxph(Surv(FollowUpYears, status) ~ AgeDx + StageAtDx + Procedure + maritallabel, data = filtered_data)
  tidy_model <- broom::tidy(model, conf.int = TRUE, exponentiate = TRUE) %>%
    mutate(lag = paste0(lag_cutoff, "+ years (n = ", comma(n), ")")) %>%
    select(lag, term, estimate, conf.low, conf.high)
  
  return(tidy_model)
}

# Apply for all lag times and bind results
results <- purrr::map_dfr(c(3, 5, 7, 10), ~ get_hr_table(cancer_observed, .)) %>%
  mutate(term = dplyr::recode(term,
                       "AgeDx" = "Age at Diagnosis",
                       "StageAtDxRegional" = "Regional",
                       "StageAtDxDistant" = "Distant",
                       "StageAtDxUnknown/unstaged" = "Unknown/Unstaged",
                       "ProcedureChemotherapy Only" = "Chemotherapy Only",
                       "ProcedureRadiotherapy Only" = "Radiotherapy Only",
                       "ProcedureChemotherapy and Radiotherapy" = "Chemotherapy & Radiotherapy",
                       "ProcedureOther" = "Other Procedure",
                       "maritallabelUnmarried" = "Unmarried")) %>%
  mutate(across(c(estimate, conf.low, conf.high), ~ ifelse(is.infinite(.x) | .x == 0 | is.na(.x), NA, .x))) %>%
  mutate(across(c(estimate, conf.low, conf.high), round, 2)) %>%
  mutate(HR_CI = ifelse(is.na(estimate) | is.na(conf.low) | is.na(conf.high), "-", paste0(estimate, " (", conf.low, ", ", conf.high, ")"))) %>%
  select(Variable = term, lag, HR_CI) %>%
  pivot_wider(names_from = lag, values_from = HR_CI) %>%
  add_row(Variable = "Married", `3+ years (n = 9,706)` = "1.00", `5+ years (n = 6,292)` = "1.00",
          `7+ years (n = 4,157)` = "1.00",  `10+ years (n = 2,092)` = "1.00", .before = 9) %>%
  add_row(Variable = "Surgery Only", `3+ years (n = 9,706)` = "1.00", `5+ years (n = 6,292)` = "1.00",
          `7+ years (n = 4,157)` = "1.00",  `10+ years (n = 2,092)` = "1.00", .before = 5) %>%
  add_row(Variable = "Localized", `3+ years (n = 9,706)` = "1.00", `5+ years (n = 6,292)` = "1.00",
          `7+ years (n = 4,157)` = "1.00",  `10+ years (n = 2,092)` = "1.00", .before = 2)

# Create the gt table and format
hr_gt <- results %>%
  gt(rowname_col = "Variable") %>%
  tab_spanner(label = "Hazard Ratios (HR, 95% CI) by Survival Time", columns = starts_with(c("3", "5", "7", "10"))) %>%
  tab_row_group(label = "Stage at Diagnosis", rows = matches("Localized|Regional|Distant|Unknown")) %>%
  tab_row_group(label = "Initial Treatment", rows = matches("Surgery|Chemo|Radio|Other")) %>%
  tab_row_group(label = "Marital Status", rows = matches("Married|Unmarried")) %>%
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = everything())) %>%
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = everything())) %>%
  row_group_order(groups = c(NA, "Stage at Diagnosis", "Initial Treatment", "Marital Status"))

#print(hr_gt)

#gtsave(hr_gt, "/Users/genesisrodriguez/Downloads/Statistical Analysis/Outputs/Figures/hr_table.html")

```

```{r hr_graph}

# Reshape the data from wide to long format for plotting
results_long <- results %>%
  pivot_longer(cols = starts_with("3") | starts_with("5") | starts_with("7") | starts_with("10"),
               names_to = "Lag",
               values_to = "HR_CI") %>%
 mutate(
        HR = as.numeric(str_extract(HR_CI, "^[0-9.]+")),  # Extract HR before the first '('
        CI_Lower = as.numeric(str_extract(HR_CI, "(?<=\\()[0-9.]+(?=,)")),  # Extract lower CI between '(' and ','
        CI_Upper = as.numeric(str_extract(HR_CI, "(?<=, )[0-9.]+(?=\\))")),
        Variable = factor(Variable, levels = unique(Variable)),
        Lag = factor(Lag, levels = c("3+ years (n = 9,706)", "5+ years (n = 6,292)", "7+ years (n = 4,157)", "10+ years (n = 2,092)")))

# Now plot
f_hr <- ggplot(results_long, aes(x = HR, y = reorder(Variable, desc(Variable)), xmin = CI_Lower, xmax = CI_Upper)) +
  geom_vline(xintercept = 1, linetype = 2) +
  geom_errorbarh(height = 0.2, color = "black") + # CI as horizontal error bars
  geom_point(size = 1.5, color = "#FF3D2E") +  # HR as points
  labs(x = "Hazard Ratio (HR) and 95% CI", y = "Variable") +
  jacc_theme() +
 # scale_x_continuous(limits = c(-1, 20)) +  # Adjust limits for x-axis
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
    plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~Lag)

ggsave(file.path(base_path_cvd, "f_hr.png"), plot = f_hr, width = 8, height = 6.5, dpi = 500,  bg = "white")

```

```{r overall_smr_sens}

get_overall_smr <- function(data, lag_cutoff) {
  # Filter the data based on the lag cutoff
  filtered_data <- data %>% filter(lagTime >= lag_cutoff)
  n <- nrow(filtered_data)
  
  # Expand data to include required stratifications
  c <- lexpand(filtered_data,
               status = cvdStatus != 0, 
               birth = birth_date,
               entry = FollowUpStart, 
               exit = FollowUpEnd, 
               breaks = list(per = 2004:2022, 
                             age = c(0, 40, 50, 60, 70, 80, Inf)),
               aggre = list(agegroup = age, 
                            deathyear = per))  # Include all here
  
  # Call SMR calculation (no stratifier in this case)
  smr_result <- sir(
    coh.data = c,
    coh.obs = 'from0to1',
    coh.pyrs = 'pyrs',
    ref.data = gen_2,
    ref.rate = 'gen_cvd_rate',
    adjust = c('deathyear', 'agegroup'),
    test.type = "homogeneity",
    conf.type = "wald",
    conf.level = 0.95)
  
  # Add a label to track the lag time and number of participants
  smr_result <- smr_result %>%
    mutate(lag = paste0(lag_cutoff, "+ years (n = ", comma(n), ")"))
  
  return(smr_result)
}

# Apply the function for different lag_cutoff values
lag_cutoffs <- c(3, 5, 7, 10)

# Calculate SMR for all lag_cutoffs without stratification
smr_results_all <- purrr::map_dfr(lag_cutoffs, ~ get_overall_smr(data = cancer_observed, lag_cutoff = .x)) %>%
  mutate(lag = factor(lag, levels = c("3+ years (n = 9,706)", "5+ years (n = 6,292)", 
                                      "7+ years (n = 4,157)", "10+ years (n = 2,092)")))

# smr_long <- smr_results_all %>%
#   pivot_longer(
#     cols = c(AgeDxCat, Procedure, StageAtDx),
#     names_to = "Variable",
#     values_to = "Level",
#     values_drop_na = TRUE
#   ) %>%
#   select(Variable, Level, lag, observed, expected, pyrs, sir, sir.lo, sir.hi, p_value)

# SMR Overall Sensitivity Graph

f_smr_lag <- ggplot(data = smr_results_all, aes(x = lag, y = sir, fill = lag)) +
  geom_bar(stat = "identity", color = "royalblue4", width = 0.5) +  # Bar plot with black borders and custom width
  geom_errorbar(aes(ymin = sir.lo, ymax = sir.hi), width = 0.2, color = "black") +  # Add error bars
  geom_text(aes(label = sprintf("%.2f", sir)), vjust = -0.5, hjust = -0.6, size = 5) +  # Add SMR labels above bars
  xlab("Survival Time") +
  ylab("SMR") +
  scale_fill_manual(values = rep("#d9eaf7", length(unique(smr_agegroup$AgeDxCat)))) + 
  jacc_theme() +
  theme(text = element_text(size = 16),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(face = "bold", hjust = 0.5),
        legend.position = "none"); f_smr_lag

ggsave(file.path(base_path_cvd, "smr_pr_lag_graph.png"), plot = f_smr_lag, width = 8, height = 6, dpi = 500,  bg = "white")

```

```{r archived_pr_smr_plots}

# SMRs by year of death

# By year of death
# smr_deathyear <- sir(coh.data = c, coh.obs = 'from0to1', 
#                   coh.pyrs = 'pyrs', 
#                   ref.data = gen_2, 
#                   ref.rate = 'gen_cvd_rate', 
#                   adjust = c('deathyear', 'agegroup'), 
#                   test.type = "homogeneity",
#                   conf.type = "wald",
#                   conf.level = 0.95,
#                   print ='deathyear') %>%
#     mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
#     sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected))
# 
# f_prdeathyear <- ggplot(data = smr_deathyear[-1, ], aes(x = deathyear, y = sir)) +
#   geom_line(color = "royalblue4", size = 1.2) +  # Adjust line color and thickness
#   geom_point(size = 3, shape = 21, fill = "white", color = "royalblue4") +  # Add points with fill
#   geom_ribbon(aes(ymin = sir.lo, ymax = sir.hi), fill = "royalblue4", alpha = 0.1) +  # Confidence interval with fill color
#   geom_hline(yintercept = 1, color = "#FF3D2E", linetype = "dashed", size = 0.5) +  # #FF3D2E dashed line at SMR = 1
#   geom_text(aes(label = round(sir, 2)), nudge_y = 0.7, nudge_x = -0.1, size = 4, color = "black") +  # Add labels with a slight upward offset
#   xlab("Year of Death") +
#   ylab("SMR") +
#   scale_x_continuous(breaks = smr_deathyear$deathyear) +
#   scale_y_continuous(breaks = seq(1, ceiling(max(smr_deathyear[-1, ]$sir.hi, na.rm = TRUE)), by = 2), limits = c(0, NA)) +
#   theme(
#     axis.text.x = element_text(angle = 45, hjust = 1)) 

# SMRs by grouped year of death

# smr_deathYearCat <- smr_deathyear %>%
#   mutate(`Year of Death` = case_when(
#     deathyear >= 2005 & deathyear <= 2010 ~ "2005-2010",
#     deathyear >= 2011 & deathyear <= 2016 ~ "2011-2016",
#     deathyear >= 2017 & deathyear <= 2021 ~ "2017-2021"
#   )) %>%
#   group_by(`Year of Death`) %>%
#   summarise(
#     Observed = sum(observed),
#     Expected = sum(expected),
#     .groups = "drop"
#   ) %>%
#   mutate(SMR = Observed / Expected,
#          CI.Lower = ifelse(
#            Observed == 0, 0, 
#            qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected)
#          ),
#          CI.Upper =  ifelse(
#            Observed == 0, Inf, 
#            qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))
#          )
# 
# f_deathYearCat <- ggplot(data = smr_deathYearCat, aes(y = fct_rev(`Year of Death`), x = SMR, group = 1)) +
#   geom_errorbarh(aes(xmin = CI.Lower, xmax = CI.Upper), height = 0.2, color = "royalblue4") +  # Horizontal error bars
#   geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +  # Reference line at SMR = 1
#     geom_point(size = 4, color = "royalblue4") +
#   xlab("SMR") +
#   geom_text(aes(label = round(SMR, 2)), nudge_y = 0.1, size = 4, color = "black") +
#   scale_y_discrete(limits = rev(levels(smr_deathYearCat$`Year of Death`))) +
#   scale_x_continuous(
#   breaks = scales::pretty_breaks(n = 6), 
#   limits = c(.5, NA)) +
#   ylab("Year of Death") +
#   jacc_theme()

# f_ydiag2 <- ggplot(data = smr_ydiag, aes(x = `Year of Diagnosis`, y = `Standardized Mortality Ratio (SMR)`)) +
#   geom_errorbar(aes(ymin = `Lower 95% CI`, ymax = `Upper 95% CI`), 
#                 width = 0.2, color = "royalblue4") +
#   geom_point(size = 2, color = "royalblue4") +
#   geom_hline(yintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +  # Reference line at SMR = 1
#   ylab("SMR") +
#   xlab("Year of Diagnosis") +
#   scale_x_continuous(breaks = sort(unique(smr_ydiag$`Year of Diagnosis`))) +
#    scale_y_continuous(breaks = seq(1, max(smr_ydiag$`Upper 95% CI`, na.rm = TRUE), by = 2), limits = c(1, NA)) +
#   theme_bw(base_size = 14) +
#   theme(
#     axis.title = element_text(face = "bold"),
#     axis.text.x = element_text(face = "bold", angle = 45),
#     plot.title = element_text(face = "bold", hjust = 0.5)
#   )


# SMRs by grouped year of diagnosis

# smr_diagCat <- smr_ydiag %>%
#   mutate(`Year of Diagnosis` = case_when(
#     `Year of Diagnosis` >= 2004 & `Year of Diagnosis` <= 2009 ~ "2004-2009",
#     `Year of Diagnosis` >= 2010 & `Year of Diagnosis` <= 2014 ~ "2010-2014",
#     `Year of Diagnosis` >= 2015 & `Year of Diagnosis` <= 2019 ~ "2015-2019"
#   )) %>%
#   group_by(`Year of Diagnosis`) %>%
#   summarise(
#     Observed = sum(Observed),
#     Expected = sum(Expected),
#     .groups = "drop"
#   ) %>%
#   mutate(SMR = Observed / Expected,
#          CI.Lower = ifelse(
#            Observed == 0, 0, 
#            qchisq(0.05 / 2, df = 2 * Observed) / (2 * Expected)
#          ),
#          CI.Upper =  ifelse(
#            Observed == 0, Inf, 
#            qchisq(1 - 0.05 / 2, df = 2 * (Observed + 1)) / (2 * Expected))
#          ) %>%
#   mutate(across(c(Expected, SMR, CI.Lower, CI.Upper), ~ round(.x, 2)))


# f_ydiagcat <- ggplot(data = smr_diagCat, aes(x = `Year of Diagnosis`, y = SMR, group = 1)) +
#   geom_ribbon(aes(ymin = CI.Lower, ymax = CI.Upper), fill = "royalblue4", alpha = 0.2) +
#   geom_line(color = "royalblue4", size = 1) +
#   geom_point(size = 4, color = "royalblue4") +
#   scale_x_discrete(expand = expansion(add = c(0.05, 0.05))) +
#   geom_text(aes(label = round(SMR, 2)), nudge_y = 0.5, size = 4, color = "black") +
#   geom_hline(yintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +
#   xlab("Year of Diagnosis") +
#   ylab("SMR") +
#   jacc_theme() +
#   theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), text = element_text(family = "Times New Roman"))

# By comorbidity status

# smr_comorb <- sir(coh.data = c, coh.obs = 'from0to1',
#                 coh.pyrs = 'pyrs',
#                 ref.data = gen_2,
#                 ref.rate = 'gen_cvd_rate',
#                 adjust = c('deathyear', 'agegroup'),
#                 test.type = "homogeneity",
#                 conf.type = "wald",
#                 conf.level = 0.95,
#                 print ='Comorbidity') %>%
#     mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
#     sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected))
# 
# f_comorb <- ggplot(data = smr_comorb, aes(x = sir, y = fct_rev(Comorbidity))) +
#   geom_errorbarh(aes(xmin = sir.lo, xmax = sir.hi), height = 0.2, color = "royalblue4") +  # Horizontal error bars
#   geom_point(size = 4, color = "royalblue4") +  # Blue points for SMR
#   geom_vline(xintercept = 1, linetype = "dashed", color = "#FF3D2E", size = 0.5) +  # Reference line at SMR = 1
#   geom_text(aes(label = sprintf("%.2f", sir)), vjust = -0.8, size = 5) +  # Add SMR labels above bars
#   xlab("SMR") +
#   scale_y_discrete(name = "Number of comorbidities") +  # Discrete scale for y-axis
#   scale_x_continuous(breaks = seq(1, max(smr_comorb$sir.hi, na.rm = TRUE), by = 2), limits = c(1, NA)) +  # Breaks start at 1
#   theme_bw(base_size = 16) +
#   theme(
#     axis.title = element_text(face = "bold"),
#     axis.text.y = element_text(face = "bold"),  # Bold y-axis labels
#     plot.title = element_text(face = "bold", hjust = 0.5)
#   )
# 
# ggsave(file.path(base_path_cvd, "pr_comorb.png"), plot = f_comorb, width = 11, height = 6, dpi = 300,  bg = "white")

```

```{r sensitivity_analysis_smr_lag_times}

cancer_observed <- cancer_observed %>%
  mutate(AgeDxCatRecode = case_when(
    AgeDx < 65 ~ "<65",
    AgeDx >= 65 ~ "65+"
  ))

get_smr_table <- function(data, lag_cutoff, stratifier) {
  filtered_data <- data %>% filter(lagTime >= lag_cutoff)
  n <- nrow(filtered_data)
  
  c <- lexpand(filtered_data,
               status = cvdStatus != 0, 
               birth = birth_date,
               entry = FollowUpStart, 
               exit = FollowUpEnd, 
               breaks = list(per = 2004:2022, 
                             age = c(0, 40, 50, 60, 70, 80, Inf)),
               aggre = list(agegroup = age, 
                            deathyear = per, 
                            ydiag, 
                            AgeDxCatRecode, 
                            yearDiagCat, 
                            deathYearCat, 
                            Comorb.cat, 
                            Comorbidity, 
                            maritallabel, 
                            Procedure,
                            StageAtDx))  # Include all here
  
  smr_result <- sir(
    coh.data = c,
    coh.obs = 'from0to1',
    coh.pyrs = 'pyrs',
    ref.data = gen_2,
    ref.rate = 'gen_cvd_rate',
    adjust = c('deathyear', 'agegroup'),
    test.type = "homogeneity",
    conf.type = "univariate",
    conf.level = 0.95,
    print = stratifier  # <-- dynamic now
  ) %>%  
    mutate(sir.lo = qchisq(0.05 / 2, df = 2 * observed) / (2 * expected),
                sir.hi = qchisq(1 - 0.05 / 2, df = 2 * (observed + 1)) / (2 * expected))
  
  smr_result <- smr_result %>%
    mutate(lag = paste0(lag_cutoff, "+ years (n = ", comma(n), ")"),
           Stratifier = stratifier)  # track stratifier
  return(smr_result)
}

combo_grid <- expand_grid(
  lag_cutoff = c(3, 5, 7, 10),
  stratifier = c("AgeDxCatRecode", "Procedure", "StageAtDx"),
)

# Apply the function across all combinations
smr_results_all <- purrr::pmap_dfr(combo_grid, ~ get_smr_table(data = cancer_observed, lag_cutoff = ..1, stratifier = ..2))

smr_sensitivity <- smr_results_all %>%
  pivot_longer(
    cols = c(AgeDxCatRecode, Procedure, StageAtDx),
    names_to = "Variable",
    values_to = "Level",
    values_drop_na = TRUE) %>%
  mutate(
    Variable = factor(Variable, levels = unique(Variable)),
    Level = ifelse(Level == "Unknown/unstaged", "Unknown/ unstaged", Level),
    Level = case_when(
      Variable == "StageAtDx" ~ factor(Level, levels = c("Localized", "Regional", "Distant", "Unknown/ unstaged")),
      TRUE ~ as.factor(Level)),
    lag = factor(lag, levels = c("3+ years (n = 9,706)", "5+ years (n = 6,292)",
                                 "7+ years (n = 4,157)", "10+ years (n = 2,092)"))) %>%
  select(Variable, Level, lag, observed, expected, pyrs, sir, sir.lo, sir.hi, p_value) %>% group_by(lag) %>%
  mutate(sir = ifelse(observed < 10, NA, sir),
         sir.lo = ifelse(observed < 10, NA, sir.lo),
         sir.hi = ifelse(observed < 10, NA, sir.hi))

rm(smr_results_all)

f_pr_agedx_lag <- ggplot(data = smr_sensitivity[smr_sensitivity$Variable == "AgeDxCatRecode", ], aes(x = Level, y = sir, fill = Level)) +
  facet_wrap(~lag) +
  geom_bar(stat = "identity", color = "royalblue4", width = 0.5) +  # Bar plot with black borders and custom width
  geom_errorbar(aes(ymin = sir.lo, ymax = sir.hi), width = 0.2, color = "black") +  # Add error bars
  geom_text(aes(label = sprintf("%.2f", sir)), vjust = -0.5, hjust = -0.5, size = 3) +  # Add SMR labels above bars
  xlab("Age at Diagnosis") +
  ylab("SMR") +
  scale_fill_manual(values = rep("#d9eaf7", length(unique(smr_agegroup$AgeDxCat)))) + 
  jacc_theme() +
  theme(text = element_text(size = 16),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(hjust = 1),  # Rotate x-axis labels
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"  # Remove legend if not needed
  ); f_pr_agedx_lag

ggsave(file.path(base_path_cvd, "smr_agedx_lag_graph2.png"), plot = f_pr_agedx_lag, width = 8, height = 6.5, dpi = 500,  bg = "white")

f_pr_treatment_lag <- ggplot(
  data = smr_sensitivity[smr_sensitivity$Variable == "Procedure", ],
  aes(x = reorder(str_wrap(Level, width = 10), desc(str_wrap(Level, width = 10))), y = sir, fill = Level)) +
  facet_wrap(~lag) +
  geom_bar(stat = "identity", color = "royalblue4", width = 0.5) +
  geom_errorbar(aes(ymin = sir.lo, ymax = sir.hi), width = 0.2, color = "black") +
  geom_text(aes(label = sprintf("%.2f", sir)), vjust = -0.5, nudge_x = .2, size = 3) +
  xlab("Initial Treatment") +
  ylab("SMR") +
  scale_fill_manual(values = rep("#d9eaf7", length(unique(smr_agegroup$AgeDxCat)))) +
  coord_cartesian(clip = "off") +
  jacc_theme() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 7),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none",
    plot.margin = margin(t = 10, r = 10, b = 30, l = 10)
  ); f_pr_treatment_lag

ggsave(file.path(base_path_cvd, "smr_treatment_lag_graph.png"), plot = f_pr_treatment_lag, width = 8, height = 6.5, dpi = 500,  bg = "white")


lag_stage <- smr_sensitivity %>%
  filter(Variable == "StageAtDx",
         Level != "Unknown/ unstaged") %>%
  mutate(Level = factor(str_wrap(Level, width = 12), 
                           levels = str_wrap(c("Localized", "Regional", "Distant"), width = 12)))

f_pr_stagedx_lag <- ggplot(
  data = lag_stage %>%
    filter(Variable == "StageAtDx" & !(Level == "Distant" & lag == "10+ years (n = 2,092)")),
  aes(x = Level, y = sir, fill = Level)) +
  facet_wrap(~lag) +
  geom_bar(stat = "identity", color = "royalblue4", width = 0.5) +
  geom_errorbar(aes(ymin = sir.lo, ymax = sir.hi), width = 0.2, color = "black") +
  geom_text(aes(label = sprintf("%.2f", sir)), vjust = -0.5, hjust = -0.5, size = 3) +
   labs(
        x = "Stage at Diagnosis",
        y = "SMR",
        caption = "There were 10 distant stage CVD deaths for the whole period.") +
  scale_fill_manual(values = rep("#d9eaf7", 4)) +
  jacc_theme() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(face = "bold"),
    axis.text.x = element_text(size = 7),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none"); f_pr_stagedx_lag


ggsave(file.path(base_path_cvd, "smr_stage_lag_graph.png"), plot = f_pr_stagedx_lag, width = 8, height = 6.5, dpi = 500,  bg = "white")

```

```{r p_heterogeneity}


stratify_by <- "age_group"

data_clean <- merged_dx_agegroup %>%
  filter(Observed != "<10") %>%
  mutate(observed_deaths = as.numeric(Observed),
         expected_deaths = as.numeric(gsub("[^0-9.]", "", Expected)),
         race_ethnicity = factor(race_eth),
         age_group = factor(`Age at Diagnosis`)) %>%
  filter(!is.na(observed_deaths) & !is.na(expected_deaths))

{results <- data.frame()
for(s in unique(data_clean[[stratify_by]])) {
  d <- data_clean %>% filter(.data[[stratify_by]] == s)
  p <- anova(glm(observed_deaths ~ 1 + offset(log(expected_deaths)), family = poisson, data = d),
             glm(observed_deaths ~ race_ethnicity + offset(log(expected_deaths)), family = poisson, data = d),
             test = "LRT")$`Pr(>Chi)`[2]
  results <- rbind(results, data.frame(Stratum = s, P_heterogeneity = ifelse(p < 0.001, "< 0.001", sprintf("%.2f", p))))
}
  

print(results)
}

```

